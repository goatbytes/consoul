{
  "created_at": "2025-11-08T16:23:25.386922",
  "updated_at": "2025-11-11T04:27:46.253255Z",
  "id": "SOUL-17",
  "uuid": "6d728a4e-7f44-4d2b-8344-37fcb2158633",
  "title": "Implement YAML config loader with precedence",
  "description": "# Implement YAML Config Loader with Precedence\n\n## User Story\n**As a** developer\n**I want** YAML configuration files with clear precedence rules\n**So that** I can configure Consoul globally, per-project, and override via CLI without conflicts\n\n## Description\nImplement a robust YAML configuration loader that finds, loads, and merges configuration from multiple sources with well-defined precedence: defaults \u2192 global config \u2192 project config \u2192 environment variables \u2192 CLI arguments.\n\n## Technical Notes\n\n### Config File Locations\n\n1. **Global Config**: `~/.consoul/config.yaml`\n2. **Project Config**: `.consoul/config.yaml` (in git root or cwd)\n3. Search strategy: Start from cwd, walk up to find `.git/` or `.consoul/`\n\n### Precedence Order (Lowest to Highest)\n\n1. **Defaults** - Hardcoded in models\n2. **Global Config** - `~/.consoul/config.yaml`\n3. **Project Config** - `.consoul/config.yaml`\n4. **Environment Variables** - `CONSOUL_*` prefix\n5. **CLI Arguments** - `--model`, `--temperature`, etc.\n\n### File: `consoul/config/loader.py`\n\n**Key Functions:**\n\n```python\ndef find_config_files() -> Tuple[Optional[Path], Optional[Path]]:\n    \"\"\"Find global and project config files.\"\"\"\n    # Return (global_config_path, project_config_path)\n\ndef load_yaml_config(path: Path) -> dict:\n    \"\"\"Load and parse YAML config file.\"\"\"\n    # Handle missing files gracefully\n    # Validate YAML structure\n    # Return empty dict if file doesn't exist\n\ndef merge_configs(*configs: dict) -> dict:\n    \"\"\"Deep merge multiple config dictionaries.\"\"\"\n    # Later configs override earlier ones\n    # Lists are replaced, not merged\n    # Dicts are deep-merged\n\ndef load_config() -> ConsoulConfig:\n    \"\"\"Load and merge all config sources.\"\"\"\n    # 1. Find config files\n    # 2. Load each config\n    # 3. Merge in precedence order\n    # 4. Validate with Pydantic\n    # 5. Return ConsoulConfig instance\n```\n\n### Error Handling\n\n- **Missing Config**: Not an error, use defaults\n- **Invalid YAML**: Clear error message with file path\n- **Invalid Schema**: Pydantic ValidationError with field details\n- **Missing API Keys**: Warn during load, error on first use\n\n### YAML Schema Example\n\n```yaml\n# ~/.consoul/config.yaml\nprofiles:\n  default:\n    model:\n      provider: anthropic\n      model: claude-3-5-sonnet-20241022\n      temperature: 1.0\n      max_tokens: 4096\n    conversation:\n      save_history: true\n      history_file: ~/.consoul/history.json\n    context:\n      max_context_tokens: 4096\n      include_system_info: true\n\n  code-review:\n    model:\n      provider: anthropic\n      model: claude-3-5-sonnet-20241022\n      temperature: 0.3\n      max_tokens: 8192\n\nactive_profile: default\n```\n\n## Acceptance Criteria\n\n**Given** no config files exist\n**When** loading configuration\n**Then** use built-in defaults without errors\n\n**Given** a global config at `~/.consoul/config.yaml`\n**When** loading configuration\n**Then** global config overrides defaults\n\n**Given** both global and project configs exist\n**When** loading configuration\n**Then** project config overrides global config for conflicting values\n\n**Given** invalid YAML syntax in config file\n**When** loading configuration\n**Then** raise clear error with file path and line number\n\n**Given** config with unknown fields\n**When** loading configuration\n**Then** Pydantic validation catches and reports unknown fields\n\n**Given** CLI argument `--model claude-3-opus-20240229`\n**When** loading configuration\n**Then** CLI value overrides all config files (handled in CLI layer)\n\n## Testing Considerations\n\n- Unit tests for YAML parsing\n- Test config file discovery (mock filesystem)\n- Test merge logic with nested dictionaries\n- Test precedence order with all combinations\n- Test error handling for invalid YAML\n- Test error handling for invalid schemas\n- Integration tests with real config files\n\n## Implementation Hints\n\n1. Use `PyYAML` or `ruamel.yaml` for YAML parsing\n2. Implement deep merge carefully (dicts merge, lists replace)\n3. Use `pathlib.Path` for all file operations\n4. Walk up directory tree to find `.git/` or `.consoul/`\n5. Cache loaded configs to avoid repeated I/O\n6. Validate with Pydantic after merging all sources\n7. Consider using `pydantic.TypeAdapter` for partial validation\n\n## Files to Create/Modify\n\n- `consoul/config/loader.py` - Config loading logic\n- `consoul/config/utils.py` - Helper functions (merge, find)\n- `tests/config/test_loader.py` - Loader tests\n- `tests/fixtures/configs/` - Test config files\n\n## Dependencies\n\n- `PyYAML>=6.0` or `ruamel.yaml>=0.18`\n- `pydantic>=2.0`\n\n## References\n\n- [PyYAML Documentation](https://pyyaml.org/wiki/PyYAMLDocumentation)\n- [ruamel.yaml Documentation](https://yaml.readthedocs.io/)\n- [Config Precedence Best Practices](https://12factor.net/config)",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "config",
    "enhancement",
    "yaml"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-002",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-08T16:56:47.158640",
      "updated_at": "2025-11-08T16:56:47.158641",
      "id": "20251108165647-82f97d9e",
      "ticket_id": "SOUL-17",
      "author": "jared@goatbytes.io",
      "content": "Implemented comprehensive YAML configuration loader with precedence system.\n\n**Implementation:**\n\nCreated `consoul/config/loader.py` with complete config loading functionality:\n\n**Core Functions:**\n\n1. **find_config_files()** - Locates global and project config files\n   - Global: ~/.consoul/config.yaml\n   - Project: Walks up from cwd to find .consoul/config.yaml or .git/\n\n2. **find_project_config()** - Searches upward for project-specific config\n   - Stops at .git directory (repository root)\n   - Returns None if not found\n\n3. **load_yaml_config()** - Loads and parses YAML files\n   - Gracefully handles missing files (returns empty dict)\n   - Clear error messages for invalid YAML syntax\n   - Validates file contains dictionary\n\n4. **deep_merge()** - Deep merges configuration dictionaries\n   - Recursively merges nested dicts\n   - Lists are replaced (not merged)\n   - Later configs override earlier ones\n\n5. **merge_configs()** - Merges multiple configs in precedence order\n   - Skips None/empty configs\n   - Preserves order from lowest to highest precedence\n\n6. **create_default_config()** - Provides sensible defaults\n   - Default profile with Anthropic Claude 3.5 Sonnet\n   - Conversation history enabled\n   - Context includes system/git info\n\n7. **load_config()** - Main entry point\n   - Implements full precedence chain:\n     1. Defaults (hardcoded)\n     2. Global config (~/.consoul/config.yaml)\n     3. Project config (.consoul/config.yaml)\n     4. CLI overrides (passed as parameter)\n   - Validates merged config with Pydantic\n   - Returns ConsoulConfig instance\n\n8. **save_config()** - Saves config to YAML file\n   - Creates parent directories automatically\n   - Excludes API keys from output (security)\n   - Pretty-formatted YAML output\n\n**Testing:**\n- 32 comprehensive unit tests\n- 80.36% code coverage on loader.py\n- Tests for all functions and error cases\n- Integration tests with real YAML files\n- Mock filesystem tests for config discovery\n\n**Test Coverage:**\n- Deep merge logic (nested dicts, lists, types)\n- Config file discovery (current dir, parent, git root)\n- YAML parsing (valid, invalid, empty, non-dict)\n- Precedence order (defaults < global < project < CLI)\n- Validation errors (invalid provider, schema)\n- Multiple profiles\n- API key exclusion from saved files\n\n**Dependencies:**\n- Added PyYAML ^6.0.3 to dependencies\n\n**Files Created:**\n- src/consoul/config/loader.py (80 statements)\n- tests/config/test_loader.py (32 tests)\n- Updated src/consoul/config/__init__.py (exports)\n\n**Integration:**\n- All 63 config tests pass (models + loader)\n- 85.83% overall config module coverage\n- Ready for SOUL-18 (profile system) and SOUL-19 (env vars)",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "story_points": 8,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-11-14T23:28:32.429233",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}