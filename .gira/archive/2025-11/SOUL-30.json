{
  "created_at": "2025-11-09T13:47:50.992618",
  "updated_at": "2025-11-11T04:27:46.232073Z",
  "id": "SOUL-30",
  "uuid": "f26a81c6-b436-4576-b041-74e47e3c76b0",
  "title": "Add Datasette integration for conversation browsing",
  "description": "**As a** Consoul power user\n**I want** a web UI to browse and explore conversation history\n**So that** I can analyze patterns, review conversations visually, and share insights\n\n**Context:**\nDatasette (by Simon Willison) provides instant web UI for SQLite databases with zero configuration. aider PR #1860 added Datasette integration for browsing chat history with faceting, filtering, and SQL queries.\n\nBenefits:\n- Zero-config web UI for SQLite database\n- Interactive filtering, sorting, searching\n- SQL query interface for advanced analysis\n- JSON/CSV export capabilities\n- Shareable read-only views\n- Plugin ecosystem for visualizations\n\n**Technical Notes:**\n- **Dependencies**: Add `datasette` as optional dependency (extras)\n- **Integration**: Launch datasette server pointing to history.db\n- **CLI command**: `consoul history browse` or `consoul datasette`\n- **Port**: Default 8001, configurable\n- **Access**: localhost only by default (security)\n- **Metadata**: Custom datasette metadata.json for better UI\n\n**Acceptance Criteria:**\n\n**Given** I have conversation history in SQLite\n**When** I run `consoul history browse`\n**Then** Datasette web UI opens at http://localhost:8001\n\n**Given** Datasette is running\n**When** I navigate to conversations table\n**Then** I see filterable list with facets (model, date, message_count)\n\n**Given** I want to query conversations\n**When** I use Datasette SQL interface\n**Then** I can run custom queries across history\n\n**Given** I want to export data\n**When** I click export in Datasette\n**Then** I can download as JSON, CSV, or other formats\n\n**Given** datasette is not installed\n**When** I run `consoul history browse`\n**Then** I get helpful message: \"Install datasette: pip install consoul[datasette]\"\n\n**Given** I want to stop the server\n**When** I press Ctrl+C\n**Then** Datasette shuts down gracefully\n\n**Testing Considerations:**\n- Test Datasette launch with valid database\n- Test with empty database (no conversations)\n- Test port conflict handling (port already in use)\n- Verify read-only mode (no DB writes via Datasette)\n- Test custom metadata loading\n- Mock datasette for unit tests\n- Integration test requires optional datasette dependency\n\n**Implementation Hints:**\n\n```python\n# src/consoul/cli/history.py\nimport subprocess\nimport sys\nfrom pathlib import Path\n\ndef browse_history(\n    db_path: Path = Path(\"~/.consoul/history.db\"),\n    port: int = 8001,\n    open_browser: bool = True\n):\n    \"\"\"Launch Datasette to browse conversation history.\"\"\"\n    \n    db_path = db_path.expanduser()\n    \n    if not db_path.exists():\n        console.print(\"[red]No conversation history found.[/red]\")\n        console.print(f\"Database path: {db_path}\")\n        return\n    \n    # Check if datasette is installed\n    try:\n        import datasette\n    except ImportError:\n        console.print(\"[yellow]Datasette not installed.[/yellow]\")\n        console.print(\"Install with: [cyan]pip install consoul[datasette][/cyan]\")\n        console.print(\"Or: [cyan]pip install datasette[/cyan]\")\n        return\n    \n    # Create custom metadata\n    metadata = {\n        \"title\": \"Consoul Conversation History\",\n        \"description\": \"Browse and search your AI conversation history\",\n        \"databases\": {\n            \"history\": {\n                \"tables\": {\n                    \"conversations\": {\n                        \"label_column\": \"session_id\",\n                        \"facets\": [\"model\"],\n                        \"sort_desc\": \"updated_at\"\n                    },\n                    \"messages\": {\n                        \"facets\": [\"role\", \"conversation_id\"],\n                        \"sort_desc\": \"timestamp\"\n                    }\n                }\n            }\n        }\n    }\n    \n    # Write metadata to temp file\n    import json\n    import tempfile\n    \n    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:\n        json.dump(metadata, f)\n        metadata_path = f.name\n    \n    console.print(f\"[green]Starting Datasette on port {port}...[/green]\")\n    console.print(f\"[cyan]http://localhost:{port}[/cyan]\")\n    console.print(\"Press Ctrl+C to stop\")\n    \n    try:\n        # Launch datasette\n        cmd = [\n            sys.executable,\n            \"-m\",\n            \"datasette\",\n            str(db_path),\n            \"--port\",\n            str(port),\n            \"--metadata\",\n            metadata_path,\n            \"--immutable\",  # Read-only mode\n        ]\n        \n        if open_browser:\n            cmd.append(\"--open\")\n        \n        subprocess.run(cmd)\n    \n    except KeyboardInterrupt:\n        console.print(\"\\\\n[yellow]Datasette stopped[/yellow]\")\n    finally:\n        # Cleanup temp metadata\n        Path(metadata_path).unlink(missing_ok=True)\n\n# CLI command\n@click.command()\n@click.option(\"--port\", default=8001, help=\"Port to run Datasette on\")\n@click.option(\"--no-browser\", is_flag=True, help=\"Don't open browser automatically\")\ndef browse(port: int, no_browser: bool):\n    \"\"\"Browse conversation history in Datasette web UI.\"\"\"\n    from consoul.cli.history import browse_history\n    browse_history(port=port, open_browser=not no_browser)\n```\n\n**CLI Commands:**\n\n```bash\n# Launch Datasette (opens browser)\nconsoul history browse\n\n# Custom port\nconsoul history browse --port 9000\n\n# Don't auto-open browser\nconsoul history browse --no-browser\n\n# Alternative command name\nconsoul datasette\n```\n\n**Datasette Features Available:**\n\n1. **Faceted Browsing**: Filter by model, date, role\n2. **Full-Text Search**: Uses SQLite FTS5 (from SOUL-29)\n3. **SQL Queries**: Custom analysis queries\n4. **Export**: JSON, CSV download\n5. **Sharing**: Generate shareable read-only URLs (optional)\n6. **Plugins**: extensible with datasette plugins\n\n**Example SQL Queries in Datasette:**\n\n```sql\n-- Most active days\nSELECT \n    DATE(timestamp) as date,\n    COUNT(*) as message_count\nFROM messages\nGROUP BY date\nORDER BY message_count DESC;\n\n-- Token usage by model\nSELECT \n    c.model,\n    COUNT(m.id) as messages,\n    SUM(m.tokens) as total_tokens\nFROM conversations c\nJOIN messages m ON c.session_id = m.conversation_id\nGROUP BY c.model;\n\n-- Average conversation length\nSELECT \n    model,\n    AVG(message_count) as avg_messages\nFROM (\n    SELECT \n        c.model,\n        COUNT(m.id) as message_count\n    FROM conversations c\n    LEFT JOIN messages m ON c.session_id = m.conversation_id\n    GROUP BY c.session_id\n)\nGROUP BY model;\n```\n\n**Dependencies:**\n\n```toml\n# pyproject.toml\n[project.optional-dependencies]\ndatasette = [\n    \"datasette>=0.64.0\",\n]\n```\n\n**Configuration:**\n\n```yaml\n# ~/.config/consoul/config.yaml\ndatasette:\n  enabled: true\n  port: 8001\n  auto_browser: true\n  plugins: []  # Optional datasette plugins\n```\n\n**Security Considerations:**\n- Datasette runs on localhost only (not exposed to network)\n- Read-only mode (`--immutable` flag prevents DB writes)\n- No authentication needed for localhost\n- For remote access, users must configure firewall/SSH tunneling manually\n\n**Dependencies:**\n- SOUL-27 (SQLite persistence - required)\n- SOUL-29 (FTS search - enhances Datasette search)\n\n**Future Enhancements:**\n- Custom Datasette plugins for conversation visualization\n- Export conversations directly from Datasette UI\n- Diff view between conversation versions\n- Conversation analytics dashboard",
  "status": "done",
  "type": "feature",
  "priority": "low",
  "labels": [
    "datasette",
    "visualization",
    "history",
    "ux-improvement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-002",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-09T15:47:08.069562",
      "updated_at": "2025-11-09T15:47:08.069563",
      "id": "20251109154708-74ac502f",
      "ticket_id": "SOUL-30",
      "author": "jared@goatbytes.io",
      "content": "\u274c Not Implementing - TUI Makes This Redundant\n\nAfter discussion, decided not to implement Datasette integration.\n\n## Rationale\n\n**Redundant with TUI:**\nSince Consoul will have a native TUI for conversation browsing, adding Datasette would create a third interface (CLI + TUI + Web) for the same functionality. This adds complexity without sufficient value.\n\n**TUI Can Cover Use Cases:**\n- Conversation browsing and filtering\n- Search (using FTS5 from SOUL-29)\n- Export functionality\n- Better terminal integration than opening browser\n\n**Power Users Have Options:**\nUsers who need SQL analytics can use Datasette directly:\n```bash\ndatasette ~/.consoul/history.db\nsqlite3 ~/.consoul/history.db \"SELECT ...\"\n```\n\n**Scope Management:**\nFocus on core TUI features first. Datasette integration can be revisited post-1.0 if users specifically request web-based browsing or advanced SQL analytics.\n\n## Decision\nWon't implement. Closing as done (decided against).",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "story_points": 3,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-11-14T23:28:31.950073",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}