{
  "created_at": "2025-11-10T19:44:58.056717",
  "updated_at": "2025-11-11T05:51:13.148547Z",
  "id": "SOUL-58",
  "uuid": "e4eedff7-ae6c-4729-a1de-ae1365f5c9c0",
  "title": "Create tool registry and configuration system",
  "description": "**As a** Consoul developer\n**I want** a centralized tool registry with configuration management\n**So that** tools can be registered, configured, and controlled with security policies\n\n**Context:**\nLangChain's tool calling requires tools to be defined with schemas and bound to chat models via `bind_tools()`. We need a registry system that:\n- Manages available tools and their schemas\n- Enforces security policies (whitelists/blacklists)\n- Provides configuration for tool-specific settings\n- Integrates with existing Pydantic config system\n\nResearch shows aider uses command approval flows, and LangChain provides @tool decorator for tool creation with automatic schema generation from type hints.\n\n**Technical Notes:**\n- Create src/consoul/ai/tools/ module structure\n- Add ToolConfig to src/consoul/config/models.py\n- Use LangChain's @tool decorator for tool definitions\n- Implement ToolRegistry class to manage tool lifecycle\n- Add tool configuration to TuiConfig and ConsoulConfig\n- Support tool.bind_tools() pattern for model integration\n- Reference: https://python.langchain.com/docs/concepts/tool_calling/\n\n**Acceptance Criteria:**\n\n**Given** I have a Consoul configuration\n**When** I define tool settings in config.yaml\n**Then** tools are loaded with specified security policies\n\n**Given** a tool is registered in the registry\n**When** I query available tools\n**Then** I can see tool name, description, and configuration\n\n**Given** I configure blocked commands for bash tool\n**When** the AI requests a blocked command\n**Then** the tool is rejected before showing approval modal\n\n**Given** tool calling is disabled in configuration\n**When** AI model returns tool calls\n**Then** tools are not executed and user sees informational message\n\n**Testing Considerations:**\n- Unit test tool registry CRUD operations\n- Test configuration validation with Pydantic\n- Test security policy enforcement (whitelist/blacklist)\n- Test tool schema generation from decorators\n- Mock LangChain tool binding\n\n**Implementation Hints:**\n- Create ToolConfig Pydantic model:\n  ```python\n  class ToolConfig(BaseModel):\n      enabled: bool = True\n      auto_approve: bool = False  # Never default to True!\n      allowed_tools: list[str] = []  # empty = all (with approval)\n      approval_mode: Literal['always', 'once_per_session', 'whitelist'] = 'always'\n  ```\n- Create ToolRegistry singleton:\n  ```python\n  from langchain.tools import tool\n  \n  class ToolRegistry:\n      def register(self, tool_instance): ...\n      def get_tool(self, name): ...\n      def bind_to_model(self, model, tool_names): ...\n  ```\n- Add to src/consoul/config/models.py:\n  ```python\n  class TuiConfig(BaseModel):\n      tools: ToolConfig = Field(default_factory=ToolConfig)\n  ```\n\n**Files to Create:**\n- src/consoul/ai/tools/__init__.py\n- src/consoul/ai/tools/registry.py\n- src/consoul/ai/tools/base.py\n\n**Files to Modify:**\n- src/consoul/config/models.py\n- src/consoul/tui/config.py\n\nStory Points: 5",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "ai",
    "config",
    "tools",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-004",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-10T20:08:15.198085",
      "updated_at": "2025-11-10T20:08:15.198086",
      "id": "20251110200815-e71a6ea1",
      "ticket_id": "SOUL-58",
      "author": "jared@goatbytes.io",
      "content": "**ARCHITECTURE UPDATE - SDK-First Design**\n\nPer Codex review: Tool configuration must live in **ConsoulConfig** (not TuiConfig) to support SDK integration where Consoul is embedded without TUI.\n\n**Key Changes:**\n1. **Move tool config to src/consoul/config/models.py**\n   - ToolConfig belongs in ConsoulConfig.tools\n   - Not in TuiConfig (UI-specific settings only)\n   \n2. **No UI dependencies in core tool code**\n   - src/consoul/ai/tools/ must NOT import from tui/\n   - Tool registry, execution, validation = UI-agnostic\n   \n3. **Configuration precedence**\n   - Profile-level tool overrides (per-profile tool policies)\n   - Global tool defaults\n   - CLI/env variable overrides\n   \n4. **SDK contract**\n   - Host apps must be able to:\n     - Load tool config without TUI\n     - Override tool policies via ConsoulConfig\n     - Register tools without UI imports\n\n**Implementation Notes:**\n```python\n# In src/consoul/config/models.py\nclass ToolConfig(BaseModel):\n    enabled: bool = True\n    auto_approve: bool = False  # Never True!\n    allowed_tools: list[str] = []\n    approval_mode: Literal['always', 'once_per_session', 'whitelist'] = 'always'\n    bash: BashToolConfig = Field(default_factory=BashToolConfig)\n\nclass ConsoulConfig(BaseModel):\n    # ... existing fields ...\n    tools: ToolConfig = Field(default_factory=ToolConfig)\n```\n\n**Testing Requirements:**\n- Verify ConsoulConfig can be instantiated without tui module\n- Test tool config loading in headless/CLI mode\n- Ensure no circular imports (config \u2192 tools \u2192 config)\n\nThis ensures Gira and other host applications can use Consoul's tool system without TUI dependencies.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-11-14T23:28:30.291453",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}