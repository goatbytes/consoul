{
  "created_at": "2025-11-10T19:45:32.743539",
  "updated_at": "2025-11-11T05:26:41.260038Z",
  "id": "SOUL-59",
  "uuid": "9ee50314-394b-489d-b339-bed502ded1fa",
  "title": "Create tool approval modal widget",
  "description": "**As a** Consoul user\n**I want** a clear approval modal before any tool executes\n**So that** I can review and approve/deny tool calls with full visibility\n\n**Context:**\nSecurity best practice requires human-in-the-loop for all tool executions. Similar to aider's 'Run shell command? (Y)es/(N)o' prompt, we need a Textual modal that:\n- Shows tool name and full arguments\n- Displays risk level (safe, caution, dangerous)\n- Provides Approve/Deny buttons\n- Shows command preview with syntax highlighting\n- Supports keyboard shortcuts (Y/N, Enter/Esc)\n\nResearch shows OpenAI recommends user confirmation for actions with real-world impact, and Claude's tool use documentation emphasizes user review before execution.\n\n**Technical Notes:**\n- Extend Textual ModalScreen pattern (like SettingsScreen, HelpModal)\n- Similar to src/consoul/tui/widgets/help_modal.py pattern\n- Create ToolApprovalModal in src/consoul/tui/widgets/tool_approval_modal.py\n- Use color coding for risk levels (green/yellow/red borders)\n- Support async approval flow with callback\n- Add keyboard bindings (y/n for approve/deny, esc for deny)\n- Show command in code block with syntax highlighting\n\n**Acceptance Criteria:**\n\n**Given** AI requests a bash tool call\n**When** tool approval modal appears\n**Then** I see tool name, command, arguments, and risk level\n\n**Given** approval modal is shown\n**When** I press 'Y' or click Approve\n**Then** modal closes and returns approval=True\n\n**Given** approval modal is shown\n**When** I press 'N', Esc, or click Deny\n**Then** modal closes and returns approval=False\n\n**Given** a dangerous command is requested (rm -rf, sudo)\n**When** approval modal appears\n**Then** risk indicator shows 'DANGEROUS' in red\n\n**Given** approval modal displays a long command\n**When** command exceeds visible area\n**Then** scrollable code block shows full command\n\n**Testing Considerations:**\n- Unit test modal composition\n- Test keyboard bindings (Y, N, Esc, Enter)\n- Test risk level color coding\n- Test long command scrolling\n- Integration test with tool execution flow\n- Textual pilot testing for UI interactions\n\n**Implementation Hints:**\n- Modal structure:\n  ```python\n  class ToolApprovalModal(ModalScreen[bool]):\n      def __init__(self, tool_name: str, arguments: dict, risk_level: RiskLevel):\n          self.tool_name = tool_name\n          self.arguments = arguments\n          self.risk_level = risk_level\n      \n      def compose(self) -> ComposeResult:\n          with Container():\n              yield Label(f'Tool Request: {self.tool_name}')\n              yield Static(self._format_command(), classes='code-block')\n              yield RiskIndicator(self.risk_level)\n              with Horizontal():\n                  yield Button('Approve (Y)', variant='success', id='approve')\n                  yield Button('Deny (N)', variant='error', id='deny')\n  ```\n- Risk levels:\n  ```python\n  class RiskLevel(Enum):\n      SAFE = 'safe'        # ls, pwd, echo\n      CAUTION = 'caution'  # cat, grep, find\n      DANGEROUS = 'dangerous'  # rm, sudo, chmod\n  ```\n- Color scheme:\n  ```css\n  ToolApprovalModal.safe { border: thick ; }\n  ToolApprovalModal.caution { border: thick ; }\n  ToolApprovalModal.dangerous { border: thick ; }\n  ```\n\n**Files to Create:**\n- src/consoul/tui/widgets/tool_approval_modal.py\n\n**Files to Modify:**\n- src/consoul/tui/widgets/__init__.py\n- src/consoul/tui/css/main.tcss (add tool approval styles)\n\nStory Points: 5",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "tui",
    "security",
    "ux-improvement",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-004",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-10T20:08:33.788675",
      "updated_at": "2025-11-10T20:08:33.788676",
      "id": "20251110200833-8967093c",
      "ticket_id": "SOUL-59",
      "author": "jared@goatbytes.io",
      "content": "**SCOPE CLARIFICATION - TUI Layer Only**\n\nThis ticket implements the **Textual TUI approval UI** that sits on top of the headless approval API from SOUL-66.\n\n**Architecture:**\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Host App (Gira, CLI, etc.)          \u2502\n\u2502   - Custom ApprovalProvider         \u2502\n\u2502   - Or use CliApprovalProvider      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Core Approval API (SOUL-66)         \u2502\n\u2502   - ApprovalProvider protocol       \u2502\n\u2502   - ToolApprovalRequest/Response    \u2502\n\u2502   - SDK-ready, UI-agnostic          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502 (optional)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 TUI Approval Modal (THIS TICKET)   \u2502\n\u2502   - TuiApprovalProvider             \u2502\n\u2502   - ToolApprovalModal widget        \u2502\n\u2502   - Textual-specific UI             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n**Key Changes:**\n1. **Depends on SOUL-66** - Core approval API must exist first\n2. **Implements ApprovalProvider** - TuiApprovalProvider wraps modal\n3. **Optional dependency** - SDK users can skip TUI entirely\n4. **No business logic** - Only UI presentation, approval logic in SOUL-66\n\n**Implementation:**\n```python\n# src/consoul/tui/tools/approval.py\nfrom consoul.ai.tools.approval import ApprovalProvider, ToolApprovalRequest\n\nclass TuiApprovalProvider(ApprovalProvider):\n    def __init__(self, app: ConsoulApp):\n        self.app = app\n    \n    async def request_approval(\n        self, request: ToolApprovalRequest\n    ) -> ToolApprovalResponse:\n        # Show modal, return response\n        return await self.app.push_screen(\n            ToolApprovalModal(request)\n        )\n```\n\n**Testing:**\n- Ensure this module is importable only when TUI deps installed\n- Test that SDK can work without importing this module\n- Integration test: TuiApprovalProvider + ToolApprovalModal\n\n**Blocks:** This ticket now depends on SOUL-66 completing first.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-11-14T23:28:32.068812",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}