{
  "created_at": "2025-11-10T19:47:14.340656",
  "updated_at": "2025-11-11T07:21:07.251449Z",
  "id": "SOUL-62",
  "uuid": "7d4e52e3-12e4-4895-85d6-c98449837cc6",
  "title": "Integrate tool execution flow with approval and model loop",
  "description": "**As a** Consoul user\n**I want** a complete tool execution flow from detection to result\n**So that** AI can request tools, I approve them, they execute, and results return to AI\n\n**Context:**\nThis ticket integrates all tool calling components into a complete workflow:\n1. AI requests tool \u2192 2. Show approval modal \u2192 3. Execute if approved \u2192 4. Send result to AI \u2192 5. AI continues with tool result\n\nLangChain's tool calling loop requires tool results to be sent back as ToolMessage objects. The AI then uses these results to continue its response. This creates a multi-turn conversation pattern:\n- User message\n- AI message with tool_calls\n- Tool result messages\n- AI final response\n\nReference aider's approval flow and LangChain's create_tool_calling_agent pattern.\n\n**Technical Notes:**\n- Modify src/consoul/tui/app.py to handle tool call loop\n- Use ToolApprovalModal from SOUL-59\n- Execute tools from ToolRegistry (SOUL-58)\n- Create ToolMessage objects with results\n- Resume LLM call with extended message history\n- Update conversation history to include tool calls/results\n- Handle tool execution errors gracefully\n- Support cancellation at approval step\n\n**Acceptance Criteria:**\n\n**Given** AI requests a bash tool during response\n**When** I approve the tool execution\n**Then** tool executes and result is sent back to AI\n\n**Given** tool execution returns output\n**When** AI receives tool result\n**Then** AI incorporates result into final response\n\n**Given** I deny tool execution at approval modal\n**When** denial is registered\n**Then** AI is notified tool was denied and continues without result\n\n**Given** tool execution fails with error\n**When** error occurs\n**Then** error message is sent to AI as tool result\n\n**Given** AI requests multiple tools in parallel\n**When** I approve all tools\n**Then** all tools execute and results are batched in single user message\n\n**Given** tool execution is in progress\n**When** I cancel the operation\n**Then** execution stops and AI receives cancellation notice\n\n**Testing Considerations:**\n- Integration test full approval-execute-respond flow\n- Test tool denial workflow\n- Test tool execution errors\n- Test multiple parallel tools\n- Test conversation history with tool calls\n- Mock tool execution for safety\n- Test streaming resumption after tool results\n\n**Implementation Hints:**\n- Tool call handling loop:\n  ```python\n  async def _handle_tool_calls(self, message, tool_calls):\n      tool_results = []\n      \n      for tool_call in tool_calls:\n          # Show approval modal\n          approved = await self.push_screen(\n              ToolApprovalModal(tool_call.name, tool_call.args)\n          )\n          \n          if approved:\n              # Execute tool\n              result = await self.tool_registry.execute(\n                  tool_call.name, tool_call.args\n              )\n              tool_results.append(\n                  ToolMessage(\n                      content=result,\n                      tool_call_id=tool_call.id\n                  )\n              )\n          else:\n              tool_results.append(\n                  ToolMessage(\n                      content='Tool execution denied by user',\n                      tool_call_id=tool_call.id\n                  )\n              )\n      \n      # Continue AI call with tool results\n      messages.extend(tool_results)\n      final_response = await model.ainvoke(messages)\n  ```\n- Message history structure:\n  ```python\n  messages = [\n      HumanMessage('list files'),\n      AIMessage(content='', tool_calls=[...]),\n      ToolMessage(content='file1.txt\\nfile2.py', tool_call_id='call_123'),\n      AIMessage(content='I see you have 2 files...')\n  ]\n  ```\n- Conversation persistence:\n  - Store AIMessage with tool_calls\n  - Store ToolMessage results\n  - Link via tool_call_id\n\n**Files to Modify:**\n- src/consoul/tui/app.py (add tool execution loop)\n- src/consoul/ai/history.py (support tool messages)\n- src/consoul/ai/database.py (persist tool calls/results)\n\n**Dependencies:**\n- SOUL-58 (Tool registry)\n- SOUL-59 (Approval modal)\n- SOUL-60 (Bash tool)\n- SOUL-61 (Tool call detection)\n\nStory Points: 8",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "ai",
    "tui",
    "integration",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-004",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-11-14T23:28:29.802652",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}