{
  "created_at": "2025-11-13T08:39:57.251729",
  "updated_at": "2025-11-14T07:47:56.796931Z",
  "id": "SOUL-82",
  "uuid": "05bad0d3-cbca-4610-9496-dc005ebf3344",
  "title": "Implement file size and line truncation controls",
  "description": "**As a** Consoul user\n**I want** automatic truncation of very long lines and large outputs\n**So that** AI context windows aren't overwhelmed and performance stays good\n\n**Context:**\nLarge files or files with extremely long lines (minified JS, logs, data dumps) can overwhelm AI context windows and cause performance issues. Research shows:\n- Claude Code truncates lines over 2000 chars\n- Claude Code default output limit is around 40,000 chars\n- Cursor limits to 250 lines per read\n- Truncation should be clear with indicators\n\n**Technical Notes:**\n- Modify src/consoul/ai/tools/implementations/read.py\n- Apply max_line_length from config (default 2000 chars)\n- Apply max_output_chars from config (default 40000 chars)\n- Add truncation indicators to output\n- Handle empty files with friendly message\n\n**Acceptance Criteria:**\n\n**Given** a file with a line exceeding 2000 characters\n**When** read_file is called\n**Then** the line is truncated to 2000 chars with \" \u2026[line truncated]\" appended\n\n**Given** total output would exceed 40,000 characters\n**When** read_file is called\n**Then** output is truncated with \"\\\\n\u2026[output truncated - use offset/limit for more]\"\n\n**Given** an empty file (0 bytes)\n**When** read_file is called\n**Then** returns \"[File is empty]\"\n\n**Given** a file exactly at the limit\n**When** read_file is called\n**Then** no truncation occurs, full content returned\n\n**Testing Considerations:**\n- Test with very long lines (minified JavaScript)\n- Test with large files that exceed max_output_chars\n- Test empty files\n- Test files exactly at limits (boundary testing)\n- Verify truncation messages are helpful\n\n**Implementation Hints:**\n```python\ndef _apply_truncation(lines: list[tuple[int, str]], config: ReadToolConfig) -> str:\n    numbered = []\n    total_chars = 0\n    \n    for line_num, content in lines:\n        # Truncate long lines\n        if len(content) > config.max_line_length:\n            content = content[:config.max_line_length] + \" \u2026[line truncated]\"\n        \n        line_output = f\"{line_num:6d}\\\\t{content}\"\n        numbered.append(line_output)\n        total_chars += len(line_output)\n        \n        # Check total output limit\n        if total_chars > config.max_output_chars:\n            numbered.append(\"\\\\n\u2026[output truncated - use offset/limit to read more]\")\n            break\n    \n    return \"\\\\n\".join(numbered)\n```\n- Truncate individual lines first\n- Then check total output size\n- Provide helpful messages about using offset/limit\n- Handle empty files before processing",
  "status": "done",
  "type": "task",
  "priority": "medium",
  "labels": [
    "tools",
    "performance",
    "safety"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-005",
  "blocked_by": [
    "SOUL-79",
    "SOUL-80"
  ],
  "blocks": [
    "SOUL-83",
    "SOUL-85"
  ],
  "comments": [
    {
      "created_at": "2025-11-13T08:50:22.439697",
      "updated_at": "2025-11-13T08:50:22.439698",
      "id": "20251113085022-322c9c9f",
      "ticket_id": "SOUL-82",
      "author": "jared@goatbytes.io",
      "content": "SCOPE CLARIFICATION: This ticket owns ALL truncation logic. SOUL-80 (core read tool) will return raw output without any truncation. This ticket will wrap or integrate with the core tool to apply max_line_length and max_output_chars limits. This separation keeps SOUL-80 focused on baseline read semantics (encoding, security, line numbering) while SOUL-82 handles performance/safety controls.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-11-13T11:36:07.199251",
      "updated_at": "2025-11-13T11:36:07.199252",
      "id": "20251113113607-bc4146b6",
      "ticket_id": "SOUL-82",
      "author": "jared@goatbytes.io",
      "content": "\u2705 SOUL-82 Implementation Complete\n\n## Summary\nSuccessfully implemented three-layer truncation controls to prevent LLM context overflow while maintaining readability.\n\n## Implementation Details\n\n### 1. Refactored _format_with_line_numbers()\n**Before**: `str` return value\n**After**: `tuple[str, int, bool]` return value with:\n- formatted: Formatted string with line numbers\n- total_chars: Total character count for downstream limit checks\n- any_truncated: Flag indicating if any line was truncated\n\n**Line Truncation**: Lines exceeding `max_line_length` (2000 chars) truncated with \" \u2026[line truncated]\" suffix\n\n### 2. Added _apply_output_limit() Helper\n**Purpose**: Enforce total output character limit across entire file/PDF\n**Behavior**:\n- Returns original if under `max_output_chars` (40000 chars)\n- Truncates at last complete line to avoid mid-line cuts\n- Adds \"\u2026[output truncated - use offset/limit to read more]\" message\n\n### 3. Updated read_file()\n**Truncation Layers**:\n1. **Line count**: Existing `max_lines_default` (2000 lines) - with enhanced message\n2. **Line length**: Via `_format_with_line_numbers()` (2000 chars/line)\n3. **Total output**: Via `_apply_output_limit()` (40000 chars total)\n\n**Message Improvements**:\n- Changed \"Output truncated to\" \u2192 \"Output limited to\" for consistency\n- Includes total file lines: \"(file has 3000 total lines)\"\n- Clear guidance: \"Use offset/limit parameters to read more\"\n\n### 4. Updated _read_pdf()\n**Enhancements**:\n- Applied line length truncation to PDF text (per-line, per-page)\n- Track total_chars across pages\n- Break early if exceeding `max_output_chars`\n- Consistent truncation behavior with text files\n\n## Testing Results\n\n### New Tests Added (7 tests):\n1. `test_read_long_line_truncated` - Single long line behavior\n2. `test_read_multiple_long_lines` - Multiple long lines preserved\n3. `test_read_large_output_truncated` - Total output character limit\n4. `test_read_exact_line_length` - Boundary case: exactly at limit\n5. `test_read_exact_output_length` - Boundary case: exactly at output limit\n6. `test_read_minified_javascript` - Real-world case: minified JS\n7. `test_read_empty_file_still_works` - Edge case: empty file still readable\n\n### Test Fixes:\n- Updated `test_read_large_file_applies_default_limit` message assertion\n- Fixed 5 `TestFormatWithLineNumbers` tests for tuple return signature\n- All tests use consistent unpacking: `result, total_chars, truncated = ...`\n\n### Coverage Metrics:\n\u2705 All 62 tests passing (55 original + 7 new)\n\u2705 Coverage: 83.65% on read.py (significant improvement)\n\u2705 Pre-commit hooks passing (ruff, ruff-format, mypy)\n\n## Example Behaviors\n\n### Long Line Truncation:\n```python\n# Input: \"x\" * 3000\n# Output: \"     1\\t\" + \"x\" * 2000 + \" \u2026[line truncated]\"\n```\n\n### Large Output Truncation:\n```python\n# 100 lines * 500 chars/line = 50000 chars > 40000 limit\n# Output: Truncated at ~line 80 with \"\u2026[output truncated - use offset/limit to read more]\"\n```\n\n### Large File Truncation:\n```python\n# 3000 line file, no offset/limit\n# Output: First 2000 lines + \"[Note: Output limited to 2000 lines (file has 3000 total lines). Use offset/limit parameters to read more.]\"\n```\n\n## Files Modified\n\n**Core Implementation**:\n- `src/consoul/ai/tools/implementations/read.py` (+91 lines, refactored 2 functions)\n\n**Tests**:\n- `tests/ai/tools/implementations/test_read.py` (+159 lines, 7 new tests, 5 updated assertions)\n\n**Project Tracking**:\n- `.gira/board/in_progress/SOUL-82.json` \u2192 `.gira/board/done/SOUL-82.json`\n\n## Verification\n\n**Commit**: 0c5807a\n**Branch**: develop\n**Status**: All tests passing, pre-commit hooks passing, ready for merge\n\n## Impact Assessment\n\n**Positive**:\n- Prevents LLM context overflow from large files\n- Preserves file structure with clear truncation points\n- Informative messages guide users to read more content\n- Backward compatible (all existing tests pass)\n\n**Considerations**:\n- Very large files (>2000 lines) require offset/limit for full access\n- Minified/compressed files may lose readability (intentional tradeoff)\n- PDF text extraction respects same limits as text files\n\n## Closes\nSOUL-82: Implement file size and line truncation controls",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 2,
  "story_points": 2,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-11-14T23:28:31.711345",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}