{
  "created_at": "2025-11-15T00:48:36.567234",
  "updated_at": "2025-11-23T06:23:55.073656Z",
  "id": "SOUL-112",
  "uuid": "14ddaa60-2a66-4a7e-949a-a7be7ae150d1",
  "title": "Add integration tests for multimodal image analysis",
  "description": "**As a** Consoul developer\n**I want** comprehensive integration tests for image analysis\n**So that** we ensure vision capabilities work correctly across all providers\n\n**Context:**\nIntegration tests should verify end-to-end functionality:\n- Real (small) test images\n- Actual provider API calls (in test mode)\n- Complete workflow: tool registration \u2192 execution \u2192 response\n- Error handling and edge cases\n- Provider-specific quirks\n\nTests should be skipped if:\n- API keys not available (CI/local dev)\n- Provider not installed\n- Network unavailable\n\n**Technical Notes:**\n- tests/integration/test_image_analysis.py - New test file\n- Use pytest markers: @pytest.mark.integration, @pytest.mark.vision\n- Use small test fixtures (< 100KB images)\n- Mock provider responses for fast tests\n- Optional real API tests with @pytest.mark.slow\n- Test all supported providers (Claude, OpenAI, Gemini, Ollama)\n- Verify audit logging captures image analysis events\n\n**Acceptance Criteria:**\n\n**Given** I have valid test images in tests/fixtures/\n**When** I run integration tests\n**Then** analyze_images tool executes successfully with mocked responses\n\n**Given** I have API keys configured\n**When** I run tests with --run-real-api flag\n**Then** actual provider APIs are called and return valid responses\n\n**Given** I test with Claude 3.5 Sonnet\n**When** analyzing a code screenshot\n**Then** response contains relevant code analysis\n\n**Given** I test with GPT-4o\n**When** analyzing a diagram\n**Then** response describes the diagram content\n\n**Given** I test error handling\n**When** providing invalid image path\n**Then** clear error message is returned without API call\n\n**Testing Considerations:**\n- Create realistic but small test images\n- Mock provider responses for CI\n- Optional real API tests (marked @slow)\n- Test timeout handling\n- Test rate limit errors\n- Test network failures gracefully\n- Verify audit logs created correctly\n\n**Implementation Hints:**\n```python\nimport pytest\nfrom pathlib import Path\nfrom consoul.ai.tools.implementations.analyze_images import analyze_images\nfrom consoul.ai.multimodal import format_anthropic_vision\n\n# Test fixtures\n@pytest.fixture\ndef test_image_png():\n    \"\"\"Small PNG test image (< 100KB).\"\"\"\n    return Path(__file__).parent / \"fixtures\" / \"test_code_screenshot.png\"\n\n@pytest.fixture\ndef test_image_jpg():\n    \"\"\"Small JPEG test image.\"\"\"\n    return Path(__file__).parent / \"fixtures\" / \"test_diagram.jpg\"\n\n# Mock tests (fast, no API calls)\n@pytest.mark.integration\ndef test_analyze_images_with_mock(test_image_png, mock_anthropic_response):\n    \"\"\"Test image analysis with mocked Claude response.\"\"\"\n    result = await analyze_images(\n        query=\"What does this code do?\",\n        image_paths=[str(test_image_png)]\n    )\n    assert \"error\" in result or \"function\" in result.lower()\n\n# Real API tests (slow, requires API keys)\n@pytest.mark.slow\n@pytest.mark.skipif(not os.getenv(\"ANTHROPIC_API_KEY\"), reason=\"No API key\")\ndef test_analyze_images_claude_real_api(test_image_png):\n    \"\"\"Test with real Claude API call.\"\"\"\n    result = await analyze_images(\n        query=\"Describe this code screenshot\",\n        image_paths=[str(test_image_png)]\n    )\n    assert len(result) > 0\n    assert \"code\" in result.lower() or \"function\" in result.lower()\n\n# Provider-specific tests\n@pytest.mark.integration\n@pytest.mark.parametrize(\"provider,model\", [\n    (\"anthropic\", \"claude-3-5-sonnet-20241022\"),\n    (\"openai\", \"gpt-4o\"),\n    (\"google\", \"gemini-2.0-flash\"),\n])\ndef test_multimodal_formatting(provider, model, test_image_png):\n    \"\"\"Test provider-specific message formatting.\"\"\"\n    # Test that each provider's format is correct\n    pass\n\n# Error handling tests\n@pytest.mark.integration\ndef test_analyze_nonexistent_image():\n    \"\"\"Test error handling for missing image.\"\"\"\n    with pytest.raises(ValueError, match=\"File not found\"):\n        await analyze_images(\n            query=\"Analyze this\",\n            image_paths=[\"/nonexistent/image.png\"]\n        )\n\n@pytest.mark.integration\ndef test_analyze_oversized_image(tmp_path):\n    \"\"\"Test error handling for oversized image.\"\"\"\n    # Create large test file\n    large_file = tmp_path / \"large.png\"\n    large_file.write_bytes(b\"x\" * (10 * 1024 * 1024))  # 10MB\n    \n    with pytest.raises(ValueError, match=\"exceeds maximum size\"):\n        await analyze_images(\n            query=\"Analyze this\",\n            image_paths=[str(large_file)]\n        )\n```\n\nFiles to create:\n- tests/integration/test_image_analysis.py\n- tests/fixtures/test_code_screenshot.png (small test image)\n- tests/fixtures/test_diagram.jpg (small test image)\n- tests/integration/conftest.py (shared fixtures)\n\nDependencies: SOUL-113, SOUL-114, SOUL-115",
  "status": "done",
  "type": "task",
  "priority": "medium",
  "labels": [
    "testing",
    "ai",
    "quality"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-007",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-22T22:23:48.879875",
      "updated_at": "2025-11-22T22:23:48.879876",
      "id": "20251122222348-b33e4717",
      "ticket_id": "SOUL-112",
      "author": "jared@goatbytes.io",
      "content": "Comprehensive integration tests implemented during SOUL-113 development.\n\nTest coverage (39 tests, all passing):\n- MIME type detection for PNG/JPEG/WebP\n- Security: path traversal prevention, blocked paths\n- File validation: extension, magic bytes, size limits\n- Full tool integration with real test images\n- Error handling and edge cases\n\nTest files:\n- tests/ai/tools/implementations/test_analyze_images.py (449 lines, 39 tests)\n- tests/fixtures/test_image.png, test_photo.jpg, test_diagram.webp\n\nVerified with: pytest tests/ai/tools/implementations/test_analyze_images.py -v (100% pass)",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "story_points": 5,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-03T15:09:11.338617",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}