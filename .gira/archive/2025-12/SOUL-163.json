{
  "created_at": "2025-11-23T23:30:00.253822",
  "updated_at": "2025-11-24T20:09:48.920474Z",
  "id": "SOUL-163",
  "uuid": "cd4430db-1e30-4358-ab49-042cf6f609c0",
  "title": "Build system prompt dynamically based on enabled tools",
  "description": "**As a** Consoul user\n**I want** the system prompt to reflect only the tools I have enabled\n**So that** the LLM doesn't get confused about which tools are available\n\n**Context:**\nCurrently, the system prompt has a hardcoded list of tools in the \"Available Tools\" section. This creates problems:\n1. LLM thinks it has tools that might be disabled\n2. New tools added to registry aren't documented automatically\n3. Wasted tokens describing unavailable tools\n4. Poor UX when user disables dangerous tools but prompt still mentions them\n\n**Solution:**\nBuild system prompt dynamically at runtime based on enabled tools in the registry.\n\n**Technical Notes:**\n- Keep static parts separate (general instructions, code guidelines, security policy)\n- Generate tool section dynamically from `tool_registry.list_tools(enabled_only=True)`\n- Use tool metadata (description, risk level, parameters) for documentation\n- Inject at chat initialization when creating chat model\n- Consider using template marker like `{AVAILABLE_TOOLS}` in base prompt\n- Profile config already has `system_prompt` field - extend this pattern\n\n**Implementation hints:**\n```python\ndef build_system_prompt(base_prompt: str, tool_registry: ToolRegistry) -> str:\n    \"\"\"Build system prompt with dynamic tool documentation.\"\"\"\n    enabled_tools = tool_registry.list_tools(enabled_only=True)\n    \n    if not enabled_tools:\n        tools_section = \"No tools enabled. Text responses only.\"\n    else:\n        tools_section = format_tools_documentation(enabled_tools)\n    \n    return base_prompt.replace(\"{AVAILABLE_TOOLS}\", tools_section)\n```\n\n**Files to modify:**\n- `src/consoul/ai/prompt_builder.py` (new) - Prompt building logic\n- `src/consoul/tui/app.py` - Use dynamic prompt at chat init\n- `src/consoul/config/models.py` - Profile model for prompt templates\n- Default profile configs - Update to use template markers\n\n**Acceptance Criteria:**\n\n**Given** 10 tools enabled out of 13 total\n**When** chat session starts\n**Then** system prompt lists only those 10 tools with descriptions\n\n**Given** all tools disabled\n**When** chat session starts\n**Then** system prompt indicates no tools available\n\n**Given** user toggles tools via Tool Manager\n**When** new chat message is sent\n**Then** system prompt reflects current enabled tools\n\n**Testing Considerations:**\n- Test with different tool combinations (all, none, some)\n- Verify prompt token count decreases with fewer tools\n- Test that LLM doesn't try to use disabled tools\n- Verify tool metadata (description, risk) appears in prompt",
  "status": "done",
  "type": "feature",
  "priority": "medium",
  "labels": [],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-24T11:54:05.874736",
      "updated_at": "2025-11-24T11:54:05.874737",
      "id": "20251124115405-a62fe6fe",
      "ticket_id": "SOUL-163",
      "author": "jared@goatbytes.io",
      "content": "Completed dynamic system prompt implementation. System prompts now:\n1. Initialize correctly on app mount (fixed truthiness bug with ConversationHistory.__len__)\n2. Update dynamically when tools are enabled/disabled via Tool Manager\n3. Display accurately via Ctrl+Shift+S modal with metadata\n4. Use {AVAILABLE_TOOLS} marker for dynamic tool documentation\n\nKey fixes:\n- Moved system prompt init from __init__ to on_mount() lifecycle\n- Fixed truthiness checks to use 'is None' instead of 'not obj'\n- Tool Manager calls app._rebind_tools() directly for immediate updates\n- Used correct logger (logging.getLogger) instead of self.log",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-03T15:09:11.003332",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}