{
  "created_at": "2025-11-26T00:52:12.852875",
  "updated_at": "2025-11-26T17:52:57.775991Z",
  "id": "SOUL-169",
  "uuid": "055df824-ed23-40e1-968a-e279daadf166",
  "title": "Implement tool call display and approval in CLI chat",
  "description": "**As a** Consoul chat user with tools enabled\n**I want** clear display of tool calls and ability to approve/deny them\n**So that** I have control over tool execution like in TUI mode\n\n**Context:**\nWhen tools are enabled, AI may request tool execution. CLI chat needs to:\n- Display tool calls clearly (name, arguments)\n- Prompt for approval (y/n/always/never)\n- Show tool execution results\n- Include results in conversation context\n- Handle tool errors gracefully\n\nTUI has robust tool approval: src/consoul/tui/modals/tool_approval_modal.py\nCan reuse tool execution logic but need CLI-friendly display.\n\n**Technical Notes:**\n- src/consoul/cli/chat_session.py - handle tool calls during streaming\n- Use Rich panels for tool call display\n- Prompt for approval: y=yes, n=no, a=always approve this tool, v=never (deny)\n- Track approval state per tool per session\n- Execute tools using existing tool registry\n- Format tool results for context and display\n- Handle tool execution errors with clear messages\n- Reference TUI: src/consoul/tui/app.py:1416-1800 (_stream_ai_response)\n\n**Acceptance Criteria:**\n\n**Given** AI requests tool execution during chat\n**When** tool call is detected\n**Then** tool name and arguments are displayed in a Rich panel\n\n**Given** tool call requires approval\n**When** user is prompted\n**Then** options are y/n/a/v with clear descriptions\n\n**Given** user approves tool (y or a)\n**When** tool executes\n**Then** result is displayed and added to conversation context\n\n**Given** user denies tool (n or v)\n**When** denial is submitted\n**Then** AI receives denial message and continues without execution\n\n**Given** user selected always approve (a) for a tool\n**When** same tool is called again\n**Then** it executes automatically without prompting\n\n**Given** tool execution fails\n**When** error occurs\n**Then** clear error message shown and AI receives error context\n\n**Testing Considerations:**\n- Mock tool calls from AI response\n- Test approval/denial flows\n- Test always/never approval state\n- Test tool execution success/failure\n- Test with multiple sequential tool calls\n- Verify tool results appear in conversation context\n- Test with different tool types (bash, grep, read, etc.)\n\n**Implementation Hints:**\n```python\nfrom rich.panel import Panel\nfrom rich.prompt import Prompt\n\n# Detect tool calls from AIMessage\nif hasattr(ai_message, 'tool_calls') and ai_message.tool_calls:\n    for tool_call in ai_message.tool_calls:\n        # Display tool call\n        console.print(Panel(\n            f\"Tool: {tool_call['name']}\\n\"\n            f\"Args: {json.dumps(tool_call['args'], indent=2)}\",\n            title=\"Tool Call\",\n            border_style=\"cyan\"\n        ))\n        \n        # Check if auto-approved\n        if tool_call['name'] in always_approve:\n            approved = True\n        elif tool_call['name'] in never_approve:\n            approved = False\n        else:\n            # Prompt for approval\n            choice = Prompt.ask(\n                \"Approve?\",\n                choices=['y', 'n', 'a', 'v'],\n                default='y'\n            )\n            approved = choice in ['y', 'a']\n            if choice == 'a':\n                always_approve.add(tool_call['name'])\n            elif choice == 'v':\n                never_approve.add(tool_call['name'])\n        \n        if approved:\n            # Execute tool\n            result = execute_tool(tool_call)\n            # Add to history as ToolMessage\n```\n\nDependencies: SOUL-166 (ChatSession class)",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "cli",
    "tools",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-03T15:09:11.897676",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}