{
  "created_at": "2025-11-29T08:25:20.472956",
  "updated_at": "2025-11-29T16:58:35.651304Z",
  "id": "SOUL-185",
  "uuid": "fc24365b-f9bc-4caf-9647-80d3a408d899",
  "title": "Implement model-specific cost calculation with accurate pricing",
  "description": "## Problem\nCurrent cost estimation uses hard-coded Claude pricing ($3/M input, $15/M output) for ALL models, regardless of provider.\n\n## Solution\nImplement model-specific pricing lookup with accurate rates for each model.\n\n## Pricing Data (2024-2025)\n\n### OpenAI Models\n```python\nOPENAI_PRICING = {\n    'gpt-4o': {'input': 0.0025, 'output': 0.01},  # per 1K tokens\n    'gpt-4o-mini': {'input': 0.00015, 'output': 0.0006},\n    'gpt-4-turbo': {'input': 0.01, 'output': 0.03},\n    'gpt-4': {'input': 0.03, 'output': 0.06},\n    'gpt-3.5-turbo': {'input': 0.0005, 'output': 0.0015},\n}\n```\n\n### Anthropic Models\n```python\nANTHROPIC_PRICING = {\n    'claude-opus-4.5': {'input': 0.005, 'output': 0.025},  # per 1K tokens\n    'claude-3-5-sonnet-20241022': {'input': 0.003, 'output': 0.015},\n    'claude-3-5-haiku-20241022': {'input': 0.001, 'output': 0.005},\n    'claude-3-opus': {'input': 0.015, 'output': 0.075},\n    'claude-3-sonnet': {'input': 0.003, 'output': 0.015},\n    'claude-3-haiku': {'input': 0.00025, 'output': 0.00125},\n}\n```\n\n### Google Models  \n```python\nGOOGLE_PRICING = {\n    'gemini-2.0-flash-exp': {'input': 0.0001, 'output': 0.0004},  # per 1K tokens\n    'gemini-2.5-flash': {'input': 0.0001, 'output': 0.0004},\n    'gemini-1.5-pro': {'input': 0.00125, 'output': 0.005},\n    'gemini-1.5-flash': {'input': 0.000075, 'output': 0.0003},\n}\n```\n\n## Implementation\n\n### 1. Create Pricing Module\n\n```python\n# src/consoul/ai/pricing.py\n\nfrom dataclasses import dataclass\nfrom typing import Dict\n\n@dataclass\nclass ModelPricing:\n    input_cost_per_1k: float   # Cost per 1,000 input tokens\n    output_cost_per_1k: float  # Cost per 1,000 output tokens\n    currency: str = 'USD'\n\n# Pricing database (update regularly\\!)\nMODEL_PRICING: Dict[str, ModelPricing] = {\n    # OpenAI\n    'gpt-4o': ModelPricing(2.5, 10.0),\n    'gpt-4o-mini': ModelPricing(0.15, 0.6),\n    # ... rest of models\n}\n\ndef get_model_pricing(model_name: str) -> ModelPricing | None:\n    \"\"\"Get pricing for a model, with fallback to base model.\"\"\"\n    # Exact match\n    if model_name in MODEL_PRICING:\n        return MODEL_PRICING[model_name]\n    \n    # Try base model (e.g., 'gpt-4o-2024-08-06' -> 'gpt-4o')\n    for base_model in MODEL_PRICING:\n        if model_name.startswith(base_model):\n            return MODEL_PRICING[base_model]\n    \n    return None\n\ndef calculate_cost(\n    input_tokens: int,\n    output_tokens: int,\n    model_name: str\n) -> float:\n    \"\"\"Calculate cost in USD for token usage.\"\"\"\n    pricing = get_model_pricing(model_name)\n    if not pricing:\n        return 0.0  # Unknown model\n    \n    input_cost = (input_tokens / 1000) * pricing.input_cost_per_1k\n    output_cost = (output_tokens / 1000) * pricing.output_cost_per_1k\n    return input_cost + output_cost\n```\n\n### 2. Update SDK\n\n```python\n# In sdk.py last_cost property\nfrom consoul.ai.pricing import calculate_cost, get_model_pricing\n\n@property\ndef last_cost(self) -> dict[str, Any]:\n    # ... get token counts from usage_metadata ...\n    \n    cost = calculate_cost(input_tokens, output_tokens, self.model_name)\n    pricing = get_model_pricing(self.model_name)\n    \n    return {\n        'input_tokens': input_tokens,\n        'output_tokens': output_tokens,\n        'total_tokens': input_tokens + output_tokens,\n        'cost_usd': round(cost, 6),\n        'model': self.model_name,\n        'pricing_available': pricing is not None,\n        'input_cost_per_1k': pricing.input_cost_per_1k if pricing else None,\n        'output_cost_per_1k': pricing.output_cost_per_1k if pricing else None,\n    }\n```\n\n## Maintenance\n\n\u26a0\ufe0f **Pricing changes frequently\\!** Add a mechanism to:\n1. Log warnings when pricing data is older than 6 months\n2. Provide easy way to update pricing (config file or API)\n3. Document pricing source and last update date\n\n## Testing\n\n- Test cost calculation for each provider\n- Test fallback for unknown models\n- Test base model matching (e.g., 'gpt-4o-2024-08-06')\n- Verify pricing accuracy against provider docs\n\n## References\n- OpenAI Pricing: https://openai.com/api/pricing/\n- Anthropic Pricing: https://www.anthropic.com/pricing\n- Google Gemini Pricing: https://ai.google.dev/gemini-api/docs/pricing",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-03T15:09:09.459106",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}