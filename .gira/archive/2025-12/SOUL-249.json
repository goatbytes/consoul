{
  "created_at": "2025-12-10T00:52:29.079490",
  "updated_at": "2025-12-15T17:02:35.376448Z",
  "id": "SOUL-249",
  "uuid": "a2f0b69e-4ea0-4ced-9062-ab6d77964a17",
  "title": "Refactor TUI app.py to use service layer",
  "description": "**As a** Consoul developer\n**I want** the TUI app.py refactored to use the new service layer\n**So that** business logic is decoupled from UI and app.py is maintainable (<2,000 lines)\n\n**Context:**\nCurrently, tui/app.py is a 5,541-line monolith with ~3,000 lines of business logic embedded directly in the UI code. After SOUL-245, SOUL-246, SOUL-247 create the service layer, this ticket will refactor app.py to delegate all business logic to services.\n\n**Goal:** Reduce app.py from 5,541 \u2192 <2,000 lines of pure UI orchestration\n\n**Lines to Remove:**\n- 1597-2740 (streaming/messages) \u2192 Use ConversationService \u2705\n- 3087-3906 (tool execution) \u2192 Use ToolService \u2705  \n- 260-607 (model init) \u2192 Use ModelService \u2705\n- 314-507 (tool setup) \u2192 Use ToolService \u2705\n- 1275-1435 (multimodal) \u2192 Use ConversationService \u2705\n\n**Technical Notes:**\n- Refactor: src/consoul/tui/app.py (entire file)\n- Update: All widgets receiving SDK types to receive UI models instead\n- Remove: Direct imports of 40+ SDK modules\n- Add: Service instances in ConsoulApp.__init__()\n- Create: TUI data models in src/consoul/tui/models.py\n- Use: Event-driven architecture for widget communication\n- Dependencies: SOUL-245, SOUL-246, SOUL-247 (all services must exist first)\n\n**Acceptance Criteria:**\n\n**Given** The service layer exists (SOUL-245, 246, 247)\n**When** I refactor app.py to use services\n**Then** app.py is <2,000 lines of UI code only\n\n**Given** User sends a message in TUI\n**When** Message submission occurs\n**Then** ConversationService.send_message() is called and tokens stream to UI\n\n**Given** A tool requires approval\n**When** Tool execution is needed\n**Then** TUI approval modal is shown via callback, not direct execution\n\n**Given** User switches models\n**When** Model picker is used\n**Then** ModelService.switch_model() is called, not direct initialization\n\n**Given** Widgets need data\n**When** Widgets mount\n**Then** Data is passed via props/events, not direct SDK queries\n\n**Testing Considerations:**\n- Full TUI integration testing\n- Test message submission workflow\n- Test tool approval flow\n- Test model switching\n- Test conversation history display\n- Verify no direct SDK imports in UI code\n- Test error handling propagation from services\n\n**Implementation Hints:**\n- Create self.conversation_service, self.tool_service, self.model_service in __init__\n- Replace _stream_ai_response() with async for token in self.conversation_service.send_message()\n- Replace _execute_tool() with await self.tool_service.execute_tool(request)\n- Replace _initialize_ai_model() with self.model_service.get_model()\n- Create tui/models.py with MessageDisplay, ToolCallDisplay dataclasses\n- Update widgets to receive TUI models instead of SDK types\n- Use message passing between widgets and app\n- Remove all direct ToolRegistry, ConversationHistory, BaseChatModel usage",
  "status": "done",
  "type": "task",
  "priority": "critical",
  "labels": [
    "tui",
    "refactor",
    "breaking-change",
    "technical-debt"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-013",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-12-13T10:43:51.875157",
      "updated_at": "2025-12-13T10:43:51.875158",
      "id": "20251213104351-6f6ea40f",
      "ticket_id": "SOUL-249",
      "author": "jared@goatbytes.io",
      "content": "\u2705 All work complete! \n\nFinal Results:\n- app.py: 5,881 \u2192 1,932 lines (67% reduction)\n- Target achieved: <2,000 lines \u2705\n- All services created and integrated\n- All sub-tickets (SOUL-265, 267, 268, 269, 270) completed\n\nArchitecture improvements:\n\u2705 ConversationService facade implemented\n\u2705 ToolService integration complete  \n\u2705 ModelService integration complete\n\u2705 TUI data models created\n\u2705 app.py is now pure UI orchestration (no business logic)\n\nThis represents one of the largest refactoring efforts in the project, successfully decoupling the TUI layer from SDK internals while maintaining all functionality.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "story_points": 13,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-16T03:35:59.189969+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}