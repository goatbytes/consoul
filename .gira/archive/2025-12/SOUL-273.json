{
  "created_at": "2025-12-11T17:26:07.867717",
  "updated_at": "2025-12-16T11:52:14.043938",
  "id": "SOUL-273",
  "uuid": "c08c50ee-034b-4b1b-ab98-bb27833122d5",
  "title": "Replace deprecated datetime.utcnow() with timezone-aware API",
  "description": "**As a** Consoul developer\n**I want** to use the modern timezone-aware datetime API\n**So that** the code remains compatible with future Python versions and follows best practices\n\n**Context:**\nThere are 7 occurrences of the deprecated `datetime.utcnow()` method across 2 files in the codebase. This method is deprecated as of Python 3.12 and is scheduled for removal in a future version.\n\n**Deprecated API:**\n```python\nfrom datetime import datetime\nnow = datetime.utcnow()  # DeprecationWarning in Python 3.12+\n```\n\n**Modern Replacement:**\n```python\nfrom datetime import datetime, timezone\nnow = datetime.now(timezone.utc)  # Timezone-aware, recommended\n```\n\n**Python Warning Message:**\n```\nDeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled \nfor removal in a future version. Use timezone-aware objects to represent \ndatetimes in UTC: datetime.datetime.now(datetime.UTC).\n```\n\n**Affected Files and Lines:**\n\n1. **src/consoul/ai/history.py:578**\n   - In `add_system_message()` method\n   - Sets `system_prompt_stored_at` timestamp in metadata\n\n2. **src/consoul/ai/database.py** (6 occurrences):\n   - Line 227: `create_conversation()` - sets conversation creation timestamp\n   - Line 279: `add_message()` - sets message timestamp\n   - Line 348: `save_conversation()` - sets save timestamp\n   - Line 568: `update_summary()` - updates conversation timestamp\n   - Line 690: `create_branch()` - sets branch timestamp\n   - Line 757: `create_branch()` - updates conversation timestamp  \n   - Line 1135: `update_conversation_metadata()` - updates conversation timestamp\n\n**Impact:**\n- **Current:** DeprecationWarnings in Python 3.12+ environments\n- **Future:** Code will break when `datetime.utcnow()` is removed (Python 3.14+)\n- **Compatibility:** Following modern Python datetime best practices\n- **Testing:** All unit tests using mocked timestamps need verification\n\n**Technical Notes:**\n- Both files already import `from datetime import datetime`\n- Need to add `timezone` to imports: `from datetime import datetime, timezone`\n- The replacement is straightforward: `datetime.utcnow()` \u2192 `datetime.now(timezone.utc)`\n- All usages are followed by `.isoformat()` so the output format remains the same\n- Timezone-aware datetimes are more explicit and prevent subtle bugs\n- Python 3.9+ supports `datetime.UTC` as shorthand for `timezone.utc`\n\n**Acceptance Criteria:**\n\n**Given** the codebase runs on Python 3.12+\n**When** conversation history or database operations execute\n**Then** no DeprecationWarnings are raised for datetime operations\n\n**Given** a conversation is created with `create_conversation()`\n**When** the timestamp is stored in the database\n**Then** it uses `datetime.now(timezone.utc)` instead of `datetime.utcnow()`\n\n**Given** all 7 occurrences are updated\n**When** the code runs on Python 3.14+ (when utcnow is removed)\n**Then** the code continues to work without errors\n\n**Given** timestamps are generated before and after the fix\n**When** comparing the ISO format output\n**Then** the timestamps are functionally equivalent (both are UTC)\n\n**Testing Considerations:**\n- Run existing test suite to ensure no regressions\n- Verify all timestamp-related tests pass\n- Check that stored timestamps in SQLite database remain valid\n- Test conversation creation, message adding, branching, and metadata updates\n- Ensure ISO format output remains identical: `YYYY-MM-DDTHH:MM:SS.ffffff`\n- Verify no timezone offset is appended (both methods produce naive UTC times when using `.isoformat()`)\n- Add a test to verify no DeprecationWarnings are raised\n\n**Implementation Hints:**\n\n1. **Update imports** (2 files):\n   ```python\n   # Before\n   from datetime import datetime\n   \n   # After\n   from datetime import datetime, timezone\n   ```\n\n2. **Replace all occurrences** (7 total):\n   ```python\n   # Before\n   now = datetime.utcnow().isoformat()\n   \n   # After\n   now = datetime.now(timezone.utc).isoformat()\n   ```\n\n3. **Files to modify:**\n   - `src/consoul/ai/history.py` (1 occurrence, line 578)\n   - `src/consoul/ai/database.py` (6 occurrences, lines 227, 279, 348, 568, 690, 757, 1135)\n\n4. **Verification:**\n   ```bash\n   # Search for any remaining deprecated usage\n   grep -r \"datetime.utcnow()\" src/consoul/\n   \n   # Should return no results after fix\n   ```\n\n5. **Alternative for Python 3.9+:**\n   Could use `datetime.UTC` instead of `timezone.utc`:\n   ```python\n   datetime.now(datetime.UTC)  # Shorter, requires Python 3.9+\n   ```\n\n**Related Python Documentation:**\n- [PEP 615 \u2013 Support for the IANA Time Zone Database](https://peps.python.org/pep-0615/)\n- [datetime.utcnow() deprecation notice](https://docs.python.org/3/library/datetime.html#datetime.datetime.utcnow)\n- [Aware and naive datetime objects](https://docs.python.org/3/library/datetime.html#aware-and-naive-objects)",
  "status": "done",
  "type": "bug",
  "priority": "medium",
  "labels": [
    "deprecation",
    "python-3.12",
    "datetime",
    "technical-debt",
    "maintenance"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-12-16T11:52:14.043832",
      "updated_at": "2025-12-16T11:52:14.043833",
      "id": "20251216115214-35481fc5",
      "ticket_id": "SOUL-273",
      "author": "jared@goatbytes.io",
      "content": "Successfully replaced all deprecated datetime.utcnow() calls with datetime.now(timezone.utc).\n\nCompleted changes:\n- Updated imports in history.py and database.py to include timezone\n- Replaced 8 occurrences in production code (1 in history.py, 7 in database.py)\n- Fixed 2 additional occurrences in test_database.py\n- Verified no DeprecationWarnings remain in test output\n- All tests pass (5 pre-existing failures unrelated to this change)\n\nResult: Zero DeprecationWarnings for datetime operations in Python 3.12+\nCommit: d5bd5d0",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "story_points": 2,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-16T21:38:17.206617+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}