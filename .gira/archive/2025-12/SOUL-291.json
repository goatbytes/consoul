{
  "created_at": "2025-12-23T11:33:58.446217",
  "updated_at": "2025-12-23T23:09:24.697911Z",
  "id": "SOUL-291",
  "uuid": "c390aa53-53c9-4c18-bc86-9b6f253dd8db",
  "title": "Fix CLI tool support: remove hardcoded whitelist and pass tool_registry to system prompts",
  "description": "**Problem:**\nThree critical issues preventing CLI tool functionality:\n\n1. **Hardcoded Ollama model whitelist** (providers.py:2053-2065): Only whitelisted models (llama3, mistral, qwen, etc.) could use tools. Models like gpt-oss:20b were blocked despite supporting tools.\n\n2. **CLI system prompts missing tool documentation**: ProfileManager.build_profile_system_prompt() wasn't passing tool_registry, causing system prompts to include 'You have NO tools available' message even when tools were bound.\n\n3. **Wrong attribute path in exit handler** (__main__.py:605): Used session.history.session_id instead of session.conversation_service.conversation.session_id, causing AttributeError on Ctrl+C.\n\n**Root Cause:**\n- Commit cf546fd (Dec 15) introduced model whitelist as 'prevention layer' but it was too restrictive\n- ChatSession._build_system_prompt() and ProfileManager never received tool_registry parameter\n- System prompt builder fell back to 'no tools' message when tool_registry was None\n\n**Solution:**\n\n1. **Remove hardcoded whitelist** (providers.py):\n   - Revert to optimistic tool binding for Ollama models\n   - Let recovery layer (streaming_orchestrator.py) handle runtime failures\n   - Allows new tool-capable models to work without code changes\n\n2. **Pass tool_registry to system prompts**:\n   - Updated ProfileManager.build_profile_system_prompt() signature to accept tool_registry\n   - Updated ChatSession._build_system_prompt() to extract and pass tool_registry\n   - Tools now properly documented in system prompt for CLI sessions\n\n3. **Fix session_id attribute path** (__main__.py:605):\n   - Changed session.history.session_id \u2192 session.conversation_service.conversation.session_id\n\n**Testing:**\n- \u2705 gpt-oss:20b now sees tools in system prompt\n- \u2705 CLI sessions properly bind and document 12 tools\n- \u2705 Ctrl+C exit shows correct session ID\n- \u2705 Recovery layer still works for models that reject tools at runtime\n\n**Files Changed:**\n- src/consoul/ai/providers.py (supports_tool_calling)\n- src/consoul/tui/services/profile_manager.py (build_profile_system_prompt)\n- src/consoul/cli/chat_session.py (_build_system_prompt)\n- src/consoul/__main__.py (exit handler)",
  "status": "done",
  "type": "bug",
  "priority": "high",
  "labels": [],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-23T23:09:38.266258+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}