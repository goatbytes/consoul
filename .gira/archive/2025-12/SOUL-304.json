{
  "created_at": "2025-12-25T06:42:11.575921Z",
  "updated_at": "2025-12-28T22:17:12.018173Z",
  "id": "SOUL-304",
  "uuid": "8ff38c7a-b783-43b2-a234-ca21537a847e",
  "title": "Implement safe session state serialization for HTTP endpoints",
  "description": "**As a** Consoul backend developer\n**I want** safe JSON serialization for session state\n**So that** I can persist and restore sessions without RCE vulnerabilities\n\n**Context:**\nSOUL-297 (HTTP chat endpoint) is blocked until we define a safe session state format. Currently, the SDK's create_session() function creates isolated Consoul instances but there's no safe way to persist/restore session state across HTTP requests. Using pickle would introduce Remote Code Execution (RCE) vulnerabilities. We need a JSON-based serialization format that safely captures conversation history, tool state, and configuration without executable code.\n\n**Technical Notes:**\n- Referenced in src/consoul/sdk/wrapper.py:81 (create_session function)\n- ConversationHistory in src/consoul/ai/history.py:815 has get_messages_as_dicts() but no restore method\n- Examples in examples/backend/fastapi_sessions.py use in-memory storage, need persistent storage\n- Must handle LangChain BaseMessage types safely (HumanMessage, AIMessage, SystemMessage, ToolMessage)\n- Need to preserve tool call metadata and conversation context\n- Should support concurrent access with per-session locking\n\n**Acceptance Criteria:**\n\n**Given** a Consoul session with conversation history and tool calls\n**When** the session state is serialized to JSON\n**Then** no executable code or pickle data should be included\n\n**Given** a serialized JSON session state\n**When** restored via create_session() or similar method\n**Then** conversation history, system prompt, and configuration should be preserved\n\n**Given** multiple concurrent HTTP requests for the same session\n**When** they attempt to modify session state\n**Then** per-session locking should prevent race conditions\n\n**Given** a session with tool execution history\n**When** serialized and restored\n**Then** tool call IDs, arguments, and results should be preserved without executable payloads\n\n**Testing Considerations:**\n- Unit tests for serialization/deserialization of all message types\n- Security tests to verify no pickle/exec/eval in serialized data\n- Concurrent access tests with multiple threads/processes\n- Integration tests with Redis/database backends\n- Edge cases: empty sessions, large histories, special characters in content\n\n**Implementation Hints:**\n- Create SessionStore protocol in src/consoul/sdk/session_store.py\n- Add to_dict() and from_dict() methods to ConversationHistory class\n- Implement JSONSessionStore with file/Redis/database backends\n- Add restore_session() function alongside create_session()\n- Use threading.Lock or asyncio.Lock for per-session concurrency control\n- Consider using pydantic models for type-safe serialization\n- Reference LangChain's message_to_dict and messages_from_dict helpers",
  "status": "done",
  "type": "task",
  "priority": "critical",
  "labels": [
    "ai",
    "security",
    "backend",
    "session-management"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-12-25T07:00:05.162139Z",
      "updated_at": "2025-12-25T07:00:05.162142Z",
      "id": "20251224230005-6a64593e",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "## P1 Issue: Clarify Safe Serialization Approach\n\n**Problem**: Original description suggests pickling/JSON serializing Consoul objects - this is UNSAFE and fragile.\n\n**Correction**: Only serialize conversation history + config, NOT Consoul objects.\n\n### Safe Serialization Pattern\n\n**What to Serialize** (JSON-safe):\n```python\n# Extract state from active session\nstate = {\n    \"session_id\": console.session_id,\n    \"model\": console.model_name,\n    \"temperature\": console.temperature,\n    \"messages\": console.history.get_messages_as_dicts(),  # LangChain message dicts\n    \"created_at\": time.time(),\n}\n```\n\n**Restoration Path** (missing from description):\n```python\n# Rehydrate session from state\nfrom consoul.sdk import create_session\n\nconsole = create_session(\n    session_id=state[\"session_id\"],\n    model=state[\"model\"],\n    temperature=state[\"temperature\"],\n)\n\n# Restore conversation history\nfrom consoul.ai.history import messages_from_dict  # or to_dict_message\nfor msg_dict in state[\"messages\"]:\n    message = messages_from_dict(msg_dict)\n    console.history.add_message(message)\n```\n\n**API Reference** (src/consoul/ai/history.py):\n- `get_messages_as_dicts()` - Extract messages as JSON-serializable dicts\n- `messages_from_dict()` or `to_dict_message()` - Restore LangChain messages\n- Line references: src/consoul/ai/history.py:815\n\n### Updated Acceptance Criteria\n\n**Given** I have an active session with conversation history\n**When** I serialize the session state\n**Then** only history dicts + config are serialized (NO Consoul object, NO pickle)\n\n**Given** I have serialized session state\n**When** I restore the session via create_session()\n**Then** conversation history is restored and context continues\n\n### Scope Clarification\n\n**In Scope**:\n- JSON serialization of message history (LangChain message dicts)\n- Session config extraction (model, temperature, session_id)\n- Restoration via create_session() + history replay\n- Safe Redis storage (JSON or MessagePack, NOT pickle)\n\n**Out of Scope**:\n- Pickling Consoul objects (UNSAFE - RCE risk)\n- Serializing LangChain clients (not serializable)\n- Serializing locks/callbacks (runtime state)",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-25T08:41:06.527851Z",
      "updated_at": "2025-12-25T08:41:06.527855Z",
      "id": "20251225004106-67e328b0",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "Fixed P2 issue: System prompt duplication in restored sessions.\n\n**Problem**: restore_session() was passing system_prompt to create_session() which added it to history, then restore_from_dicts() added it again from saved messages, causing duplicate system messages in restored conversations.\n\n**Solution**: Modified restore_session() to NOT pass system_prompt to create_session() since it's already included in the saved messages that get restored via restore_from_dicts().\n\n**Verification**: Added regression test test_restore_session_no_duplicate_system_prompt() that verifies:\n- Message count remains identical after save/restore\n- System message count doesn't increase\n- Message content matches exactly\n\nAll 28 tests pass including the new regression test.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-25T19:28:43.574037Z",
      "updated_at": "2025-12-25T19:28:43.574042Z",
      "id": "20251225112843-cbe4be36",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "Fixed second P2 issue: System prompt metadata loss in restored sessions.\n\n**Problem**: After fixing the duplication bug, restore_session() was reading config['system_prompt'] but never applying it to the restored Consoul instance. The _explicit_system_prompt attribute remained None, breaking operations like clear() or config inspection that rely on this metadata.\n\n**Solution**: Modified restore_session() (line 1490-1493) to explicitly set console._explicit_system_prompt after restoring the conversation history. This preserves the metadata without duplicating the message in history.\n\n**Code**:\n```python\n# Restore system prompt metadata (but don't add to history - it's already there)\n# This ensures operations like clear() or config inspection work correctly\nif system_prompt is not None:\n    console._explicit_system_prompt = system_prompt\n```\n\n**Verification**: Added test_restore_session_preserves_system_prompt_metadata() that verifies:\n- Original session has _explicit_system_prompt set\n- System prompt is saved in config\n- Restored session has _explicit_system_prompt correctly set\n- Metadata is available for follow-up operations\n\nAll 29 tests pass (28 + 2 new regression tests).",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-25T19:38:12.123047Z",
      "updated_at": "2025-12-25T19:38:12.123049Z",
      "id": "20251225113812-56d05804",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "Fixed third P2 issue: Tool support loss in restored sessions.\n\n**Problem**: Sessions created with tools=True lost tool functionality after save/restore because:\n1. save_session_state() never recorded tools_enabled configuration\n2. restore_session() hard-coded tools=False\n\n**Solution**:\n1. Updated save_session_state() to capture tools_enabled flag in config\n2. Modified restore_session() to:\n   - Read tools_enabled from saved state\n   - Use saved value by default (tools auto-restored)\n   - Accept optional tools parameter for explicit override\n   - Priority: explicit parameter > saved state > False (safe default)\n\n**Code Changes**:\n```python\n# In save_session_state():\n\"tools_enabled\": getattr(console, \"tools_enabled\", False)\n\n# In restore_session():\ntools_enabled = config.get(\"tools_enabled\", False)\nif tools is not None:\n    restored_tools = tools  # Explicit override\nelif tools_enabled:\n    restored_tools = True  # Restore saved state\nelse:\n    restored_tools = False  # Default safe\n```\n\n**Verification**: Added 3 comprehensive tests:\n- test_restore_session_preserves_tools_enabled() - Tools stay enabled\n- test_restore_session_preserves_tools_disabled() - Tools stay disabled\n- test_restore_session_tools_override() - Parameter overrides saved state\n\nAll 32 tests pass (29 original + 3 new tool tests).",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-25T19:49:34.336115Z",
      "updated_at": "2025-12-25T19:49:34.336118Z",
      "id": "20251225114934-0780ddc2",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "Fixed fourth P2 issue: Configuration loss in restored sessions.\n\n**Problem**: Session persistence only saved model, temperature, system_prompt, and tools_enabled, omitting:\n- Summarization configuration (summarize, summarize_threshold, keep_recent, summary_model)\n- Custom model_kwargs\n\nThis caused restored sessions to revert to defaults, breaking context management and potentially exceeding token budgets.\n\n**Solution**:\n1. Updated save_session_state() to capture complete configuration:\n   - Added summarize, summarize_threshold, keep_recent, summary_model to config\n   - Documented that model_kwargs are not serialized (may contain sensitive data)\n\n2. Updated restore_session() to apply all saved configuration:\n   - Passes summarization settings to create_session()\n   - Ensures functional equivalence between original and restored sessions\n\n**Code Changes**:\n```python\n# In save_session_state() - lines 1357-1364:\n\"config\": {\n    \"system_prompt\": getattr(console, \"_explicit_system_prompt\", None),\n    \"tools_enabled\": getattr(console, \"tools_enabled\", False),\n    \"summarize\": getattr(console, \"_summarize\", False),\n    \"summarize_threshold\": getattr(console, \"_summarize_threshold\", 20),\n    \"keep_recent\": getattr(console, \"_keep_recent\", 10),\n    \"summary_model\": getattr(console, \"_summary_model\", None),\n}\n\n# In restore_session() - lines 1535-1538:\nconsole = create_session(\n    ...\n    summarize=summarize,\n    summarize_threshold=summarize_threshold,\n    keep_recent=keep_recent,\n    summary_model=summary_model,\n)\n```\n\n**Verification**: Added 3 comprehensive tests:\n- test_restore_session_preserves_summarization_config() - Custom settings preserved\n- test_restore_session_default_summarization() - Defaults maintained\n- test_restore_session_complete_config_equivalence() - Full functional equivalence\n\nAll 35 tests pass (32 previous + 3 new configuration tests).",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-25T20:01:39.627823Z",
      "updated_at": "2025-12-25T20:01:39.627826Z",
      "id": "20251225120139-a26081cc",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "Fixed fifth P2 issue: restore_session incompatible with SessionState instances.\n\n**Problem**: SessionState model docs showed passing instances to restore_session(), but implementation only accepted dicts. Following the documented workflow raised TypeError: argument of type SessionState is not iterable.\n\n**Root Cause**: restore_session() checked if field not in state which only works for dict/mapping types, not dataclass instances.\n\n**Solution**: Updated restore_session() to accept both dict and SessionState instances (lines 1489-1502) with type checking and conversion.\n\n**Documentation**: Added examples showing both usage patterns:\n- Direct dict usage (typical)\n- SessionState model usage (as documented)\n\n**Verification**: Added 3 tests:\n- test_restore_session_accepts_dict() - Dict works\n- test_restore_session_accepts_session_state() - SessionState works per docs\n- test_restore_session_rejects_invalid_type() - Invalid types rejected with clear error\n\nAll 38 tests pass (35 previous + 3 new API contract tests).\n\n**API Contract**: restore_session() now correctly implements the documented interface.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-25T21:46:38.149177Z",
      "updated_at": "2025-12-25T21:46:38.149183Z",
      "id": "20251225134638-4e168127",
      "ticket_id": "SOUL-304",
      "author": "jared@goatbytes.io",
      "content": "Fixed sixth P2 issue: AIMessage metadata loss during restoration.\n\n**Problem**: restore_from_dicts() only restored content and tool_calls, discarding critical metadata:\n- additional_kwargs (function_call for OpenAI function calling)\n- response_metadata (model info, finish_reason)\n- usage_metadata (token counts)\n- name (named messages for multi-agent)\n- id (message tracking)\n- invalid_tool_calls (malformed tool calls)\n\nThis broke sessions using OpenAI function calling and multi-agent scenarios.\n\n**Root Cause**: Both to_dict_message() and restore_from_dicts() only preserved minimal fields, causing data loss on round-trip.\n\n**Solution**: \n1. Updated to_dict_message() (lines 146-189) to preserve all metadata fields\n2. Updated restore_from_dicts() (lines 913-953) to restore all fields for each message type\n\n**Preserved Fields**:\n- tool_calls, invalid_tool_calls\n- additional_kwargs (function_call, etc.)\n- response_metadata (model, finish_reason, etc.)\n- usage_metadata (input/output/total tokens)\n- name (multi-agent scenarios)\n- id (message tracking)\n\n**Verification**: Added 3 comprehensive tests:\n- test_restore_from_dicts_preserves_all_metadata() - All fields round-trip\n- test_restore_from_dicts_openai_function_calling() - OpenAI format preserved\n- test_restore_from_dicts_named_messages() - Multi-agent names preserved\n\nAll 41 tests pass (38 previous + 3 new metadata tests).\n\n**Impact**: Sessions with function calling, multi-agent, or detailed metadata now restore faithfully.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 7,
  "story_points": 8,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-30T02:17:01.459092+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}