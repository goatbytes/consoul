{
  "created_at": "2025-12-30T02:05:29.993275Z",
  "updated_at": "2025-12-30T02:50:49.115560Z",
  "id": "SOUL-326",
  "uuid": "ec7f16b1-6898-452e-ada4-8994b5954ece",
  "_version": 1,
  "title": "Enforce request body size limits by default in server factory",
  "description": "**As a** backend developer deploying Consoul servers\n**I want** request body size limits enforced by default\n**So that** the server is protected against denial-of-service attacks via oversized payloads\n\n**Context:**\nThe security checklist (docs/operations/security-checklist.md) documents a 1MB default body limit at line 132-137, but this is NOT enforced by default. The `RequestValidator` class exists in `src/consoul/server/middleware/validation.py` with a `max_body_size` parameter (default: 1MB), but `create_server()` in `src/consoul/server/factory.py` does NOT wire this middleware into the request processing pipeline.\n\nCurrent security gap:\n- FastAPI accepts arbitrarily large request bodies by default (no limit)\n- Only the Pydantic `message` field length (32KB max at `src/consoul/server/models.py:210`) is enforced\n- The `RequestValidator.check_size()` method (line 58-79) properly returns HTTP 413, but is never called\n- Documentation claims protection exists (security-checklist.md:132) when it does not\n\nAttack vectors this enables:\n- Memory exhaustion via multi-GB request bodies\n- CPU exhaustion via JSON parsing of massive payloads\n- Session store DoS via inflated session data\n\nReference similar tools:\n- LangServe enforces body limits via Starlette middleware\n- FastAPI production guides recommend explicit body limits\n\n**Technical Notes:**\nFiles to modify:\n- `src/consoul/server/factory.py` - Wire RequestValidator into middleware stack\n- `src/consoul/server/models.py` - Add ValidationConfig to ServerConfig (lines 648-722)\n- `docs/operations/security-checklist.md` - Update to reflect fix (line 132-137, 394-398)\n\nIntegration approach:\n1. Create `ValidationConfig` Pydantic model with `max_body_size` field\n2. Add `CONSOUL_MAX_BODY_SIZE` environment variable support\n3. Wire `RequestValidator` as Starlette middleware (not per-endpoint) for global enforcement\n4. Ensure health/readiness endpoints are exempt (no body anyway)\n5. Return proper HTTP 413 with structured error response\n\nMiddleware integration pattern (add after CORS, before auth):\n```python\nfrom starlette.middleware.base import BaseHTTPMiddleware\n\nclass BodySizeLimitMiddleware(BaseHTTPMiddleware):\n    async def dispatch(self, request, call_next):\n        validator = RequestValidator(max_body_size=config.validation.max_body_size)\n        await validator.check_size(request)  # Raises HTTPException 413 if too large\n        return await call_next(request)\n\napp.add_middleware(BodySizeLimitMiddleware)\n```\n\nConfiguration model to add to models.py:\n```python\nclass ValidationConfig(BaseSettings):\n    model_config = SettingsConfigDict(populate_by_name=True, extra=\"ignore\")\n    \n    max_body_size: int = Field(\n        default=1024 * 1024,  # 1MB\n        ge=1024,  # Minimum 1KB\n        le=100 * 1024 * 1024,  # Maximum 100MB\n        description=\"Maximum request body size in bytes\",\n        validation_alias=\"CONSOUL_MAX_BODY_SIZE\",\n    )\n```\n\n**Acceptance Criteria:**\n\n**Given** a server created with default configuration\n**When** a POST request with body > 1MB is sent to /chat\n**Then** server returns HTTP 413 with error response: `{\"error\": \"Request too large\", \"message\": \"Request body must be less than 1048576 bytes\", \"limit\": 1048576}`\n\n**Given** CONSOUL_MAX_BODY_SIZE=2097152 (2MB) environment variable set\n**When** a POST request with 1.5MB body is sent to /chat\n**Then** request is accepted and processed normally\n\n**Given** CONSOUL_MAX_BODY_SIZE=512000 (500KB) environment variable set\n**When** a POST request with 600KB body is sent\n**Then** server returns HTTP 413 before JSON parsing (efficient rejection)\n\n**Given** a request to /health or /ready endpoints\n**When** Content-Length header check runs\n**Then** these endpoints still work (no body to validate)\n\n**Given** a malicious client sends request without Content-Length header\n**When** middleware processes the request\n**Then** request body is read and size checked (chunked transfer handling)\n\n**Given** the security checklist documentation\n**When** this fix is deployed\n**Then** line 132-137 is updated to show \"(enforced by default)\" instead of \"(manual setup required)\"\n\n**Testing Considerations:**\nUnit tests (tests/server/test_body_size_limit.py):\n- test_default_body_limit_1mb: Default config enforces 1MB limit\n- test_custom_body_limit_from_env: CONSOUL_MAX_BODY_SIZE env var works\n- test_413_response_format: Error response matches schema\n- test_request_within_limit: Normal requests pass through\n- test_exact_boundary_limit: 1MB exactly is allowed, 1MB+1 byte rejected\n- test_health_endpoints_exempt: /health and /ready work with middleware\n- test_no_content_length_header: Chunked requests still validated\n\nIntegration tests:\n- Mock large POST to /chat endpoint\n- Verify rejection happens BEFORE Pydantic validation (performance)\n- Test with TestClient and actual HTTP headers\n\nEdge cases:\n- Empty Content-Length header (should not crash)\n- Negative Content-Length (should reject)\n- Non-integer Content-Length (should handle gracefully)\n- WebSocket endpoint exclusion (different path)\n\n**Implementation Hints:**\n1. Create ValidationConfig in models.py following RateLimitConfig pattern\n2. Add `validation: ValidationConfig` to ServerConfig\n3. Create middleware class that wraps RequestValidator.check_size()\n4. Add middleware in factory.py lifespan (after CORS, before metrics)\n5. Update security-checklist.md table at line 394 to show \"Yes\" for enforcement\n6. Add tests in tests/server/test_body_size_limit.py\n7. Consider logging warning when very large limits (>10MB) are configured\n8. Ensure WebSocket endpoint (/ws/chat) is handled appropriately (different protocol)\n\nRelated files:\n- src/consoul/server/middleware/validation.py - RequestValidator class (lines 17-165)\n- src/consoul/server/factory.py - create_server() function (lines 136-667)\n- src/consoul/server/models.py - ServerConfig and nested configs (lines 648-722)\n- docs/operations/security-checklist.md - Security documentation (lines 132-137, 388-400)",
  "status": "done",
  "type": "bug",
  "priority": "critical",
  "labels": [
    "security",
    "server",
    "middleware",
    "production"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-016",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 3,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-30T19:52:06.963365+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}