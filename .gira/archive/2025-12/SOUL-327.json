{
  "created_at": "2025-12-30T02:05:37.155561Z",
  "updated_at": "2025-12-31T00:15:34.731846Z",
  "id": "SOUL-327",
  "uuid": "782bbee1-14c4-4999-bc56-50de8fe93e09",
  "_version": 1,
  "title": "Add Terraform validation to CI pipeline",
  "description": "**As a** DevOps engineer maintaining Consoul cloud deployments\n**I want** automated Terraform validation in CI\n**So that** syntax errors, formatting issues, and invalid configurations are caught before merge (preventing P1 bugs like the recent AWS Redis resource type issue)\n\n**Context:**\nCloud deployment configurations exist in `deployment/cloud/{gcp,aws,azure}/` (created in SOUL-301). Each provider directory contains:\n- `main.tf` - Resource definitions (VPC, Redis, container services, IAM, secrets)\n- `variables.tf` - Input variable declarations\n- `outputs.tf` - Output value definitions\n\nCurrently NO CI validation runs on these files. A recent P1 bug was discovered where AWS used an incorrect resource type for Redis, which could have been caught by `terraform validate`. This ticket adds preventive CI checks.\n\nProvider configurations:\n- **AWS**: hashicorp/aws ~> 5.0 (ECS Fargate, ElastiCache, Secrets Manager)\n- **GCP**: hashicorp/google ~> 5.0 (Cloud Run, Memorystore, Secret Manager)  \n- **Azure**: hashicorp/azurerm ~> 3.0 (Container Apps, Azure Cache, Key Vault)\n\nAll configurations require Terraform >= 1.5.\n\n**Technical Notes:**\n- Create: `.github/workflows/terraform.yml`\n- Reference existing CI pattern: `.github/workflows/ci.yml` (lines 1-108)\n- Use `hashicorp/setup-terraform` action for Terraform installation\n- Run validation only when `deployment/cloud/**` files change (path filter)\n- Use `terraform init -backend=false` to initialize providers without state\n- Run `terraform validate` per provider directory (gcp, aws, azure)\n- Run `terraform fmt -check -recursive` for formatting consistency\n- Use matrix strategy to parallelize provider validation\n- No cloud credentials needed (validation is local syntax check)\n- Fail fast on any validation error\n\n**Acceptance Criteria:**\n\n**Given** a PR that modifies `deployment/cloud/aws/main.tf`\n**When** CI runs\n**Then** Terraform validation workflow executes for all three providers\n\n**Given** a Terraform file with syntax errors (e.g., missing closing brace)\n**When** `terraform validate` runs\n**Then** CI fails with clear error message showing file and line number\n\n**Given** a Terraform file with incorrect formatting\n**When** `terraform fmt -check` runs\n**Then** CI fails and indicates which files need formatting\n\n**Given** a PR that only modifies Python source files\n**When** CI runs\n**Then** Terraform validation workflow is skipped (path filter)\n\n**Given** all Terraform files are valid and properly formatted\n**When** CI completes\n**Then** Terraform validation job shows green checkmark\n\n**Testing Considerations:**\n- Manually test workflow by introducing syntax error in main.tf\n- Verify path filter works by modifying only Python files\n- Test that `terraform init -backend=false` works without credentials\n- Verify matrix runs all three providers in parallel\n- Test formatting check catches inconsistent indentation\n- Ensure workflow doesn't require cloud provider credentials\n\n**Implementation Hints:**\n- Use `hashicorp/setup-terraform@v3` action (latest stable)\n- Path filter: `paths: ['deployment/cloud/**']`\n- Matrix strategy for providers: `['gcp', 'aws', 'azure']`\n- Working directory per provider: `deployment/cloud/${{ matrix.provider }}`\n- Init command: `terraform init -backend=false` (skips backend, no credentials needed)\n- Validate command: `terraform validate`\n- Format check: `terraform fmt -check -recursive` (run once at `deployment/cloud/`)\n- Fail-fast: true (stop on first failure)\n- Consider adding `terraform fmt -diff` to show what needs fixing\n- Reference: GitHub Actions Terraform docs for caching terraform plugins\n- Optional: Add TFLint for additional static analysis (future enhancement)\n\nExample workflow structure:\n```yaml\nname: Terraform\non:\n  pull_request:\n    paths: ['deployment/cloud/**']\njobs:\n  validate:\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        provider: [gcp, aws, azure]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: hashicorp/setup-terraform@v3\n      - run: terraform init -backend=false\n        working-directory: deployment/cloud/${{ matrix.provider }}\n      - run: terraform validate\n        working-directory: deployment/cloud/${{ matrix.provider }}\n  format:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: hashicorp/setup-terraform@v3\n      - run: terraform fmt -check -recursive\n        working-directory: deployment/cloud\n```",
  "status": "done",
  "type": "task",
  "priority": "medium",
  "labels": [
    "ci",
    "infrastructure",
    "terraform"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-018",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 2,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2025-12-31T04:59:24.715141+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}