{
  "created_at": "2026-01-01T10:45:35.813851Z",
  "updated_at": "2026-01-02T16:59:11.101971Z",
  "id": "SOUL-356",
  "uuid": "c40e3e92-2dd3-47a6-8077-2abe49a58db7",
  "_version": 2,
  "title": "Fix ChatSession.history AttributeError in cost display code",
  "description": "**As a** Consoul CLI user\n**I want** the `consoul ask --cost` command to properly access conversation messages\n**So that** I can see estimated cost information without runtime errors\n\n**Context:**\nIn `src/consoul/__main__.py` lines 1024-1027, the code references `session.history` but the `ChatSession` class (defined in `src/consoul/cli/chat_session.py`) does not have a `history` attribute. This is confirmed by mypy:\n\n```\nsrc/consoul/__main__.py:1024: error: \"ChatSession\" has no attribute \"history\"  [attr-defined]\nsrc/consoul/__main__.py:1025: error: \"ChatSession\" has no attribute \"history\"  [attr-defined]\nsrc/consoul/__main__.py:1027: error: \"ChatSession\" has no attribute \"history\"  [attr-defined]\n```\n\nThis is a leftover bug similar to one fixed in v0.4.2 (SOUL-291), which corrected `session.history.session_id` to `session.conversation_service.conversation.session_id`. The v0.4.2 fix was partial - this cost display code path was missed.\n\nThe correct attribute path is `session.conversation_service.conversation.messages`, as:\n- `ChatSession.conversation_service` -> `ConversationService` (line 95 of chat_session.py)\n- `ConversationService.conversation` -> `ConversationHistory` (line 128 of conversation.py)\n- `ConversationHistory.messages` -> `list[BaseMessage]` (line 203 of history.py)\n\n**Technical Notes:**\n- Bug location: `src/consoul/__main__.py` lines 1024-1027\n- ChatSession class: `src/consoul/cli/chat_session.py` (no `history` attribute)\n- Correct path: `session.conversation_service.conversation.messages`\n- The ConversationHistory class stores messages with `usage_metadata` from LangChain responses\n- This code is wrapped in try/except so it fails silently, making it hard to detect\n\n**Acceptance Criteria:**\n\n**Given** a user runs `consoul ask \"test\" --cost`\n**When** the AI responds successfully\n**Then** the cost display code accesses messages via the correct path without AttributeError\n\n**Given** the conversation has messages with `usage_metadata`\n**When** the cost display logic runs\n**Then** it extracts token counts and displays estimated cost\n\n**Given** the conversation has no usage metadata\n**When** the cost display logic runs\n**Then** it silently skips cost display (existing behavior, no error)\n\n**Given** mypy is run on `src/consoul/__main__.py`\n**When** checking the cost display code section\n**Then** no `attr-defined` errors are reported for `session.history`\n\n**Testing Considerations:**\n- Run `mypy src/consoul/__main__.py` and verify no `session.history` errors\n- Manually test `consoul ask \"Hello\" --cost` and verify no AttributeError in logs\n- Unit test: Mock ChatSession with proper conversation_service.conversation.messages path\n- Verify cost calculation still works when usage_metadata is present\n\n**Implementation Hints:**\n- Replace `session.history` with `session.conversation_service.conversation`\n- Lines to modify in `src/consoul/__main__.py`:\n  - Line 1024: `hasattr(session.history, \"messages\")` -> `hasattr(session.conversation_service.conversation, \"messages\")`\n  - Line 1025: `session.history.messages` -> `session.conversation_service.conversation.messages`\n  - Line 1027: `session.history.messages[-1]` -> `session.conversation_service.conversation.messages[-1]`\n- Reference the v0.4.2 fix in CHANGELOG.md for precedent (SOUL-291 fixed a similar issue)\n- Consider adding a helper property `ChatSession.messages` that returns `self.conversation_service.conversation.messages` to simplify future access",
  "status": "done",
  "type": "bug",
  "priority": "high",
  "labels": [
    "cli",
    "bug"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 2,
  "order": 0,
  "custom_fields": {},
  "_archive_metadata": {
    "archived_at": "2026-01-02T22:23:58.540386+00:00",
    "archived_from_status": "done",
    "archived_by": "gira-cli"
  }
}