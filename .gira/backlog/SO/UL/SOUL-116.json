{
  "created_at": "2025-11-15T00:46:53.700939",
  "updated_at": "2025-11-16T16:17:28.238389Z",
  "id": "SOUL-116",
  "uuid": "abbb3078-0d78-447d-8a7c-e0d10aca2d8d",
  "title": "Add TUI support for image references in messages",
  "description": "**As a** Consoul user\n**I want** to reference images in my chat messages using intuitive syntax\n**So that** I can analyze images without complex commands\n\n**Context:**\nUsers should be able to reference images naturally in their messages:\n- \"What's wrong with this error? screenshot.png\"\n- \"Compare these designs: ui_v1.png ui_v2.png\"\n- \"Analyze [diagram.png] and explain the flow\"\n\nThe TUI should detect image references, validate them, and trigger the analyze_images tool automatically.\n\n**Technical Notes:**\n- src/consoul/tui/screens/chat.py - Message input handling\n- src/consoul/tui/widgets/message.py - Message rendering\n- Detect image paths/references in user input\n- Support relative paths (./image.png) and absolute paths\n- Visual indicators for images in message bubbles\n- Show [Image: filename.png] placeholder or thumbnail\n- Consider Rich's Image protocol for terminal image preview (optional)\n- Textual message composition area\n\n**Acceptance Criteria:**\n\n**Given** I type \"Explain this error screenshot.png\" in the chat input\n**When** I press Enter\n**Then** the TUI detects \"screenshot.png\" as an image reference\n\n**Given** an image reference is detected\n**When** the message is sent\n**Then** analyze_images tool is invoked with the query and image path(s)\n\n**Given** I reference a non-existent image \"missing.png\"\n**When** the message is processed\n**Then** I get immediate validation error before LLM invocation\n\n**Given** a message contains multiple images \"img1.png img2.png\"\n**When** parsed\n**Then** both images are extracted and passed to analyze_images\n\n**Given** the AI responds to an image analysis query\n**When** the response is rendered\n**Then** the original image reference is shown with visual indicator\n\n**Testing Considerations:**\n- Test image path detection regex/parsing\n- Test relative vs absolute path handling\n- Test multiple images in one message\n- Mock tool invocation in TUI tests\n- Test error display for invalid images\n- Verify message history includes image references\n\n**Implementation Hints:**\n```python\nimport re\nfrom pathlib import Path\n\ndef extract_image_references(message: str) -> tuple[str, list[str]]:\n    \"\"\"Extract image paths from message text.\n    \n    Returns:\n        (cleaned_message, image_paths)\n    \"\"\"\n    # Pattern: .png, .jpg, etc. files\n    pattern = r'\\S+\\.(png|jpg|jpeg|gif|webp)\\b'\n    matches = re.findall(pattern, message, re.IGNORECASE)\n    \n    image_paths = []\n    for match in matches:\n        path = Path(match).resolve()\n        if path.exists() and path.is_file():\n            image_paths.append(str(path))\n    \n    # Clean message text (optional: remove image refs)\n    cleaned = message\n    for path in image_paths:\n        cleaned = cleaned.replace(path, f\"[Image: {Path(path).name}]\")\n    \n    return cleaned, image_paths\n\n# In message rendering\ndef render_message_with_images(message: MessageModel) -> Widget:\n    if message.image_paths:\n        # Show image indicators\n        image_widgets = [\n            Static(f\"ðŸ“· {Path(p).name}\") \n            for p in message.image_paths\n        ]\n        return Vertical(\n            Markdown(message.content),\n            *image_widgets\n        )\n    else:\n        return Markdown(message.content)\n```\n\nFiles to modify:\n- src/consoul/tui/screens/chat.py\n- src/consoul/tui/widgets/message.py\n- tests/tui/test_image_references.py\n\nDependencies: SOUL-115 (tool must be registered)",
  "status": "backlog",
  "type": "feature",
  "priority": "medium",
  "labels": [
    "tui",
    "enhancement",
    "ux-improvement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-007",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}