{
  "created_at": "2025-11-14T22:31:19.391492",
  "updated_at": "2025-11-15T08:49:49.053809Z",
  "id": "SOUL-106",
  "uuid": "ac2abe71-e300-44c1-aa47-e85397b9ca3a",
  "title": "Add progressive matching for search/replace editing",
  "description": "**As a** Consoul AI agent\n**I want** search/replace editing with fuzzy matching tolerance\n**So that** I can edit files even when whitespace or indentation differs from what I remember\n\n**Context:**\nWhile line-based editing (SOUL-104) works when LLM knows exact line numbers, search/replace is more robust for:\n- Files that changed since last read\n- Uncertain about exact location\n- Whitespace/indentation variations\n\nResearch shows two patterns:\n- aider: Strict SEARCH/REPLACE with excellent error messages\n- wcgw: Fuzzy matching with tolerance levels (strict → whitespace → fuzzy)\n\nRecommended approach: Progressive matching (try strict first, fall back with warnings)\n\nSee research:\n- wcgw: src/wcgw/client/file_ops/diff_edit.py (tolerance system)\n- aider: aider/coders/editblock_coder.py (strict matching + suggestions)\n\n**Technical Notes:**\n- Add to src/consoul/ai/tools/implementations/file_edit.py\n- Create src/consoul/ai/tools/implementations/file_matching.py for matching algorithms\n- Implement 3 matching strategies:\n  1. exact_match() - No tolerance\n  2. whitespace_tolerant_match() - Ignore leading/trailing whitespace\n  3. fuzzy_match() - Similarity scoring with difflib.SequenceMatcher\n- Add \"Did you mean lines X-Y?\" suggestions when no match found\n- Auto-fix indentation when whitespace-tolerant match used\n- Return confidence score and warnings in FileEditResult\n\nMatching algorithm (progressive):\n```python\ndef match_search_block(content_lines, search_lines, tolerance):\n    # Try exact match first\n    matches = exact_match(content_lines, search_lines)\n    if matches:\n        return matches, [], 1.0  # No warnings, 100% confidence\n    \n    # Try whitespace-tolerant\n    if tolerance in [\"whitespace\", \"fuzzy\"]:\n        matches = whitespace_match(content_lines, search_lines)\n        if matches:\n            return matches, [\"Matched ignoring indentation\"], 0.95\n    \n    # Try fuzzy\n    if tolerance == \"fuzzy\":\n        matches = fuzzy_match(content_lines, search_lines)\n        if matches:\n            similarity = calculate_similarity(...)\n            return matches, [f\"Fuzzy matched ({similarity:.0%} confidence)\"], similarity\n    \n    # No match - find similar blocks for suggestions\n    similar = find_similar_blocks(content_lines, search_lines)\n    raise NoMatchError(f\"Did you mean lines {similar.start}-{similar.end}?\")\n```\n\nFiles to create:\n- src/consoul/ai/tools/implementations/file_matching.py\n\nFiles to modify:\n- src/consoul/ai/tools/implementations/file_edit.py\n\n**Acceptance Criteria:**\n\n**Given** I search for exact text\n**When** exact match exists\n**Then** replacement succeeds with 100% confidence, no warnings\n\n**Given** I search for text with different indentation\n**When** tolerance=\"whitespace\"\n**Then** match succeeds with warning \"Matched ignoring indentation\" and indentation auto-fixed\n\n**Given** I search for text with 85% similarity\n**When** tolerance=\"fuzzy\"\n**Then** match succeeds with warning \"Fuzzy matched (85% confidence)\"\n\n**Given** no match found and similar blocks exist\n**When** search fails\n**Then** error message includes \"Did you mean lines 15-20?\" with context preview\n\n**Given** multiple ambiguous matches (same text appears twice)\n**When** search executes\n**Then** error lists all match locations and asks user to be more specific\n\n**Testing Considerations:**\n- Unit tests for each matching strategy\n- Test indentation auto-fix (preserve relative indentation)\n- Test similarity scoring accuracy\n- Test \"did you mean\" suggestion quality\n- Test ambiguous match detection\n- Performance tests on large files (1000+ lines)\n\n**Implementation Hints:**\n- Use difflib.SequenceMatcher for similarity scoring\n- For whitespace tolerance: compare line.strip() or line.lstrip()\n- For fuzzy matching: ratio > 0.8 is good threshold\n- Use context lines (±3) for \"did you mean\" snippets\n- Cache similarity scores to avoid recomputation\n\n```python\n@tool\ndef edit_file_search_replace(\n    file_path: str,\n    edits: List[Dict[str, str]],  # [{\"search\": \"...\", \"replace\": \"...\"}]\n    tolerance: Literal[\"strict\", \"whitespace\", \"fuzzy\"] = \"strict\",\n    dry_run: bool = False,\n) -> str:\n    \"\"\"Edit file using search/replace blocks.\"\"\"\n```\n\nDependencies: SOUL-104 (core EditEngine)",
  "status": "done",
  "type": "feature",
  "priority": "medium",
  "labels": [
    "file-edit",
    "enhancement",
    "matching"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-005",
  "blocked_by": [
    "SOUL-104"
  ],
  "blocks": [
    "SOUL-108",
    "SOUL-109",
    "SOUL-111"
  ],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 8,
  "order": 0,
  "custom_fields": {}
}