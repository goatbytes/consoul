{
  "created_at": "2025-11-23T19:50:40.955834",
  "updated_at": "2025-11-24T20:09:48.920867Z",
  "id": "SOUL-156",
  "uuid": "86cf5047-3295-4df1-b5ce-fc358fe59e5f",
  "title": "Add risk_filter field to ToolConfig for risk-based tool filtering",
  "description": "**As a** Consoul user\n**I want** a risk_filter config option to enable tools by risk level\n**So that** I can easily configure \"safe only\" or \"safe + caution\" tool sets\n\n**Context:**\nUsers commonly want to filter tools by risk level (SAFE, CAUTION, DANGEROUS, BLOCKED). Currently, they must list individual tool names in allowed_tools. A risk_filter field provides a simpler alternative for common security postures.\n\nThis complements allowed_tools (explicit list) with a coarse-grained filter.\n\n**Technical Notes:**\n- src/consoul/config/models.py:1159-1272 - Add new field to ToolConfig\n- New field: risk_filter: Literal[\"safe\", \"caution\", \"dangerous\"] | None = None\n- Uses existing get_tools_by_risk_level() from src/consoul/ai/tools/catalog.py:88-120\n- Precedence: allowed_tools > risk_filter > default (all tools)\n- If both allowed_tools and risk_filter set, allowed_tools wins\n- None = no risk filtering (use allowed_tools or all tools)\n\nRisk levels defined in src/consoul/ai/tools/base.py:30-33:\n- SAFE: Read-only operations (grep, code_search, web_search, etc.)\n- CAUTION: File operations and command execution\n- DANGEROUS: Destructive operations (delete_file)\n- BLOCKED: Explicitly prohibited\n\n**Acceptance Criteria:**\n\n**Given** I set risk_filter = \"safe\" in config\n**When** TUI or SDK initializes\n**Then** only SAFE risk level tools are registered\n\n**Given** I set risk_filter = \"caution\" in config  \n**When** tools are registered\n**Then** SAFE + CAUTION tools are registered (excludes DANGEROUS)\n\n**Given** I set both allowed_tools and risk_filter in config\n**When** tools are registered\n**Then** allowed_tools takes precedence (risk_filter is ignored)\n\n**Given** I set risk_filter = None (or omit field)\n**When** tools are registered\n**Then** allowed_tools or all tools are used (backward compatible)\n\n**Testing Considerations:**\n- Test each risk level value\n- Test precedence (allowed_tools wins)\n- Test backward compatibility (None or omitted)\n- Validate Pydantic schema\n- Test with TUI and SDK\n\n**Implementation Hints:**\n1. Add field to ToolConfig:\n   ```python\n   risk_filter: Literal[\"safe\", \"caution\", \"dangerous\"] | None = Field(\n       default=None,\n       description=\"Filter tools by risk level. None = no filtering. \"\n                   \"Use 'safe' for read-only tools, 'caution' for safe+caution, \"\n                   \"'dangerous' for all tools. Ignored if allowed_tools is set.\",\n   )\n   ```\n2. Update tool resolution logic:\n   ```python\n   if consoul_config.tools.allowed_tools:\n       # Explicit list wins\n       tools_to_register = resolve_allowed_tools()\n   elif consoul_config.tools.risk_filter:\n       # Risk-based filtering\n       tools_to_register = get_tools_by_risk_level(consoul_config.tools.risk_filter)\n   else:\n       # Default: all tools\n       tools_to_register = all_tools()\n   ```\n3. Document in config sample and user guide\n4. Update TOML schema examples\n\n**Dependencies:**\n- SOUL-154 (Use allowed_tools for registration)",
  "status": "review",
  "type": "feature",
  "priority": "medium",
  "labels": [
    "config",
    "tools",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-23T21:01:35.659896",
      "updated_at": "2025-11-23T21:01:35.659897",
      "id": "20251123210135-0ceafde3",
      "ticket_id": "SOUL-156",
      "author": "jared@goatbytes.io",
      "content": "Implementation complete with TUI-only scope.\n\n**Current State:**\n- ✅ risk_filter field added to ToolConfig\n- ✅ TUI honors risk_filter for tool registration\n- ✅ Precedence logic: allowed_tools > risk_filter > all tools\n- ✅ Documentation updated with examples\n- ✅ Critical safety fix: empty allowed_tools prevents approval bypass\n- ✅ Documentation clarified: TUI-only limitation\n\n**TUI-Only Limitation:**\nrisk_filter is currently only implemented in TUI (src/consoul/tui/app.py:381-410).\nSDK and CLI commands do NOT honor this setting because:\n- SDK uses 'tools' parameter in __init__ for tool resolution\n- SDK creates standalone ToolConfig, doesn't consult config.tools.risk_filter\n- Different architectures = different mechanisms\n\n**SDK Equivalent:**\nUsers can achieve same functionality in SDK via tools parameter:\n```python\nconsole = Consoul(tools=\"safe\")      # Only SAFE tools\nconsole = Consoul(tools=\"caution\")   # SAFE + CAUTION tools\nconsole = Consoul(tools=\"dangerous\") # All tools\n```\n\n**Follow-up Work:**\nConsider creating ticket for SDK support:\n- Option 1: Make SDK consult config.tools.risk_filter\n- Option 2: Keep separate (SDK=explicit param, TUI=config-driven)\n- Document architectural decision in ADR\n\n**Commits:**\n- bc887ee: Initial SOUL-154 (dynamic tool registration)\n- 205b033: Fix execution whitelist normalization\n- c9dd480: Initial SOUL-156 (add risk_filter field)\n- d7f8796: Security fix (don't populate allowed_tools)\n- b6460de: Revert (broken - caused approval bypass)\n- f8b3829: Critical safety fix (prevent approval bypass)\n- e6daa6d: Documentation fix (clarify TUI-only)",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 1,
  "story_points": 2,
  "order": 2,
  "custom_fields": {},
  "epic": "EPIC-008"
}