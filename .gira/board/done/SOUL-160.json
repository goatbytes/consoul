{
  "created_at": "2025-11-23T19:52:16.538425",
  "updated_at": "2025-11-24T12:36:53.951689",
  "id": "SOUL-160",
  "uuid": "f1408f1e-1a96-40e8-94b1-cd6cda54322a",
  "title": "Add persist-to-config option for Tool Manager changes",
  "description": "**As a** Consoul TUI user\n**I want** to save Tool Manager changes to my config file\n**So that** my tool preferences persist across sessions\n\n**Context:**\nCurrently, Tool Manager changes (SOUL-158) are session-only. Power users may want to persist their tool selections to config without manually editing the TOML file.\n\nThis adds a \"Save to Config\" action to Tool Manager that writes the current tool selection to config.toml as allowed_tools.\n\n**Technical Notes:**\n- Add action to Tool Manager screen (SOUL-158)\n- Write to ~/.consoul/config.toml (or project .consoul.yaml)\n- Update [tools].allowed_tools with current enabled tool list\n- Preserve other config settings (don't overwrite entire file)\n- Use TOML library for safe editing (tomlkit for preserving comments/formatting)\n- Show confirmation message after save\n- Optional: Add \"Save as Preset\" to create custom preset\n\n**Acceptance Criteria:**\n\n**Given** I'm in Tool Manager with modified tool selection\n**When** I press Ctrl+S (Save to Config)\n**Then** allowed_tools in config.toml is updated with current selection\n\n**Given** config.toml has other settings\n**When** I save Tool Manager changes\n**Then** only allowed_tools is updated (other settings preserved)\n\n**Given** I save Tool Manager changes\n**When** I restart TUI\n**Then** saved tool selection is loaded\n\n**Given** I save Tool Manager changes\n**When** save completes\n**Then** I see confirmation: \"Tool selection saved to config\"\n\n**Testing Considerations:**\n- Test config file writing\n- Test preservation of other settings\n- Test TOML formatting preservation\n- Test error handling (file permissions, invalid path)\n- Verify saved config loads correctly\n- Test with both global and project configs\n\n**Implementation Hints:**\n1. Add keybinding to Tool Manager:\n   ```python\n   (\"ctrl+s\", \"save_to_config\", \"Save to Config\"),\n   ```\n2. Use tomlkit for safe TOML editing:\n   ```python\n   import tomlkit\n   \n   def action_save_to_config(self):\n       enabled_tools = [\n           meta.name for meta in self.app.tool_registry.list_tools(enabled_only=True)\n       ]\n       \n       config_path = Path.home() / \".consoul\" / \"config.toml\"\n       with open(config_path) as f:\n           doc = tomlkit.load(f)\n       \n       if \"tools\" not in doc:\n           doc[\"tools\"] = {}\n       doc[\"tools\"][\"allowed_tools\"] = enabled_tools\n       \n       with open(config_path, \"w\") as f:\n           tomlkit.dump(doc, f)\n       \n       self.app.notify(\"Tool selection saved to config\")\n   ```\n3. Handle edge cases (file doesn't exist, no [tools] section)\n4. Add confirmation dialog (optional)\n5. Document in Tool Manager help text\n\n**Future Enhancement:**\n- Add \"Save as Preset\" to create custom named preset\n- Support saving to project-level .consoul.yaml\n\n**Dependencies:**\n- SOUL-158 (Tool Manager screen must exist)\n- SOUL-154 (Config-based tool registration)",
  "status": "done",
  "type": "feature",
  "priority": "low",
  "labels": [
    "tui",
    "config",
    "tools",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-11-24T12:16:14.591003",
      "updated_at": "2025-11-24T12:16:14.591004",
      "id": "20251124121614-99cb3727",
      "ticket_id": "SOUL-160",
      "author": "jared@goatbytes.io",
      "content": "Completed persist-to-config feature for Tool Manager. Features:\n\n✅ Ctrl+S keybinding added to Tool Manager\n✅ action_save_to_config() method implemented\n✅ Help text updated to show Ctrl+S shortcut\n✅ Saves to project config (.consoul/config.yaml) if exists\n✅ Falls back to global config (~/.consoul/config.yaml)\n✅ Creates new global config if none exists\n✅ User-friendly confirmation notification\n✅ Error handling with error notification\n✅ Preserves all other config settings\n\nImplementation:\n- Added Ctrl+S binding to BINDINGS list\n- Implemented save method using existing save_config() from config/loader.py\n- Gets enabled tools from pending changes or current registry state\n- Respects config precedence: project > global > new global\n- Shows success message: \"Tool selection saved to config.yaml\"\n- Logs save operation for debugging\n- Handles exceptions gracefully\n\nUsage workflow:\n1. Press Ctrl+T to open Tool Manager\n2. Toggle tools on/off (Space/T)\n3. Press Ctrl+S to save to config\n4. See confirmation notification\n5. Restart TUI - saved selection loads automatically\n\nTechnical notes:\n- Uses YAML config files (not TOML)\n- Stores tool.name format (e.g., \"bash_execute\")\n- Leverages existing config infrastructure\n- Single file change: tool_manager_screen.py\n\nAll acceptance criteria met. Ready for user testing.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-11-24T12:23:39.260896",
      "updated_at": "2025-11-24T12:23:39.260897",
      "id": "20251124122339-8820840f",
      "ticket_id": "SOUL-160",
      "author": "jared@goatbytes.io",
      "content": "Bug fix: Added missing append_to_file alias\n\nIssue discovered during testing:\n- User saved tool selection via Ctrl+S (worked ✓)\n- User restarted TUI\n- Tool Manager showed \"Tool registry not initialized\" error (✗)\n\nRoot cause:\n- Tool Manager saves tools using tool.name format (e.g., 'append_to_file')\n- On restart, config loader calls get_tool_by_name() to resolve each tool\n- get_tool_by_name() checks TOOL_CATALOG, then TOOL_ALIASES\n- 'append_to_file' was missing from both (catalog uses 'append_file' as key)\n- Failed lookup caused ValueError, prevented tool registry initialization\n\nFix (commit d4b1e4d):\n- Added 'append_to_file' -> 'append_file' mapping to TOOL_ALIASES\n- Added clarifying comment about alias purpose\n- All 12 tools from saved config now resolve correctly\n\nFiles changed:\n- src/consoul/ai/tools/catalog.py\n\nTesting verified:\n✓ All tool.name values from config now resolve\n✓ append_to_file specifically tested and working\n✓ Config save/load cycle now works end-to-end\n\nUser should now be able to:\n1. Open Tool Manager (Ctrl+T)\n2. Toggle tools and save with Ctrl+S\n3. Restart TUI\n4. See Tool Manager with saved selection loaded",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-11-24T12:36:53.951620",
      "updated_at": "2025-11-24T12:36:53.951621",
      "id": "20251124123653-65d2677f",
      "ticket_id": "SOUL-160",
      "author": "jared@goatbytes.io",
      "content": "Second bug fix: Tool Manager now shows all available tools\n\nIssue discovered during testing:\n- User saved config with 12 tools enabled (missing wikipedia)\n- User opened Tool Manager to enable wikipedia\n- wikipedia was not visible in the list (✗)\n- Only the 12 tools from allowed_tools were shown\n\nRoot cause:\n- Tool initialization only registered tools from allowed_tools\n- Tool Manager showed only registered tools\n- Result: Tools not in allowed_tools were invisible, couldn't be enabled via UI\n\nFix (commit 215752a):\n- Changed initialization to ALWAYS register ALL 13 tools from catalog\n- Set enabled=True for tools in allowed_tools, enabled=False for others\n- Tool Manager now shows complete tool list with correct state\n- Users can now enable/disable any tool, then Ctrl+S to save\n\nChanges made:\n1. Separated tool registration from tool enablement:\n   - all_tools = TOOL_CATALOG.values() (13 tools)\n   - enabled_tool_names = set based on config (allowed_tools/risk_filter/default)\n   - Register all tools with is_enabled=(tool.name in enabled_tool_names)\n\n2. Updated logic for all config modes:\n   - allowed_tools: enables specified tools, disables others\n   - risk_filter: enables tools matching risk level, disables others\n   - default: enables all tools\n\n3. Fixed tools_total display to show total registered (13)\n\nFiles changed:\n- src/consoul/tui/app.py\n\nBenefits:\n✓ Tool Manager shows complete list of 13 available tools\n✓ Tools show correct enabled/disabled state from config\n✓ Users can enable previously-disabled tools via UI\n✓ Ctrl+S persists the updated selection\n✓ Wikipedia and other tools are now discoverable\n\nUser workflow now works end-to-end:\n1. Open Tool Manager (Ctrl+T)\n2. See ALL 13 tools with current enabled state\n3. Toggle any tool on/off\n4. Ctrl+S to save\n5. Restart - saved selection loads correctly",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 3,
  "story_points": 3,
  "order": 7,
  "custom_fields": {},
  "epic": "EPIC-008"
}