{
  "created_at": "2025-12-02T10:07:07.332610",
  "updated_at": "2025-12-02T10:22:41.507443",
  "id": "SOUL-204",
  "uuid": "702fc6f8-3fe8-48bb-bb83-bd6c12a4c8d2",
  "title": "Inject terminal environment context into AI conversations",
  "description": "**As a** Consoul CLI user\n**I want** automatic terminal context injected into my conversations\n**So that** the AI understands my working environment without me having to explain it\n\n**Context:**\nWhen using `consoul ask` or `consoul chat`, the AI doesn't automatically know important context like:\n- Current working directory\n- Operating system and shell\n- Git repository information (branch, status, remote)\n- Available tools and their capabilities\n- User's timezone/locale\n\nThe config already has `include_system_info` and `include_git_info` flags in the context settings (src/consoul/config/models.py:475-482), but they're not currently being used to inject this information.\n\nSimilar tools handle this well:\n- **aider**: Includes repo map, git status, and file context\n- **Claude Code**: Provides extensive environment context in `<env>` tags\n- **shell-gpt**: Includes OS, shell, and working directory\n\n**Technical Notes:**\n- Context flags exist: `profile.context.include_system_info` and `profile.context.include_git_info`\n- System prompts use `{AVAILABLE_TOOLS}` placeholder (profiles.py:35)\n- System message set via `history.add_system_message()` (ai/history.py:485)\n- Need to expand system prompt with environment context when flags are True\n- Consider adding `{ENVIRONMENT}` placeholder to system_prompt template\n\n**Proposed Context Sections:**\n\n**System Info** (`include_system_info=True`):\n```\n## Environment\n- OS: macOS 15.1.1 (Darwin 24.6.0)\n- Shell: zsh 5.9\n- Working Directory: /Users/jared/Development/project\n- User: jared\n- Date: 2025-12-02 08:45 PST\n```\n\n**Git Info** (`include_git_info=True`):\n```\n## Git Repository\n- Repository: https://github.com/org/repo\n- Branch: feature/new-command\n- Status: modified (3 files)\n- Last Commit: abc1234 - \"Add feature X\"\n- Remote: origin (2 commits ahead)\n```\n\n**Tool Context** (already handled via `{AVAILABLE_TOOLS}`):\n```\n## Available Tools\nYou have access to these tools:\n- bash_execute: Execute shell commands\n- read_file: Read file contents\n- code_search: Search code with grep\n...\n```\n\n**Acceptance Criteria:**\n\n**Given** I have default profile with `include_system_info=True`\n**When** I run `consoul ask \"What directory am I in?\"`\n**Then** the system prompt includes working directory and OS info\n\n**Given** I'm in a git repository with `include_git_info=True`\n**When** I ask a coding question\n**Then** the AI knows the current branch and repo context\n\n**Given** I set `include_system_info=False` in my profile\n**When** I start a conversation\n**Then** no system/environment info is included in the prompt\n\n**Given** I'm using `consoul ask` for quick questions\n**When** working directory changes between invocations\n**Then** each invocation gets fresh context for current directory\n\n**Given** tools are enabled\n**When** system prompt is generated\n**Then** the `{AVAILABLE_TOOLS}` placeholder is replaced with tool documentation\n\n**Testing Considerations:**\n- Test with/without git repository\n- Test with system_info and git_info flags on/off\n- Test working directory context updates\n- Test on different operating systems (macOS, Linux)\n- Verify context doesn't include sensitive info (API keys, secrets)\n- Test that context stays within reasonable token limits\n- Mock git commands for unit tests\n\n**Implementation Hints:**\n\n1. Create `src/consoul/ai/context.py`:\n```python\ndef get_system_context(\n    include_system_info: bool = True,\n    include_git_info: bool = True,\n) -> str:\n    \"\"\"Generate environment context for system prompt.\"\"\"\n    sections = []\n\n    if include_system_info:\n        sections.append(_get_system_info())\n\n    if include_git_info:\n        sections.append(_get_git_info())\n\n    return \"\\n\\n\".join(sections)\n\ndef _get_system_info() -> str:\n    \"\"\"Get system information section.\"\"\"\n    import platform\n    import os\n    from datetime import datetime\n\n    return f\"\"\"## Environment\n- OS: {platform.system()} {platform.release()}\n- Shell: {os.environ.get('SHELL', 'unknown')}\n- Working Directory: {os.getcwd()}\n- Date: {datetime.now().strftime('%Y-%m-%d %H:%M %Z')}\"\"\"\n\ndef _get_git_info() -> str:\n    \"\"\"Get git repository information.\"\"\"\n    # Check if in git repo\n    # Use subprocess to get branch, status, remote\n    # Return formatted section\n```\n\n2. Update system prompt injection (likely in ChatSession or ConversationHistory):\n```python\n# In ChatSession.__init__ or similar\nsystem_prompt = profile.system_prompt\n\n# Inject environment context if enabled\nif profile.context.include_system_info or profile.context.include_git_info:\n    from consoul.ai.context import get_system_context\n    env_context = get_system_context(\n        include_system_info=profile.context.include_system_info,\n        include_git_info=profile.context.include_git_info,\n    )\n    system_prompt = f\"{env_context}\\n\\n{system_prompt}\"\n\n# Replace tool placeholders\nif \"{AVAILABLE_TOOLS}\" in system_prompt and tool_registry:\n    tool_docs = tool_registry.get_tool_documentation()\n    system_prompt = system_prompt.replace(\"{AVAILABLE_TOOLS}\", tool_docs)\n\nself.history.add_system_message(system_prompt)\n```\n\n3. Update profile system prompts to reference context:\n```python\n\"system_prompt\": (\n    \"You are a helpful AI assistant with access to powerful tools.\\n\\n\"\n    \"# Context\\n\"\n    \"The environment information above provides details about the user's \"\n    \"working directory, git repository, and available tools. Use this context \"\n    \"to provide more relevant and accurate assistance.\\n\\n\"\n    \"{AVAILABLE_TOOLS}\\n\\n\"\n    \"# Guidelines\\n\"\n    \"- Use markdown formatting for terminal rendering\\n\"\n    \"- Avoid unnecessary preamble or postamble\\n\"\n    \"- Check existing conventions and mimic established style\\n\"\n),\n```\n\n**Files to create/modify:**\n- src/consoul/ai/context.py (new) - Environment context generation\n- src/consoul/cli/chat_session.py - Inject context into system prompt\n- src/consoul/config/profiles.py - Update system prompts to reference context\n- tests/ai/test_context.py (new) - Test context generation\n- docs/user-guide/configuration.md - Document context settings\n\n**Security Considerations:**\n- Don't include API keys or secrets in context\n- Be careful with sensitive repo information\n- Consider adding `exclude_patterns` config for sensitive directories\n- Limit context to prevent token bloat\n\n**Dependencies:**\n- ChatSession implementation (already exists)\n- Profile system (already exists)\n- Context config flags (already exist, just unused)\n\n**Story Points:** 5 (medium - requires new module, integration, and testing)\n**Labels:** ai, enhancement, cli, ux-improvement",
  "status": "done",
  "type": "feature",
  "priority": "medium",
  "labels": [
    "ai",
    "enhancement",
    "cli",
    "ux-improvement"
  ],
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [
    {
      "created_at": "2025-12-02T10:17:31.770637",
      "updated_at": "2025-12-02T10:17:31.770638",
      "id": "20251202101731-96153fee",
      "ticket_id": "SOUL-204",
      "author": "jared@goatbytes.io",
      "content": "Implementation completed successfully!\n\n## What was implemented:\n\n### 1. Environment Context Module (src/consoul/ai/environment.py)\nCreated new module with:\n- `get_environment_context()` - Main entry point\n- `_get_system_info()` - Collects OS, shell, working directory, date/time\n- `_get_git_info()` - Collects git repository info (branch, status, remote, last commit)\n- Smart error handling (silent failures, timeouts for git commands)\n- Platform-specific formatting (macOS, Linux detection)\n\n### 2. ChatSession Integration (src/consoul/cli/chat_session.py:126-167)\nAdded `_build_system_prompt()` method that:\n- Reads profile context flags (include_system_info, include_git_info)\n- Calls get_environment_context() to generate context\n- Prepends environment context to system prompt\n- Uses existing build_system_prompt() for tool documentation\n- Respects user configuration (defaults to enabled)\n\n### 3. Profile Updates (src/consoul/config/profiles.py)\nUpdated system prompts for:\n- **default profile**: References \"environment information above\"\n- **code-review profile**: Mentions project context understanding\n- Both profiles guide AI to use the injected context\n\n### 4. Testing\nVerified functionality:\n```bash\n# Environment context generation works\npython3 -c \"from consoul.ai.environment import get_environment_context; print(get_environment_context())\"\n\n# AI uses context in responses\nconsoul ask \"Based on the environment information you have, what branch am I on?\" --no-stream\n# Response: \"You're on the develop branch.\" ✅\n```\n\n## Output Examples:\n\n**System Info:**\n```\n## Environment\n- OS: macOS 15.6 (Darwin 24.6.0)\n- Shell: zsh\n- Working Directory: /Users/jaredrummler/Development/github/goatbytes/consoul\n- Date: 2025-12-02 10:14 PST\n```\n\n**Git Info:**\n```\n## Git Repository\n- Repository: consoul\n- Branch: develop\n- Status: 28 file(s) modified\n- Remote: https://github.com/goatbytes/consoul\n- Last Commit: 1091e7e - fix(mypy): disable func-returns-value error for app module\n```\n\n## Benefits:\n- AI automatically knows working directory without asking\n- Git-aware suggestions (knows branch, repository, status)\n- Fresh context on every `consoul ask` invocation\n- Respects existing config flags (include_system_info, include_git_info)\n- No breaking changes - enabled by default for default/code-review profiles\n\nAll acceptance criteria met!",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    },
    {
      "created_at": "2025-12-02T10:22:41.507365",
      "updated_at": "2025-12-02T10:22:41.507366",
      "id": "20251202102241-746a02d9",
      "ticket_id": "SOUL-204",
      "author": "jared@goatbytes.io",
      "content": "Updated TUI to also inject environment context!\n\nThe TUI app was only handling tool documentation but not environment context. Updated `src/consoul/tui/app.py:1199-1241` to match the CLI behavior:\n\n- Now calls `get_environment_context()` before building system prompt\n- Respects profile context flags (include_system_info, include_git_info)\n- Prepends environment context to base prompt\n- Then passes to `build_system_prompt()` for tool documentation\n\n**Both CLI and TUI now provide full environmental awareness!**\n\n✅ `consoul ask` - has environment context\n✅ `consoul chat` - has environment context  \n✅ `consoul tui` - has environment context (NEW)\n\nAll three interfaces now give the AI the same rich context about working directory, git repository, OS, and available tools.",
      "edited": false,
      "edit_count": 0,
      "is_ai_generated": false,
      "attachments": [],
      "attachment_count": 0
    }
  ],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 2,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}