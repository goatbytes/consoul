{
  "created_at": "2025-12-07T14:47:54.887832",
  "updated_at": "2025-12-07T23:08:07.410202Z",
  "id": "SOUL-233",
  "uuid": "bd68e90a-b1cf-4f38-877b-2ee6b19372ce",
  "title": "Fix OpenAI stream_options parameter error in non-streaming calls",
  "description": "## Problem\n\nOpenAI API calls fail with 400 error when using .invoke() (non-streaming):\n\nError code: 400 - The stream_options parameter is only allowed when stream is enabled\n\n## Root Cause\n\nConsoul SDK unconditionally sets stream_options in model_kwargs during ChatOpenAI \ninitialization. OpenAI API only allows stream_options when stream=True.\n\n## Affected Code\n\nFile: src/consoul/ai/providers.py\n\nLines 885-886:\nparams[\"model_kwargs\"] = {\"stream_options\": {\"include_usage\": True}}\n\nLines 1690-1693:\nmodel_kwargs = params.pop(\"model_kwargs\", {})\nif \"stream_options\" not in model_kwargs:\n    model_kwargs[\"stream_options\"] = {\"include_usage\": True}\n\n## Impact\n\nBreaks ALL non-streaming OpenAI API calls:\n- consoul/sdk.py:513 - .invoke() in chat() method\n- consoul/sdk.py:601 - .invoke() in ask() method  \n- consoul/cli/chat_session.py:267 - .invoke() in chat session\n- consoul/ai/summarization.py:190 - .invoke() in summarization\n\nAffects all OpenAI models: gpt-4o, gpt-4o-mini, gpt-4-turbo\nEspecially problematic for vision/multimodal requests\n\n## Solution\n\nRemove unconditional stream_options setting. LangChain handles this automatically:\n- Streaming: Adds stream_options when needed\n- Non-streaming: Usage metadata in response by default\n\nCode Changes:\n\nFile: src/consoul/ai/providers.py\n\nChange 1 - Remove lines 885-886\nChange 2 - Remove lines 1690-1693 or replace with:\n  model_kwargs = params.pop(\"model_kwargs\", {})\n  # LangChain handles stream_options automatically\n\nAlternative: Use params[\"stream_usage\"] = True instead\n\n## Testing\n\n1. Non-streaming: response = model.invoke([HumanMessage(content=\"test\")])\n2. Streaming: for chunk in model.stream([...]): pass\n3. Vision: response = model.invoke([vision_message])\n\n## Context\n\nDiscovered in prrfect-pdf when using vision models for image descriptions.\nAll 14 images failed AI analysis due to this parameter mismatch.\n\nReferences:\n- OpenAI API: stream_options requires stream=True\n- LangChain: _stream() sets stream=True, _generate() does not\n- Previous attempts: d3001ff, 3e4fdb0, badc723 (fixed warnings, not root cause)",
  "status": "done",
  "type": "bug",
  "priority": "high",
  "labels": [
    "openai",
    "langchain",
    "api-error"
  ],
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "order": 0,
  "custom_fields": {}
}