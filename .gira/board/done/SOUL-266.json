{
  "created_at": "2025-12-11T16:42:04.592338",
  "updated_at": "2025-12-13T03:07:51.208867Z",
  "id": "SOUL-266",
  "uuid": "6c2486d2-9f64-41e9-ac70-eebdb3c1e37c",
  "title": "Fix invalid format specifier in MessageBubble cost display",
  "description": "**As a** Consoul user using the TUI\n**I want** cost estimates to display correctly for all API calls\n**So that** I can accurately track my API usage costs without crashes\n\n**Context:**\nThere is a critical bug in `src/consoul/tui/widgets/message_bubble.py:338` that causes a ValueError when displaying estimated costs between $0.001 and $0.01. This is a common price range for Claude API calls (typical conversations cost $0.003-$0.008), making this a high-impact bug that affects normal usage.\n\nThe bug occurs in the `_build_metadata_text()` method which formats the cost string based on magnitude:\n\n```python\n# Line 335-340\nif self.estimated_cost < 0.001:\n    cost_str = f\"~${self.estimated_cost:.6f}\"\nelif self.estimated_cost < 0.01:\n    cost_str = f\"~${self.estimated_cost:i.4f}\"  # BUG: invalid 'i' specifier\nelse:\n    cost_str = f\"~${self.estimated_cost:.2f}\"\n```\n\nThe format specifier `:i.4f` is invalid for Python floats. It should be `:.4f`.\n\n**Impact:**\n- Any API call costing between $0.001-$0.01 crashes the MessageBubble rendering\n- This prevents the assistant's response from being displayed in the TUI\n- Common for typical Claude API calls (100-500 tokens)\n- Affects both streaming and non-streaming responses\n\n**Technical Notes:**\n- File: `src/consoul/tui/widgets/message_bubble.py:338`\n- Method: `_build_metadata_text()`\n- The 'i' prefix is not a valid Python format specifier for floats\n- Should be `:.4f` instead of `:i.4f`\n- Test coverage gap: No tests exist for `estimated_cost` parameter in `test_message_bubble.py`\n- The estimated_cost is passed from `src/consoul/tui/app.py:1887` and `src/consoul/sdk.py:775`\n\n**Acceptance Criteria:**\n\n**Given** an assistant message with estimated_cost = 0.005\n**When** the MessageBubble renders the metadata footer\n**Then** the cost displays as \"~$0.0050\" without raising a ValueError\n\n**Given** estimated costs at boundary values (0.001, 0.009, 0.01, 0.1)\n**When** MessageBubble builds metadata text\n**Then** all costs format correctly using appropriate precision\n\n**Given** a MessageBubble with estimated_cost in any valid range\n**When** the widget renders\n**Then** no ValueError is raised for invalid format specifiers\n\n**Testing Considerations:**\n- Add test case for estimated_cost < 0.001 (should use 6 decimals)\n- Add test case for 0.001 ≤ estimated_cost < 0.01 (should use 4 decimals)\n- Add test case for estimated_cost ≥ 0.01 (should use 2 decimals)\n- Add test case for estimated_cost = None (should not display cost)\n- Add test case for estimated_cost = 0 (should not display cost per line 332)\n- Verify metadata footer includes cost with proper formatting\n- Test boundary values: 0.001, 0.0099, 0.01, 0.099, 0.1\n\n**Implementation Hints:**\n1. Change line 338 from `:i.4f` to `:.4f`\n2. Add comprehensive test coverage in `tests/tui/widgets/test_message_bubble.py`\n3. Consider adding a test class `TestMessageBubbleEstimatedCost` for cost-specific tests\n4. Verify the fix doesn't affect other cost ranges (< 0.001 and ≥ 0.01)",
  "status": "done",
  "type": "bug",
  "priority": "high",
  "labels": [
    "tui",
    "bug",
    "cost-tracking",
    "quick-win"
  ],
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 2,
  "order": 0,
  "custom_fields": {}
}