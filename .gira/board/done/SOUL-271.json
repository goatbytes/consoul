{
  "created_at": "2025-12-11T16:54:07.796376",
  "updated_at": "2025-12-11T16:54:07.796384",
  "id": "SOUL-271",
  "uuid": "80f2d738-35cd-41cf-a2a7-0cf31307c21e",
  "title": "Fix KeyError in model picker search for local models",
  "description": "**As a** Consoul TUI user\n**I want** to search for local models in the model picker without crashes\n**So that** I can find and select models efficiently\n\n**Context:**\nThere is a bug in `src/consoul/tui/widgets/model_picker_modal.py:1396` in the `_add_local_models_to_table()` method that causes a KeyError when filtering local models (Ollama, GGUF, MLX) by search query if any model info dictionary is missing the \"description\" key.\n\nThe bug is an inconsistent dictionary access pattern:\n\n```python\n# Line 1395 - CORRECT: uses .get() with default\nif query_lower in info.get(\"display_name\", \"\").lower()\n# Line 1396 - BUG: direct key access without default\nor query_lower in info[\"description\"].lower()\n```\n\n**Comparison with similar code:**\nIn the same file, line 977 (different method) correctly uses `.get()`:\n```python\nif query_lower in info.get(\"display_name\", \"\").lower()\nor query_lower in info.get(\"description\", \"\").lower()  # CORRECT\n```\n\n**Impact:**\n- KeyError crashes the model picker when searching if any model lacks a \"description\" key\n- Affects local model providers: Ollama, GGUF, and MLX\n- Makes the search feature unreliable for local models\n- User loses ability to filter models, forcing them to scroll through entire list\n\n**Technical Notes:**\n- File: `src/consoul/tui/widgets/model_picker_modal.py:1396`\n- Method: `_add_local_models_to_table(provider_models, search_query)`\n- Class: `ModelPickerModal(ModalScreen)`\n- The `description` key may be missing from model info dicts constructed from various sources\n- Line 1375 shows description is added for MLX models, but may not always be present\n- No test coverage exists for this widget (`tests/` has no model_picker tests)\n\n**Acceptance Criteria:**\n\n**Given** a local model info dict without a \"description\" key\n**When** user enters a search query in the model picker\n**Then** the search filters models without raising a KeyError\n\n**Given** a user searches for models in the model picker\n**When** some models have descriptions and others don't\n**Then** the search works correctly on both display_name and description (when present)\n\n**Given** a model with description \"fast inference model\"\n**When** user searches for \"inference\"\n**Then** the model appears in the filtered results\n\n**Given** a model without a description key\n**When** user searches for any term\n**Then** the model is filtered based on display_name only, without errors\n\n**Testing Considerations:**\n- Add test for `_add_local_models_to_table()` with models missing \"description\" key\n- Test search functionality with mixed models (some with/without description)\n- Test empty search query (should return all models)\n- Test search with no matches\n- Verify both \"display_name\" and \"description\" are searched when both present\n- Test with all three local provider types: Ollama, GGUF, MLX\n\n**Implementation Hints:**\n1. Change line 1396 from `info[\"description\"]` to `info.get(\"description\", \"\")`\n2. This makes it consistent with line 1395 and line 977\n3. Consider adding type hints to document expected structure of model info dicts\n4. Add unit tests for the search filtering logic\n5. Verify all code paths that construct model info dicts include \"description\" key\n\n**Similar Issues:**\nLine 977 in the same file already uses the correct pattern - this is a consistency fix.",
  "status": "todo",
  "type": "bug",
  "priority": "high",
  "labels": [
    "tui",
    "bug",
    "model-picker",
    "local-models",
    "quick-win"
  ],
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 2,
  "order": 0,
  "custom_fields": {}
}