{
  "created_at": "2025-12-30T02:06:01.580044Z",
  "updated_at": "2025-12-30T19:43:43.425960Z",
  "id": "SOUL-330",
  "uuid": "a7909a79-7013-4a9c-98bf-028ba8430009",
  "_version": 1,
  "title": "Add integration test suite for server HTTP and WebSocket endpoints",
  "description": "**As a** Consoul server developer\n**I want** a comprehensive integration test suite for HTTP and WebSocket endpoints\n**So that** I can verify full request/response flows with mocked LLM providers before production deployment\n\n**Context:**\nThe server package (`src/consoul/server/`) provides production-ready FastAPI endpoints:\n- POST `/chat` - HTTP chat with session management (factory.py:504-624)\n- WS `/ws/chat/{session_id}` - WebSocket streaming (endpoints/websocket.py:328-557)\n- GET `/health` - Health check (factory.py:381-406)\n- GET `/ready` - Readiness check with dependency verification (factory.py:408-470)\n\nCurrent test coverage includes unit tests in `tests/server/`:\n- `test_factory.py` - Server factory, middleware initialization, health/ready endpoints\n- `test_chat_endpoint.py` - Request validation, session management, error handling\n- `test_websocket_endpoint.py` - Connection manager, approval provider, backpressure\n\nHowever, these tests use `fastapi.TestClient` which is synchronous. Full integration testing requires:\n- Async HTTP testing with `httpx.AsyncClient` and `ASGITransport`\n- WebSocket testing with `websockets` library for realistic connection behavior\n- End-to-end flows testing actual middleware chain (CORS, auth, rate limiting)\n\n**Technical Notes:**\n- Create: `tests/server/test_integration.py`\n- Dependencies: Add `httpx` and `websockets` to dev dependencies in pyproject.toml\n- Use pytest markers: `@pytest.mark.integration` (already configured in pyproject.toml:307)\n- Mock LLM responses at SDK level using `unittest.mock.patch`\n- Reference existing patterns in `tests/server/test_chat_endpoint.py` for SDK mocking\n- Server factory: `src/consoul/server/factory.py` creates FastAPI app with all middleware\n- Session stores: `src/consoul/sdk/session_store.py` provides MemorySessionStore for tests\n\nKey integration points to test:\n1. Health/ready endpoints bypass auth and rate limiting\n2. Chat endpoint with session persistence across requests\n3. WebSocket connection with token streaming\n4. Rate limiting triggers 429 responses\n5. Authentication rejects invalid keys\n\n**Acceptance Criteria:**\n\n**Given** the server is running with no authentication configured\n**When** I send GET /health\n**Then** I receive 200 with status=\"ok\", service name, version, and ISO 8601 timestamp\n\n**Given** the server is running with API keys configured\n**When** I send POST /chat without X-API-Key header\n**Then** I receive 401 Unauthorized\n\n**Given** a valid API key and a new session_id\n**When** I send POST /chat with message \"Hello\"\n**Then** I receive 200 with session_id, response text, model name, usage object, and timestamp\n\n**Given** an existing session with conversation history\n**When** I send POST /chat with the same session_id\n**Then** session state is restored and conversation context is preserved\n\n**Given** rate limiting configured at \"2/minute\"\n**When** I send 3 rapid POST /chat requests\n**Then** the third request receives 429 Too Many Requests\n\n**Given** a WebSocket connection to /ws/chat/{session_id}\n**When** I send {\"type\": \"message\", \"content\": \"Hello\"}\n**Then** I receive token events followed by a done event with usage data\n\n**Given** a WebSocket connection with auth configured\n**When** I connect without ?api_key query parameter\n**Then** connection is rejected with code 1008\n\n**Testing Considerations:**\n- Mock LLM at `consoul.sdk.create_session` and `consoul.sdk.restore_session` level\n- Use `httpx.AsyncClient(transport=ASGITransport(app=app))` for async HTTP tests\n- Use `websockets.connect()` for WebSocket tests (requires server in background)\n- Alternative: Use Starlette's `TestClient` with `with client.websocket_connect()` for simpler WebSocket tests\n- Add fixtures for common server configs (no auth, with auth, rate limited)\n- Test both MemorySessionStore (default) and mock Redis behavior\n- Mark tests with `@pytest.mark.integration` for optional exclusion in CI\n- Consider `@pytest.mark.slow` for tests with actual network delays\n\n**Implementation Hints:**\n- Add to pyproject.toml dev dependencies:\n  ```toml\n  httpx = \"^0.28.0\"\n  websockets = \"^14.0\"\n  ```\n- Example async HTTP test pattern:\n  ```python\n  import httpx\n  from httpx import ASGITransport\n  from consoul.server import create_server\n\n  @pytest.mark.asyncio\n  @pytest.mark.integration\n  async def test_health_endpoint_async():\n      app = create_server()\n      async with httpx.AsyncClient(\n          transport=ASGITransport(app=app),\n          base_url=\"http://test\"\n      ) as client:\n          response = await client.get(\"/health\")\n          assert response.status_code == 200\n  ```\n- Example WebSocket test with Starlette TestClient:\n  ```python\n  def test_websocket_streaming():\n      app = create_server()\n      with TestClient(app) as client:\n          with client.websocket_connect(\"/ws/chat/test-session\") as ws:\n              ws.send_json({\"type\": \"message\", \"content\": \"Hi\"})\n              data = ws.receive_json()\n              assert data[\"type\"] in [\"token\", \"error\"]\n  ```\n- Reference existing mocking patterns in `tests/server/test_chat_endpoint.py:129-151`\n- Use `ServerConfig` to configure different test scenarios:\n  - `SecurityConfig(api_keys=[\"test-key\"])` for auth tests\n  - `RateLimitConfig(default_limits=[\"2/minute\"])` for rate limit tests\n\n**Out of Scope:**\n- Redis integration tests (require running Redis instance)\n- Load testing / performance benchmarks\n- TLS/HTTPS testing",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "testing",
    "server",
    "integration"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-017",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}