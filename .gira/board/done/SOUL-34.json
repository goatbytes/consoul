{
  "created_at": "2025-11-09T19:47:33.421533",
  "updated_at": "2025-11-11T04:27:46.244768Z",
  "id": "SOUL-34",
  "uuid": "747407eb-603c-49d3-83d1-092816f676de",
  "title": "Implement base ConsoulApp class with keyboard bindings",
  "description": "# Implement Base ConsoulApp Class with Keyboard Bindings\n\n## User Story\n**As a** Consoul user\n**I want** a functional TUI application with keyboard shortcuts\n**So that** I can launch the Consoul interface and navigate using keyboard commands\n\n## Description\n\nCreate the foundational ConsoulApp class that inherits from Textual's `App` base class. This establishes the core TUI application with reactive state management, keyboard bindings, and basic screen composition. The app doesn't need full functionality yet (widgets created in Phase 2), but must demonstrate Textual framework patterns and be launchable in test mode.\n\n## Context\n\nResearch from TUI_RESEARCH.md shows that both Gira and Postings use a similar pattern:\n- Main App class inheriting from `textual.app.App`\n- Reactive state variables for current view/session\n- Comprehensive keyboard bindings (BINDINGS list)\n- Compose method defining widget hierarchy\n- Action handlers for bindings\n\n**Key References:**\n- TUI_RESEARCH.md ยง3 \"Recommended Architecture\" (ConsoulApp example)\n- Gira: `src/gira/tui/app.py:104-163` (TuiApp BINDINGS)\n- Postings: `src/posting/app.py:94-154` (MainScreen BINDINGS)\n- Textual docs: https://textual.textualize.io/guide/app/\n\n## Technical Notes\n\n**File:** `src/consoul/tui/app.py`\n\n**Key Components:**\n\n```python\nfrom textual.app import App, ComposeResult\nfrom textual.binding import Binding\nfrom textual.reactive import reactive\nfrom textual.widgets import Header, Footer\nfrom consoul.tui.config import TuiConfig\nimport gc\n\nclass ConsoulApp(App[None]):\n    \"\"\"Main Consoul Terminal User Interface application.\n\n    Provides an interactive chat interface with streaming AI responses,\n    conversation history, and keyboard-driven navigation.\n    \"\"\"\n\n    CSS_PATH = \"css/main.tcss\"  # Created in SOUL-35\n    TITLE = \"Consoul - AI Terminal Assistant\"\n    SUB_TITLE = \"Powered by LangChain\"\n\n    BINDINGS = [\n        # Essential\n        Binding(\"q\", \"quit\", \"Quit\", priority=True),\n        Binding(\"ctrl+c\", \"quit\", \"Quit\", priority=True, show=False),\n\n        # Conversation\n        Binding(\"ctrl+n\", \"new_conversation\", \"New Chat\"),\n        Binding(\"ctrl+l\", \"clear_conversation\", \"Clear\"),\n        Binding(\"escape\", \"cancel_stream\", \"Cancel\", show=False),\n\n        # Navigation\n        Binding(\"ctrl+p\", \"switch_profile\", \"Profile\", show=False),\n        Binding(\"ctrl+m\", \"switch_model\", \"Model\", show=False),\n        Binding(\"ctrl+e\", \"export_conversation\", \"Export\", show=False),\n        Binding(\"ctrl+s\", \"search_history\", \"Search\", show=False),\n        Binding(\"/\", \"focus_input\", \"Input\", show=False),\n\n        # UI\n        Binding(\"ctrl+comma\", \"settings\", \"Settings\", show=False),\n        Binding(\"ctrl+t\", \"cycle_theme\", \"Theme\", show=False),\n        Binding(\"f1\", \"help\", \"Help\", show=False),\n    ]\n\n    # Reactive state\n    current_profile: reactive[str] = reactive(\"default\")\n    current_model: reactive[str] = reactive(\"\")\n    conversation_id: reactive[str | None] = reactive(None)\n    streaming: reactive[bool] = reactive(False)\n\n    def __init__(self, config: TuiConfig | None = None, test_mode: bool = False):\n        super().__init__()\n        self.config = config or TuiConfig()\n        self.test_mode = test_mode\n\n        # GC management (from research)\n        if self.config.gc_mode == \"streaming-aware\":\n            gc.disable()\n            self.set_interval(self.config.gc_interval_seconds, self._idle_gc)\n\n    def compose(self) -> ComposeResult:\n        \"\"\"Compose the UI layout.\"\"\"\n        yield Header()\n        # TODO: Add main widgets in Phase 2\n        yield Footer()\n\n    def _idle_gc(self) -> None:\n        \"\"\"Periodic garbage collection when not streaming.\"\"\"\n        if not self.streaming:\n            gc.collect(generation=self.config.gc_generation)\n\n    # Action handlers (placeholders for Phase 2+)\n    def action_new_conversation(self) -> None:\n        \"\"\"Start a new conversation.\"\"\"\n        self.notify(\"New conversation (placeholder)\")\n\n    def action_clear_conversation(self) -> None:\n        \"\"\"Clear current conversation.\"\"\"\n        self.notify(\"Clear conversation (placeholder)\")\n\n    def action_cancel_stream(self) -> None:\n        \"\"\"Cancel active streaming.\"\"\"\n        if self.streaming:\n            self.streaming = False\n            self.notify(\"Streaming cancelled\")\n\n    def action_switch_profile(self) -> None:\n        \"\"\"Show profile selection modal.\"\"\"\n        self.notify(\"Profile switcher (Phase 3)\")\n\n    def action_switch_model(self) -> None:\n        \"\"\"Show model selection modal.\"\"\"\n        self.notify(\"Model switcher (Phase 3)\")\n\n    def action_export_conversation(self) -> None:\n        \"\"\"Show export modal.\"\"\"\n        self.notify(\"Export (Phase 4)\")\n\n    def action_search_history(self) -> None:\n        \"\"\"Show search interface.\"\"\"\n        self.notify(\"Search (Phase 4)\")\n\n    def action_focus_input(self) -> None:\n        \"\"\"Focus the input area.\"\"\"\n        self.notify(\"Focus input (Phase 2)\")\n\n    def action_settings(self) -> None:\n        \"\"\"Show settings screen.\"\"\"\n        self.notify(\"Settings (Phase 4)\")\n\n    def action_cycle_theme(self) -> None:\n        \"\"\"Cycle to next theme.\"\"\"\n        self.notify(\"Theme cycling (Phase 4)\")\n\n    def action_help(self) -> None:\n        \"\"\"Show help modal.\"\"\"\n        self.notify(\"Help (Phase 4)\")\n```\n\n**CLI Entry Point:** `src/consoul/tui/cli.py`\n\n```python\nimport click\nfrom consoul.tui.app import ConsoulApp\nfrom consoul.tui.config import TuiConfig\n\n@click.command()\n@click.option(\"--theme\", help=\"Color theme\")\n@click.option(\"--test-mode\", is_flag=True, hidden=True, help=\"Test mode (auto-exit)\")\ndef tui(theme: str | None, test_mode: bool):\n    \"\"\"Launch Consoul TUI.\"\"\"\n    config = TuiConfig()\n    if theme:\n        config.theme = theme\n\n    app = ConsoulApp(config=config, test_mode=test_mode)\n    app.run()\n\nif __name__ == \"__main__\":\n    tui()\n```\n\n**Key Considerations:**\n- Use `reactive` for state that triggers UI updates\n- Placeholder action handlers (filled in later phases)\n- GC management from research (streaming-aware mode)\n- Test mode for automated testing\n- Follow Gira's pattern for BINDINGS\n\n## Acceptance Criteria\n\n**Given** I run `python -m consoul.tui.cli`\n**When** the app launches\n**Then** I see a Header and Footer with title \"Consoul - AI Terminal Assistant\"\n\n**Given** the app is running\n**When** I press `q`\n**Then** the app exits gracefully\n\n**Given** the app is running\n**When** I press `ctrl+n`\n**Then** I see a notification \"New conversation (placeholder)\"\n\n**Given** the app is running with streaming=True\n**When** I press `escape`\n**Then** streaming is cancelled and I see \"Streaming cancelled\" notification\n\n**Given** I create ConsoulApp with gc_mode=\"streaming-aware\"\n**When** the app initializes\n**Then** gc.disable() is called and periodic GC is scheduled\n\n**Given** the app is in test mode\n**When** initialization completes\n**Then** the app auto-exits (for smoke tests)\n\n## Testing Considerations\n\n**Smoke Test:** `tests/tui/test_tui_smoke.py`\n\n```python\ndef test_tui_app_launches():\n    \"\"\"Test that ConsoulApp launches without errors.\"\"\"\n    app = ConsoulApp(test_mode=True)\n    assert app.title == \"Consoul - AI Terminal Assistant\"\n\ndef test_tui_reactive_state():\n    \"\"\"Test reactive state initialization.\"\"\"\n    app = ConsoulApp(test_mode=True)\n    assert app.streaming == False\n    assert app.conversation_id is None\n\ndef test_tui_gc_disabled():\n    \"\"\"Test GC management in streaming-aware mode.\"\"\"\n    import gc\n    config = TuiConfig(gc_mode=\"streaming-aware\")\n    app = ConsoulApp(config=config, test_mode=True)\n    assert not gc.isenabled()\n```\n\n**Manual Testing:**\n- Launch with `python -m consoul.tui.cli`\n- Test keyboard shortcuts (q, ctrl+n, escape, etc.)\n- Verify Header/Footer render correctly\n- Check notifications appear\n\n## Implementation Hints\n\n1. Start with minimal compose() (Header + Footer only)\n2. Add all BINDINGS from research\n3. Implement placeholder action handlers\n4. Add reactive state variables\n5. Implement GC management\n6. Create CLI entry point\n7. Add smoke tests\n8. Verify mypy/ruff pass\n\n**Testing App Manually:**\n```bash\ncd src\npython -m consoul.tui.cli --theme monokai\n# Press 'q' to quit\n```\n\n**Textual Dev Tools:**\n```bash\ntextual run consoul.tui.cli:tui --dev\n# Opens dev console for debugging\n```\n\n## Files to Create/Modify\n\n**New Files:**\n- src/consoul/tui/app.py (main implementation)\n- src/consoul/tui/cli.py (CLI entry point)\n- tests/tui/__init__.py\n- tests/tui/test_tui_smoke.py\n\n**Modified Files:**\n- src/consoul/tui/__init__.py (export ConsoulApp)\n\n## Dependencies\n\n**Prerequisites:**\n- SOUL-32 complete (tui/ directory exists)\n- SOUL-33 complete (TuiConfig available)\n- Textual framework installed\n\n**Blocks:**\n- Phase 2 tickets (need ConsoulApp to add widgets)",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "tui",
    "textual",
    "foundation"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-003",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}