{
  "created_at": "2025-11-09T20:12:59.261542",
  "updated_at": "2025-11-10T21:53:22.006407Z",
  "id": "SOUL-38",
  "uuid": "383e30c8-9a12-4a25-b2d5-a5933d3702ed",
  "title": "Create MessageBubble widget with markdown rendering",
  "description": "# Create MessageBubble Widget with Markdown Rendering\n\n## User Story\n**As a** Consoul user\n**I want** messages displayed in styled bubbles with markdown formatting\n**So that** I can distinguish between user/assistant messages and read formatted content\n\n## Description\n\nCreate the MessageBubble widget that wraps individual messages (user, assistant, system) with appropriate styling, borders, and markdown rendering. This widget provides the visual structure for each message in the conversation.\n\n## Context\n\nFrom TUI_RESEARCH.md and existing CSS:\n- Different styles for user vs assistant vs system messages\n- Markdown rendering with Rich\n- Code syntax highlighting\n- Metadata display (timestamp, token count)\n\n**Key Reference:** main.tcss message bubble styles\n\n## Technical Notes\n\n**File:** `src/consoul/tui/widgets/message_bubble.py`\n\n```python\nfrom textual.widgets import Static\nfrom textual.reactive import reactive\nfrom rich.markdown import Markdown\nfrom rich.syntax import Syntax\nfrom datetime import datetime\nfrom typing import Literal\n\n\nclass MessageBubble(Static):\n    \"\"\"Message bubble widget with markdown rendering.\n    \n    Displays a single message with role-specific styling and optional metadata.\n    \"\"\"\n    \n    role: reactive[str] = reactive(\"user\")\n    \n    def __init__(\n        self,\n        content: str,\n        role: Literal[\"user\", \"assistant\", \"system\", \"error\"] = \"user\",\n        timestamp: datetime | None = None,\n        token_count: int | None = None,\n        show_metadata: bool = True,\n        **kwargs\n    ) -> None:\n        super().__init__(**kwargs)\n        self.content_text = content\n        self.role = role\n        self.timestamp = timestamp or datetime.now()\n        self.token_count = token_count\n        self.show_metadata = show_metadata\n    \n    def on_mount(self) -> None:\n        \"\"\"Render message on mount.\"\"\"\n        self._render_message()\n    \n    def _render_message(self) -> None:\n        \"\"\"Render message content with markdown.\"\"\"\n        # Apply role-specific class\n        self.add_class(f\"message-{self.role}\")\n        \n        # Set border title\n        if self.role == \"user\":\n            self.border_title = \"You\"\n        elif self.role == \"assistant\":\n            self.border_title = \"Assistant\"\n        elif self.role == \"system\":\n            self.border_title = \"System\"\n        else:\n            self.border_title = \"Error\"\n        \n        # Render markdown content\n        try:\n            md = Markdown(self.content_text)\n            self.update(md)\n        except Exception:\n            # Fallback to plain text\n            self.update(self.content_text)\n        \n        # Add metadata footer if enabled\n        if self.show_metadata:\n            footer = self._build_metadata_footer()\n            # Append footer (implementation varies)\n    \n    def _build_metadata_footer(self) -> str:\n        \"\"\"Build metadata footer string.\"\"\"\n        parts = []\n        \n        # Timestamp\n        time_str = self.timestamp.strftime(\"%H:%M:%S\")\n        parts.append(f\"ðŸ• {time_str}\")\n        \n        # Token count (if available)\n        if self.token_count is not None:\n            parts.append(f\"ðŸŽ¯ {self.token_count} tokens\")\n        \n        return \" | \".join(parts)\n    \n    def watch_role(self, new_role: str) -> None:\n        \"\"\"Update styling when role changes.\"\"\"\n        # Remove old role class\n        for cls in [\"message-user\", \"message-assistant\", \"message-system\", \"message-error\"]:\n            self.remove_class(cls)\n        \n        # Add new role class\n        self.add_class(f\"message-{new_role}\")\n```\n\n**CSS (already in main.tcss):**\n\n```css\n.message-user {\n    background: $primary;\n    color: $text;\n    border: tall $accent;\n}\n\n.message-assistant {\n    background: $secondary;\n    color: $text;\n    border: tall $success;\n}\n\n.message-system {\n    background: $surface-lighten-1;\n    color: $text-muted;\n}\n\n.message-error {\n    background: $error;\n    color: $text;\n    border: double $warning;\n}\n```\n\n## Acceptance Criteria\n\n**Given** I create a MessageBubble with role=\"user\"\n**When** it mounts\n**Then** it has class \"message-user\" and border title \"You\"\n\n**Given** I create a MessageBubble with markdown content\n**When** it renders\n**Then** markdown is properly formatted (bold, italic, code blocks)\n\n**Given** I create a MessageBubble with show_metadata=True\n**When** it renders\n**Then** timestamp and token count are displayed\n\n**Given** I change the role reactively\n**When** role updates from \"user\" to \"assistant\"\n**Then** styling updates to assistant colors\n\n**Given** markdown rendering fails\n**When** render is attempted\n**Then** fallback to plain text occurs\n\n## Testing Considerations\n\n**Test File:** `tests/tui/widgets/test_message_bubble.py`\n\n```python\nfrom datetime import datetime\nfrom consoul.tui.widgets.message_bubble import MessageBubble\n\n\ndef test_message_bubble_user():\n    \"\"\"Test user message bubble creation.\"\"\"\n    bubble = MessageBubble(\"Hello\", role=\"user\")\n    assert bubble.role == \"user\"\n    assert bubble.border_title == \"You\"\n    assert \"message-user\" in bubble.classes\n\n\ndef test_message_bubble_assistant():\n    \"\"\"Test assistant message bubble.\"\"\"\n    bubble = MessageBubble(\"Hi there!\", role=\"assistant\")\n    assert bubble.role == \"assistant\"\n    assert bubble.border_title == \"Assistant\"\n\n\ndef test_markdown_rendering():\n    \"\"\"Test markdown content rendering.\"\"\"\n    content = \"**Bold** and *italic* and `code`\"\n    bubble = MessageBubble(content, role=\"user\")\n    # Check that markdown was rendered (implementation specific)\n\n\ndef test_metadata_display():\n    \"\"\"Test metadata footer generation.\"\"\"\n    bubble = MessageBubble(\n        \"Test\",\n        role=\"user\",\n        token_count=42,\n        show_metadata=True\n    )\n    footer = bubble._build_metadata_footer()\n    assert \"42 tokens\" in footer\n    assert \"ðŸ•\" in footer\n\n\ndef test_role_change():\n    \"\"\"Test reactive role change.\"\"\"\n    bubble = MessageBubble(\"Test\", role=\"user\")\n    bubble.role = \"assistant\"\n    assert \"message-assistant\" in bubble.classes\n    assert \"message-user\" not in bubble.classes\n```\n\n## Implementation Hints\n\n1. Start with Static base widget\n2. Add role-specific styling logic\n3. Implement markdown rendering with Rich\n4. Add metadata footer\n5. Test with various markdown formats\n6. Test code blocks with syntax highlighting\n7. Verify all 4 role types (user, assistant, system, error)\n\n**Markdown Test Cases:**\n\n```python\nMARKDOWN_TESTS = [\n    \"**Bold text**\",\n    \"*Italic text*\",\n    \"`inline code`\",\n    \"# Heading\",\n    \"- List item\",\n    \"```python\\nprint('code')\\n```\",\n    \"[Link](https://example.com)\",\n    \"> Quote\",\n]\n```\n\n## Files to Create/Modify\n\n**New Files:**\n- src/consoul/tui/widgets/message_bubble.py\n- tests/tui/widgets/test_message_bubble.py\n\n**Modified Files:**\n- src/consoul/tui/widgets/__init__.py\n\n## Dependencies\n\n**Prerequisites:**\n- SOUL-32 complete (widgets/ directory)\n- SOUL-35 complete (CSS styles defined)\n- Rich library for markdown\n\n**Blocks:**\n- SOUL-36 (ChatView displays MessageBubbles)",
  "status": "done",
  "type": "feature",
  "priority": "high",
  "labels": [
    "tui",
    "widgets",
    "markdown"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-003",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}