{
  "created_at": "2025-12-31T19:48:12.493070Z",
  "updated_at": "2025-12-31T20:10:21.574045Z",
  "id": "SOUL-348",
  "uuid": "e448174a-1325-4921-b1ec-967f21012ebb",
  "_version": 1,
  "title": "Fix rate limiter TypeError when using dynamic limit callable",
  "description": "**As a** Consoul server developer\n**I want** the rate limiter tests to pass with the dynamic rate limit function\n**So that** I can verify rate limiting behavior in CI/CD and ensure the /chat and /chat/batch endpoints work correctly\n\n**Context:**\nDuring SOUL-339 implementation, we discovered that tests for both `/chat` and `/chat/batch` endpoints fail with:\n```\nTypeError: create_server.<locals>.get_chat_rate_limit() missing 1 required positional argument: 'request'\n```\n\nThe root cause is a mismatch between how slowapi 0.1.9 invokes callable limit providers and how `get_chat_rate_limit()` is defined.\n\n**Technical Analysis:**\nThe function `get_chat_rate_limit(request: Request)` at `src/consoul/server/factory.py` lines 462-469 requires a `request` parameter:\n```python\ndef get_chat_rate_limit(request: Request) -> str:\n    \"\"\"Get rate limit for chat endpoint based on API key tier.\"\"\"\n    if tiered_limit_func is not None:\n        return tiered_limit_func(request)\n    return \"30/minute\"\n```\n\nHowever, slowapi 0.1.9 does NOT pass the request to callable limit providers. According to [slowapi issue #13](https://github.com/laurentS/slowapi/issues/13), the callable should accept no parameters. The repository owner noted this limitation was inherited from Flask-Limiter.\n\n**Affected Files:**\n- `src/consoul/server/factory.py` lines 462-471 - `get_chat_rate_limit()` function\n- `src/consoul/server/middleware/rate_limit.py` lines 264-286 - `create_tiered_limit_func()` inner function\n- `tests/server/test_chat_endpoint.py` - 13 tests fail (TestChatRateLimiting class)\n- `tests/server/test_batch_endpoint.py` - 13 tests fail (all tests using rate limiting)\n\n**Proposed Solutions:**\n\n1. **Use ContextVar Pattern (Recommended):** \n   - Create a middleware that stores the current request in a `ContextVar`\n   - Modify `get_chat_rate_limit()` to read from the ContextVar instead of accepting a parameter\n   - This matches the pattern recommended in slowapi documentation\n\n2. **Fallback to Static Limit in Tests:**\n   - When no request is available, return the default \"30/minute\" limit\n   - This would make tests pass but may hide integration issues\n\n3. **Upgrade slowapi or Patch:**\n   - Check if newer versions support request passing\n   - Or monkey-patch the limiter wrapper for tests\n\n**Acceptance Criteria:**\n\n**Given** the server is created with default configuration\n**When** I run `pytest tests/server/test_chat_endpoint.py::TestChatRateLimiting -v`\n**Then** all rate limiting tests pass without TypeError\n\n**Given** the server is created with tiered rate limiting configured\n**When** I run `pytest tests/server/test_rate_limit_tiers.py -v`\n**Then** all tiered rate limiting tests pass\n\n**Given** the batch endpoint tests are run\n**When** I execute `pytest tests/server/test_batch_endpoint.py -v`\n**Then** all 13 batch endpoint tests pass\n\n**Given** a production server with tiered rate limits\n**When** a request is made to /chat with a premium API key\n**Then** the tiered rate limit (e.g., 100/minute) is applied correctly\n\n**Testing Considerations:**\n- Unit tests: Verify `get_chat_rate_limit` returns correct limit with mocked request context\n- Integration tests: Test actual rate limiting behavior with TestClient\n- Regression tests: Ensure existing rate limit tests in `test_rate_limit_tiers.py` still pass\n- Mock strategy: May need to mock the ContextVar or use actual middleware in test setup\n\n**Implementation Hints:**\n- Reference Flask-Limiter's `g` object pattern for storing request context\n- Use Python's `contextvars.ContextVar` for thread-safe request storage\n- Add middleware before rate limiter middleware in factory.py\n- Consider `@app.middleware(\"http\")` for request context storage\n- The existing `create_tiered_limit_func()` in `middleware/rate_limit.py` already accepts Request - its inner function needs to access request differently\n- slowapi version 0.1.9 is installed; check release notes for any updates\n\n**References:**\n- slowapi GitHub issue: https://github.com/laurentS/slowapi/issues/13\n- slowapi documentation: https://slowapi.readthedocs.io/",
  "status": "in_progress",
  "type": "bug",
  "priority": "high",
  "labels": [
    "bug",
    "server",
    "rate-limiting",
    "testing"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-021",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}