{
  "created_at": "2025-11-15T00:45:45.194814",
  "updated_at": "2025-11-20T04:23:56.240756Z",
  "id": "SOUL-113",
  "uuid": "75cc3ccc-dbf9-48a5-8f91-44a8289a96b7",
  "title": "Implement core analyze_images tool with validation",
  "description": "**As a** Consoul user\n**I want** to analyze images using natural language queries\n**So that** I can get AI insights about screenshots, diagrams, and visual content\n\n**Context:**\nThis is the core tool implementation that enables image analysis via LangChain's multimodal capabilities. It must handle file validation, base64 encoding, and proper error handling while maintaining security.\n\nBased on cursor-agent research (SOUL-92), the tool should:\n- Accept a text query and list of image paths\n- Validate file existence, type, and size\n- Encode images to base64 for API transmission\n- Return AI-generated analysis as text\n- Provide clear error messages for failures\n\n**Technical Notes:**\n- src/consoul/ai/tools/implementations/analyze_images.py - New file\n- Follow pattern in read.py (validation) and bash.py (async execution)\n- Use @tool decorator with AnalyzeImagesInput schema\n- Implement module-level config injection pattern\n- Risk Level: CAUTION (reads files, sends to external API)\n- Requires vision-capable provider (Claude 3+, GPT-4V, Gemini)\n- Max file size validation prevents huge uploads\n- Magic byte validation prevents extension spoofing\n- Path traversal protection (no \"..\" allowed)\n\n**Acceptance Criteria:**\n\n**Given** I have a valid image file at /path/to/screenshot.png\n**When** I call analyze_images(\"What error is shown?\", [\"/path/to/screenshot.png\"])\n**Then** the image is encoded and sent to the LLM for analysis\n\n**Given** I provide a non-existent image path\n**When** analyze_images is called\n**Then** ValueError is raised with \"File not found: {path}\"\n\n**Given** I provide a file larger than max_image_size_mb\n**When** analyze_images is called\n**Then** ValueError is raised with size limit message\n\n**Given** I try to access a blocked path like ~/.ssh/id_rsa\n**When** analyze_images is called\n**Then** ValueError is raised with security message\n\n**Given** I provide a .exe file with .png extension\n**When** analyze_images validates the file\n**Then** magic byte check catches the mismatch and rejects it\n\n**Testing Considerations:**\n- Mock image file reading for unit tests\n- Test with actual small test images (fixtures)\n- Mock LangChain model responses\n- Test all validation error paths\n- Test base64 encoding accuracy\n- Verify cleanup of large base64 strings\n- Test multiple images (up to max)\n\n**Implementation Hints:**\n```python\nfrom langchain_core.tools import tool\nfrom pydantic import BaseModel, Field\nimport base64\nfrom pathlib import Path\n\nclass AnalyzeImagesInput(BaseModel):\n    query: str = Field(description=\"Question or instruction about the images\")\n    image_paths: list[str] = Field(\n        description=\"List of local image file paths to analyze\",\n        min_length=1\n    )\n\n@tool(args_schema=AnalyzeImagesInput)\nasync def analyze_images(query: str, image_paths: list[str]) -> str:\n    \"\"\"Analyze images using AI vision capabilities.\"\"\"\n    config = get_analyze_images_config()\n    \n    # Validate count\n    if len(image_paths) > config.max_images_per_query:\n        raise ValueError(f\"Maximum {config.max_images_per_query} images allowed\")\n    \n    # Validate and encode each image\n    encoded_images = []\n    for path_str in image_paths:\n        path = _validate_path(path_str, config)\n        _validate_extension(path, config)\n        _validate_file_type(path)  # Magic byte check\n        _validate_size(path, config)\n        \n        # Encode to base64\n        with open(path, \"rb\") as f:\n            encoded = base64.b64encode(f.read()).decode(\"utf-8\")\n            encoded_images.append((path, encoded))\n    \n    # Return encoded images for caller to send to LLM\n    # Actual LLM invocation happens in caller (not in tool)\n    return {\"query\": query, \"images\": encoded_images}\n```\n\nFiles to create:\n- src/consoul/ai/tools/implementations/analyze_images.py\n- tests/ai/tools/implementations/test_analyze_images.py\n- tests/fixtures/test_image.png (small test image)\n\nDependencies: SOUL-112 (ImageAnalysisToolConfig)",
  "status": "todo",
  "type": "feature",
  "priority": "high",
  "labels": [
    "ai",
    "tools",
    "enhancement"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-007",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}