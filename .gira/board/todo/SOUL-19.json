{
  "created_at": "2025-11-08T16:23:28.923032",
  "updated_at": "2025-11-08T16:23:28.923044",
  "id": "SOUL-19",
  "uuid": "2c13695b-a93d-4ef0-abe8-e85b8c7f0a01",
  "title": "Environment variable and .env support",
  "description": "# Environment Variable and .env Support\n\n## User Story\n**As a** user\n**I want** to configure API keys and settings via environment variables\n**So that** I can keep secrets out of config files and easily configure different environments\n\n## Description\nImplement environment variable support and .env file loading for configuration, with special focus on secure API key handling. API keys should NEVER be stored in YAML config files, only in environment variables or .env files.\n\n## Technical Notes\n\n### Environment Variable Mapping\n\n**API Keys (Required for operation):**\n- `ANTHROPIC_API_KEY` - Anthropic Claude API key\n- `OPENAI_API_KEY` - OpenAI API key\n- `GOOGLE_API_KEY` - Google Gemini API key\n- `OLLAMA_API_BASE` - Ollama server URL (optional, default: http://localhost:11434)\n\n**Configuration Overrides:**\n- `CONSOUL_PROFILE` - Active profile name\n- `CONSOUL_MODEL_PROVIDER` - Override model provider\n- `CONSOUL_MODEL_NAME` - Override model name\n- `CONSOUL_TEMPERATURE` - Override temperature\n- `CONSOUL_MAX_TOKENS` - Override max tokens\n- `CONSOUL_HISTORY_FILE` - Override history file path\n- `CONSOUL_LOG_LEVEL` - Logging level (DEBUG, INFO, WARNING, ERROR)\n\n### .env File Support\n\n**File: `.env` (in project root or ~/.consoul/)**\n\n```bash\n# API Keys\nANTHROPIC_API_KEY=sk-ant-xxxxx\nOPENAI_API_KEY=sk-xxxxx\n\n# Configuration\nCONSOUL_PROFILE=code-review\nCONSOUL_TEMPERATURE=0.5\nCONSOUL_LOG_LEVEL=INFO\n```\n\n### Implementation\n\n**File: `consoul/config/env.py`**\n\n```python\nfrom pydantic_settings import BaseSettings, SettingsConfigDict\n\nclass EnvSettings(BaseSettings):\n    \"\"\"Environment variable settings.\"\"\"\n\n    # API Keys\n    anthropic_api_key: Optional[SecretStr] = None\n    openai_api_key: Optional[SecretStr] = None\n    google_api_key: Optional[SecretStr] = None\n    ollama_api_base: str = \"http://localhost:11434\"\n\n    # Config overrides\n    consoul_profile: Optional[str] = None\n    consoul_model_provider: Optional[str] = None\n    consoul_model_name: Optional[str] = None\n    consoul_temperature: Optional[float] = None\n    consoul_max_tokens: Optional[int] = None\n    consoul_history_file: Optional[Path] = None\n    consoul_log_level: str = \"INFO\"\n\n    model_config = SettingsConfigDict(\n        env_file=('.env', '~/.consoul/.env'),\n        env_file_encoding='utf-8',\n        case_sensitive=False,\n        extra='ignore'\n    )\n\ndef load_env_config() -> EnvSettings:\n    \"\"\"Load environment variables and .env files.\"\"\"\n    return EnvSettings()\n\ndef get_api_key(provider: str, env_settings: EnvSettings) -> str:\n    \"\"\"Get API key for provider, raise clear error if missing.\"\"\"\n    key_map = {\n        \"anthropic\": env_settings.anthropic_api_key,\n        \"openai\": env_settings.openai_api_key,\n        \"google\": env_settings.google_api_key,\n    }\n\n    key = key_map.get(provider.lower())\n    if not key or not key.get_secret_value():\n        raise ValueError(\n            f\"Missing API key for {provider}. \"\n            f\"Set {provider.upper()}_API_KEY environment variable.\"\n        )\n    return key.get_secret_value()\n```\n\n### Integration with Config Loader\n\nModify `consoul/config/loader.py`:\n\n```python\ndef load_config() -> ConsoulConfig:\n    \"\"\"Load configuration from all sources.\"\"\"\n    # 1. Load defaults (from models)\n    # 2. Load global YAML config\n    # 3. Load project YAML config\n    # 4. Load environment variables\n    # 5. Merge in precedence order\n    # 6. Apply CLI overrides (in CLI layer)\n    # 7. Validate and return\n\n    env_settings = load_env_config()\n\n    # Merge env overrides into config\n    # Get API keys on-demand when needed\n```\n\n### Security Considerations\n\n1. **Never log API keys** - Use SecretStr everywhere\n2. **Never serialize API keys** - Exclude from JSON/YAML output\n3. **Clear error messages** - Tell user exactly which key is missing\n4. **Support .env in .gitignore** - Warn if .env not in .gitignore\n5. **Validate key format** - Check basic format before API call\n\n### Error Messages\n\n**Missing API Key:**\n```\nError: Missing API key for Anthropic Claude.\n\nPlease set your API key using one of these methods:\n\n1. Environment variable:\n   export ANTHROPIC_API_KEY=sk-ant-xxxxx\n\n2. .env file (in project or ~/.consoul/):\n   ANTHROPIC_API_KEY=sk-ant-xxxxx\n\n3. Get your key from: https://console.anthropic.com/\n\nCurrent provider: anthropic\nCurrent model: claude-3-5-sonnet-20241022\n```\n\n## Acceptance Criteria\n\n**Given** `ANTHROPIC_API_KEY` environment variable is set\n**When** using Anthropic provider\n**Then** use the API key from environment\n\n**Given** `.env` file with `ANTHROPIC_API_KEY=sk-ant-xxxxx`\n**When** loading configuration\n**Then** load API key from .env file\n\n**Given** no API key for selected provider\n**When** attempting to make API call\n**Then** show clear error message with instructions\n\n**Given** `CONSOUL_PROFILE=code-review` environment variable\n**When** loading configuration\n**Then** use code-review profile (unless overridden by CLI)\n\n**Given** `CONSOUL_TEMPERATURE=0.7` environment variable\n**When** loading configuration\n**Then** override profile temperature to 0.7\n\n**Given** both environment variable and .env file have same key\n**When** loading configuration\n**Then** environment variable takes precedence\n\n**Given** API key in configuration\n**When** logging or serializing config\n**Then** API key is never exposed in logs or output\n\n**Given** .env file exists but not in .gitignore\n**When** loading configuration\n**Then** warn user that .env should be in .gitignore\n\n## Testing Considerations\n\n- Test loading from environment variables\n- Test loading from .env files\n- Test precedence (env vars > .env)\n- Test SecretStr handling\n- Test API key validation\n- Test error messages for missing keys\n- Test multi-provider key management\n- Mock environment in tests\n- Test .gitignore warning\n\n## Implementation Hints\n\n1. Use `pydantic-settings` for env var loading\n2. Use `SecretStr` for all API keys\n3. Load .env files from project root and ~/.consoul/\n4. Implement lazy API key loading (only when needed)\n5. Add clear error messages with provider URLs\n6. Consider key format validation (basic checks)\n7. Support multiple .env file locations\n\n## Files to Create/Modify\n\n- `consoul/config/env.py` - Environment variable handling\n- `consoul/config/loader.py` - Integrate env loading\n- `consoul/utils/security.py` - API key validation\n- `tests/config/test_env.py` - Env tests\n- `.env.example` - Example .env file\n- `.gitignore` - Ensure .env is ignored\n\n## Dependencies\n\n- `pydantic-settings>=2.0` - For environment variable loading\n- `python-dotenv>=1.0` - For .env file support (optional, pydantic-settings includes it)\n\n## References\n\n- [pydantic-settings Documentation](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)\n- [12-Factor App Config](https://12factor.net/config)\n- [Anthropic API Keys](https://docs.anthropic.com/en/api/getting-started)\n- [OpenAI API Keys](https://platform.openai.com/api-keys)",
  "status": "todo",
  "type": "feature",
  "priority": "high",
  "labels": [
    "config",
    "enhancement",
    "security",
    "env"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-002",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}