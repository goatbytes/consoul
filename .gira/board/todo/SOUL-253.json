{
  "created_at": "2025-12-10T00:54:23.475783",
  "updated_at": "2025-12-15T18:47:13.852725Z",
  "id": "SOUL-253",
  "uuid": "b9aaf4dd-4ac7-4b35-8708-a10ce29e6878",
  "title": "Move system prompt building to SDK layer",
  "description": "**As a** Consoul developer\n**I want** system prompt building logic in the SDK with full control over tool documentation\n**So that** prompt construction is consistent across CLI, TUI, and backend implementations AND SDK users have full control\n\n**Context:**\nCurrently, system prompt building logic exists in multiple places:\n- CLI: src/consoul/cli/chat_session.py _build_system_prompt() method\n- TUI: src/consoul/tui/app.py _build_current_system_prompt() (lines 1175-1273)\n\nAdditionally, build_system_prompt() in prompt_builder.py AUTOMATICALLY APPENDS tool documentation (lines 72-74) even when SDK users want tools enabled but don't want auto-generated tool docs in their system prompt. This prevents SDK users from having full control over their system prompts.\n\n**Critical Issue:**\nSDK users cannot use tools without getting auto-generated tool documentation appended to their system prompt. The two concerns are conflated:\n1. **Tool execution** (tool_registry on service)\n2. **Tool documentation** (auto-appended to system prompt)\n\nThese should be decoupled so SDK users can have tools enabled for execution without forced documentation.\n\n**Technical Notes:**\n- Extract from: src/consoul/cli/chat_session.py _build_system_prompt\n- Extract from: src/consoul/tui/app.py lines 1175-1273\n- Fix: src/consoul/ai/prompt_builder.py lines 72-74 (auto-append behavior)\n- Update: src/consoul/sdk/services/conversation.py from_config()\n- Include: Environment context injection (should be optional for SDK)\n- Include: Tool documentation generation (should be optional for SDK)\n- Include: Profile-specific prompt templates\n- Reference: CLI analysis identified this as business logic in UI\n\n**Acceptance Criteria:**\n\n**Given** I am an SDK user with custom system prompt\n**When** I enable tools on ConversationService\n**Then** Tool docs are NOT auto-appended unless I explicitly request them\n\n**Given** I use {AVAILABLE_TOOLS} marker in my prompt\n**When** I call build_system_prompt()\n**Then** Marker is replaced with tool documentation\n\n**Given** I use custom prompt WITHOUT marker\n**When** auto_append_tools=False\n**Then** My prompt remains unchanged (no tool docs appended)\n\n**Given** Different UIs (CLI, TUI, web) need prompts\n**When** They call the same SDK function\n**Then** Consistent prompts are generated\n\n**Given** I want tools but not auto-generated docs\n**When** I use from_config(include_tool_docs=False)\n**Then** Tools are enabled for execution but not documented in system prompt\n\n**Testing Considerations:**\n- Test prompt building without tools\n- Test prompt building with tools (auto-append enabled)\n- Test prompt building with tools (auto-append disabled)\n- Test custom system prompt without marker\n- Test custom system prompt with {AVAILABLE_TOOLS} marker\n- Test environment context inclusion (should be optional)\n- Test git info inclusion (should be optional)\n- Test profile-specific templates\n- Verify CLI and TUI generate same prompts\n- Verify SDK users can disable all auto-generation\n\n**Implementation Hints:**\n\n1. **Update build_system_prompt()** in src/consoul/ai/prompt_builder.py:\n   - Add auto_append_tools: bool = True parameter\n   - Lines 72-74: Only auto-append if auto_append_tools=True\n   - Maintain backward compatibility (default True)\n\n2. **Update ConversationService.from_config()** in src/consoul/sdk/services/conversation.py:\n   - Add custom_system_prompt: str | None = None parameter\n   - Add include_tool_docs: bool = True parameter\n   - Add include_env_context: bool = True parameter\n   - If custom_system_prompt provided, use it instead of profile prompt\n   - Pass tool_registry to build_system_prompt() only if include_tool_docs=True\n   - But always keep tool_registry on service for execution\n\n3. **Enhance system prompt building**:\n   - Support environment context injection (optional)\n   - Support git info injection (optional)\n   - Support {AVAILABLE_TOOLS} marker replacement\n   - Support auto-append fallback (optional, controlled by parameter)\n\n4. **Update CLI ChatSession** to use SDK function:\n   - Call build_system_prompt() with auto_append_tools=True (current behavior)\n   - Use environment context from profile config\n\n5. **Update TUI app.py** to use SDK function:\n   - Call build_system_prompt() with auto_append_tools=True (current behavior)\n   - Remove duplicated _build_current_system_prompt() logic\n\n**API Design (for SDK users):**\n\n```python\n# Use case 1: Tools enabled, but NO tool docs in system prompt\nservice = ConversationService.from_config(\n    custom_system_prompt=\"My custom prompt\",\n    include_tool_docs=False,  # Tools enabled, but not documented\n)\n\n# Use case 2: Tools with custom placement via marker\nservice = ConversationService.from_config(\n    custom_system_prompt=\"My prompt\\n\\n{AVAILABLE_TOOLS}\",\n    # Marker gives user control of placement\n)\n\n# Use case 3: Full control - disable all auto-generation\nservice = ConversationService.from_config(\n    include_tool_docs=False,\n    include_env_context=False,\n)\nservice.conversation.add_system_message(\"Complete control\")\n\n# Use case 4: CLI/TUI behavior (current default)\nservice = ConversationService.from_config()\n# Auto-generates: env context + tool docs (if tools enabled)\n```\n\n**Key Principle:**\nDecouple tool execution from tool documentation. SDK users should be able to:\n1. Enable tools for execution without forced documentation\n2. Add their own tool documentation in their preferred format\n3. Control all aspects of system prompt generation\n4. Maintain backward compatibility with CLI/TUI (defaults preserve current behavior)",
  "status": "todo",
  "type": "task",
  "priority": "medium",
  "labels": [
    "sdk",
    "refactor",
    "ai"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-012",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 2,
  "order": 30,
  "custom_fields": {}
}