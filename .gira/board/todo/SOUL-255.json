{
  "created_at": "2025-12-10T08:12:24.171550",
  "updated_at": "2025-12-10T08:12:24.171559",
  "id": "SOUL-255",
  "uuid": "06f7718e-adec-44de-87be-40d15342b4ed",
  "title": "Add unit tests for ConversationService",
  "description": "**As a** Consoul developer\n**I want** comprehensive unit tests for ConversationService\n**So that** business logic is testable without UI dependencies and regressions are prevented\n\n**Context:**\nAfter SOUL-245 creates ConversationService, it needs comprehensive test coverage to ensure:\n- Service works correctly in isolation\n- Business logic is properly extracted from TUI\n- No UI dependencies exist\n- All edge cases are handled\n\nTarget: 80%+ code coverage for ConversationService\n\n**Technical Notes:**\n- Create: tests/unit/sdk/services/test_conversation_service.py\n- Test: src/consoul/sdk/services/conversation.py\n- Mock: LangChain model.astream() responses\n- Mock: ConversationHistory, ToolService dependencies\n- Use: pytest, pytest-asyncio, pytest-mock\n- Dependencies: SOUL-245 (ConversationService must exist first)\n\n**Acceptance Criteria:**\n\n**Given** ConversationService exists (SOUL-245)\n**When** I run unit tests\n**Then** All core functionality is covered with 80%+ coverage\n\n**Given** Streaming responses\n**When** send_message() is called\n**Then** Mock responses are properly yielded as tokens\n\n**Given** Tool calls detected\n**When** Streaming includes tool calls\n**Then** on_tool_request callback is invoked\n\n**Given** Multimodal attachments\n**When** Images are attached\n**Then** Provider-specific formatting is tested\n\n**Testing Scope:**\n- Test send_message() basic flow\n- Test streaming token yielding\n- Test tool call detection and callbacks\n- Test multimodal message formatting (OpenAI vs Anthropic)\n- Test cost calculation during streaming\n- Test conversation history integration\n- Test error handling (network, rate limits, token limits)\n- Test context trimming\n- Test from_config() factory method\n- Test get_stats(), get_history(), clear() methods\n\n**Implementation Hints:**\n- Use pytest fixtures for ConversationService setup\n- Mock model.astream() to yield test chunks\n- Use AsyncMock for async methods\n- Create helper fixtures for common test scenarios\n- Test with different providers (OpenAI, Anthropic, Ollama)\n- Verify no Textual/Rich imports in tests\n- Test callback invocation with mock functions\n- Use parametrize for provider-specific tests",
  "status": "todo",
  "type": "task",
  "priority": "medium",
  "labels": [
    "testing",
    "sdk",
    "quality"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-012",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}