{
  "created_at": "2025-12-31T05:24:27.473624Z",
  "updated_at": "2025-12-31T05:24:27.473629Z",
  "id": "SOUL-346",
  "uuid": "fe6dc899-5d48-4554-82ae-f3d67f995a7d",
  "_version": 1,
  "title": "Add webhook patterns for async operations",
  "description": "**As a** API consumer building event-driven architectures\n**I want** webhook support for async notification of completed operations\n**So that** I can build loosely-coupled integrations without polling\n\n**Context:**\nCurrently, all Consoul API operations are synchronous or streaming. For long-running operations (batch processing, tool execution, complex conversations), polling is the only option. Webhooks would enable:\n- Event-driven architectures\n- Reduced API calls (no polling)\n- Reliable delivery with retries\n- Integration with serverless functions\n\n**Technical Notes:**\n- Current async pattern: WebSocket streaming, but requires persistent connection\n- Session store: Can store webhook URLs per session\n- Similar patterns: Stripe webhooks, GitHub webhooks, Twilio callbacks\n\n**Proposed Webhook System:**\n\n**1. Webhook Registration**\n```\nPOST /webhooks\n{\n  \"url\": \"https://myapp.com/callbacks/consoul\",\n  \"events\": [\"chat.completed\", \"tool.executed\", \"session.expired\"],\n  \"secret\": \"whsec_...\",  // For signature verification\n  \"metadata\": {\"customer_id\": \"cus_123\"}\n}\n```\n\n**2. Event Types**\n- `chat.completed` - Chat response fully generated\n- `chat.error` - Chat request failed\n- `tool.requested` - Tool approval needed (alternative to SSE)\n- `tool.executed` - Tool finished execution\n- `session.created` - New session initialized\n- `session.expired` - Session TTL reached\n- `batch.completed` - Batch request finished (SOUL-339)\n\n**3. Webhook Payload**\n```json\n{\n  \"id\": \"evt_abc123\",\n  \"type\": \"chat.completed\",\n  \"created\": \"2024-12-30T10:00:00Z\",\n  \"data\": {\n    \"session_id\": \"user-abc123\",\n    \"response\": \"Hello! How can I help?\",\n    \"usage\": {\n      \"input_tokens\": 15,\n      \"output_tokens\": 8\n    }\n  },\n  \"metadata\": {\"customer_id\": \"cus_123\"}\n}\n```\n\n**4. Signature Verification**\n```python\n# Header: X-Consoul-Signature: t=1234567890,v1=sha256...\nimport hmac\nimport hashlib\n\ndef verify_webhook(payload: bytes, signature: str, secret: str) -> bool:\n    timestamp, sig = parse_signature(signature)\n    expected = hmac.new(\n        secret.encode(),\n        f\"{timestamp}.{payload.decode()}\".encode(),\n        hashlib.sha256\n    ).hexdigest()\n    return hmac.compare_digest(sig, expected)\n```\n\n**5. Delivery & Retry Policy**\n- Initial delivery: Immediate\n- Retry schedule: 1m, 5m, 30m, 2h, 24h (exponential backoff)\n- Success: 2xx response within 30 seconds\n- Failure: Log, retry, eventually disable webhook\n- Dead letter: Store failed events for replay\n\n**6. Management Endpoints**\n```\nGET /webhooks                    # List webhooks\nGET /webhooks/{id}               # Get webhook details\nPATCH /webhooks/{id}             # Update webhook\nDELETE /webhooks/{id}            # Delete webhook\nGET /webhooks/{id}/deliveries    # Delivery history\nPOST /webhooks/{id}/test         # Send test event\n```\n\n**Acceptance Criteria:**\n\n**Given** a webhook is registered for chat.completed\n**When** a /chat request completes\n**Then** a signed webhook is delivered to the registered URL\n\n**Given** webhook delivery fails (5xx or timeout)\n**When** retries are attempted\n**Then** exponential backoff is followed\n\n**Given** a webhook consistently fails\n**When** retry limit is reached\n**Then** webhook is disabled and notification sent\n\n**Given** webhook has a secret configured\n**When** receiving the webhook\n**Then** signature can be verified using the documented algorithm\n\n**Given** a developer needs to debug webhooks\n**When** accessing /webhooks/{id}/deliveries\n**Then** recent delivery attempts and responses are visible\n\n**Testing Considerations:**\n- Unit tests: Signature generation and verification\n- Integration tests: End-to-end webhook delivery\n- Mock webhook endpoint for testing\n- Test retry behavior with simulated failures\n- Verify idempotency (duplicate delivery handling)\n\n**Implementation Hints:**\n- Create `src/consoul/server/webhooks/` module\n- Use `httpx.AsyncClient` for webhook delivery\n- Store webhooks in Redis or separate DB\n- Consider background task queue (Celery, arq) for reliability\n- Add webhook metrics: deliveries, failures, latency\n- Reference Stripe webhook implementation patterns\n- Consider offering webhook.site integration for testing\n- Add SDK helper: `consoul.webhooks.verify(payload, signature, secret)`",
  "status": "todo",
  "type": "feature",
  "priority": "medium",
  "labels": [
    "api",
    "enhancement",
    "server",
    "integrations"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-021",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 13,
  "order": 0,
  "custom_fields": {}
}