{
  "created_at": "2026-01-01T10:46:39.257615Z",
  "updated_at": "2026-01-01T22:33:47.443554Z",
  "id": "SOUL-358",
  "uuid": "8c203443-1ac1-4ea8-826e-b071426e92c2",
  "_version": 2,
  "title": "Fix 59 mypy type errors across 11 source files",
  "description": "**As a** Consoul developer\n**I want** all mypy type errors to be resolved\n**So that** the codebase maintains strict type safety, CI passes reliably, and the code is easier to maintain and refactor\n\n**Context:**\nRunning `mypy src/consoul --ignore-missing-imports` currently reports 59 errors across 11 files. The project uses mypy in strict mode (configured in `pyproject.toml` lines 378-394) which enforces:\n- `strict = true`\n- `disallow_untyped_defs = true`\n- `warn_unused_ignores = true` (causing 28 of the 59 errors)\n\nMany errors are from outdated `# type: ignore` comments that are no longer needed after library updates or code changes. Other errors indicate genuine type mismatches that should be fixed.\n\n**Error Breakdown by Category:**\n| Error Code | Count | Description |\n|------------|-------|-------------|\n| `[unused-ignore]` | 28 | Stale `# type: ignore` comments |\n| `[assignment]` | 8 | Type mismatches in assignments |\n| `[no-untyped-call]` | 6 | Calling untyped external functions |\n| `[attr-defined]` | 5 | Accessing undefined attributes |\n| `[untyped-decorator]` | 3 | Decorators making functions untyped |\n| `[misc]` | 3 | Read-only properties, unpacking issues |\n| `[arg-type]` | 3 | Incorrect argument types |\n| `[dict-item]` | 2 | Dict value type mismatches |\n| `[call-arg]` | 1 | Missing required argument |\n\n**Affected Files (by error count):**\n1. `src/consoul/server/factory.py` - 12 errors (9 unused-ignore + 3 untyped-decorator)\n2. `src/consoul/server/webhooks/router.py` - 8 errors (all unused-ignore)\n3. `src/consoul/commands/describe.py` - 12 errors (7 unused-ignore + 5 assignment)\n4. `src/consoul/ai/providers.py` - 6 errors (4 unused-ignore + 2 no-untyped-call)\n5. `src/consoul/__main__.py` - 4 errors (3 attr-defined on ChatSession.history + 1 assignment)\n6. `src/consoul/server/middleware/rate_limit.py` - 5 errors (arg-type, dict-item, no-untyped-call)\n7. `src/consoul/cli/command_processor.py` - 4 errors (2 read-only property + 2 no-untyped-call)\n8. `src/consoul/cli/chat_session.py` - 1 error (arg-type ConsoulTuiConfig vs ConsoulCoreConfig)\n9. `src/consoul/ai/mlx_chat_wrapper.py` - 3 errors (attr-defined, misc unpacking)\n10. `src/consoul/ai/tokenizers.py` - 1 error (no-untyped-call AutoTokenizer)\n11. `src/consoul/ai/tools/implementations/wikipedia.py` - 1 error (missing wiki_client arg)\n\n**Technical Notes:**\n\n**1. Unused `type: ignore` comments (28 errors):**\nRemove outdated ignore comments in:\n- `src/consoul/server/factory.py:642,681,781-782,941-942,1241,1324-1325`\n- `src/consoul/server/webhooks/router.py:136,192,212,247,315,353,393,510`\n- `src/consoul/commands/describe.py:169-171,178,184,190,195`\n- `src/consoul/ai/providers.py:1533,1793,1856,1925`\n\n**2. ChatSession.history attribute errors (`src/consoul/__main__.py:1024-1027`):**\n```python\nif hasattr(session.history, \"messages\") and session.history.messages:\n```\n`ChatSession` class (defined in `src/consoul/cli/chat_session.py`) does not expose a `history` attribute. The code should access conversation history through `session.conversation_service.conversation.messages` or add a `history` property to `ChatSession`.\n\n**3. Read-only property assignments (`src/consoul/cli/command_processor.py:330,336`):**\n```python\nsession.config.current_provider = detected_provider  # Error: read-only\nsession.config.current_model = model_name  # Error: read-only\n```\n`ConsoulTuiConfig.current_provider` and `current_model` are properties (lines 191-198 in `src/consoul/tui/config.py`) that delegate to `self.core`. Either add setters or modify `session.config.core.current_provider` directly.\n\n**4. Config type mismatch (`src/consoul/cli/chat_session.py:96`):**\n```python\nConversationService.from_config(config, ...)  # config: ConsoulTuiConfig\n```\n`from_config()` expects `ConsoulCoreConfig | None`, but receives `ConsoulTuiConfig`. Pass `config.core` instead.\n\n**5. rate_limit.py type issues (lines 105-136):**\n- `Limiter(default_limits=...)` expects `list[str | Callable[..., str]]` - use `Sequence` or cast\n- `storage_options` dict has `int` values but signature expects `str` - convert to strings\n- `add_exception_handler` signature mismatch - add `Awaitable` return type or use `async def`\n\n**6. MLX module attribute errors (`src/consoul/ai/mlx_chat_wrapper.py`):**\n- Line 69: `mlx_lm.load` not explicitly exported - use `# type: ignore[attr-defined]` or conditional import\n- Line 77: Unpacking returns 3 values now (model, tokenizer, config) - update unpacking\n- Line 106: `mlx_lm.generate` not exported - same fix as load\n\n**7. Wikipedia tool missing argument (`src/consoul/ai/tools/implementations/wikipedia.py:134`):**\n`WikipediaAPIWrapper` now requires `wiki_client` - check LangChain community version and provide required argument.\n\n**8. Untyped decorator errors (`src/consoul/server/factory.py`):**\nThe `@limiter.limit()` decorator from slowapi is untyped, making `chat`, `chat_batch`, `chat_stream` functions untyped. Options:\n- Add `# type: ignore[untyped-decorator]` to these specific lines\n- Create typed wrapper for limiter decorator\n- Wait for slowapi to add type stubs\n\n**Acceptance Criteria:**\n\n**Given** the Consoul codebase with 59 mypy errors\n**When** running `mypy src/consoul --ignore-missing-imports`\n**Then** zero errors should be reported\n\n**Given** the fix for unused type: ignore comments\n**When** reviewing the affected files\n**Then** only necessary `# type: ignore` comments remain with specific error codes\n\n**Given** the fix for ChatSession.history access\n**When** calling the stats/cost display code in `__main__.py`\n**Then** it correctly accesses conversation history without AttributeError\n\n**Given** the config property fixes\n**When** using `/model` command to switch models\n**Then** the model switch succeeds without type errors at runtime\n\n**Given** the MLX wrapper fixes\n**When** using MLX provider with Apple Silicon\n**Then** model loading and generation work correctly\n\n**Testing Considerations:**\n- Run `mypy src/consoul --ignore-missing-imports` to verify all errors resolved\n- Run `mypy src/consoul` (full check) to ensure no new missing import issues\n- Run existing test suite: `pytest tests/ -v`\n- Manual test `/model` command switching in TUI\n- Manual test MLX provider if on Apple Silicon\n- Verify CI pipeline passes mypy check\n\n**Implementation Hints:**\n1. Start with unused-ignore errors (28) - simply remove the comments\n2. For `[no-untyped-call]` on external libs, add targeted `# type: ignore[no-untyped-call]`\n3. For ChatSession, add a `@property def history(self)` that returns `self.conversation_service.conversation`\n4. For config properties, either add setters or modify the underlying `core` object\n5. For rate_limit.py, cast types or update function signatures\n6. For MLX, update to handle 3-tuple return value and add appropriate ignores for missing stubs\n7. For Wikipedia tool, check `langchain_community.utilities.WikipediaAPIWrapper` signature and provide required args\n8. Document any remaining `# type: ignore` comments with specific error codes and explanations",
  "status": "todo",
  "type": "bug",
  "priority": "high",
  "labels": [
    "technical-debt",
    "testing",
    "core",
    "ai",
    "server",
    "cli"
  ],
  "assignee": "jared@goatbytes.io",
  "reporter": "jared@goatbytes.io",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}