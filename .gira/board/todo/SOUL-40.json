{
  "created_at": "2025-11-09T20:14:21.579950",
  "updated_at": "2025-11-09T20:14:21.579958",
  "id": "SOUL-40",
  "uuid": "daf6df01-636b-4bd9-88ce-b598dbba2882",
  "title": "Create ConversationList sidebar with virtualization",
  "description": "# Create ConversationList Sidebar with Virtualization\n\n## User Story\n**As a** Consoul user\n**I want** a sidebar showing my conversation history\n**So that** I can quickly switch between different AI conversations\n\n## Description\n\nCreate the ConversationList widget that displays conversation history in a sidebar using virtualized DataTable for performance with 1000+ conversations. Implements search-first UX with FTS5 integration.\n\n## Context\n\nFrom TUI_RESEARCH.md ยง6.3 \"Conversation List Virtualization\":\n- Use DataTable with virtual scrolling\n- Load 50 conversations initially\n- Lazy load on scroll\n- FTS5 search integration\n- Show conversation preview and metadata\n\n**Key Reference:** TUI_RESEARCH.md ยง6.3\n\n## Technical Notes\n\n**File:** `src/consoul/tui/widgets/conversation_list.py`\n\n```python\nfrom textual.widgets import DataTable\nfrom textual.containers import Container\nfrom textual.message import Message\nfrom textual.reactive import reactive\nfrom consoul.db.manager import DatabaseManager\n\n\nclass ConversationList(Container):\n    \"\"\"Conversation history sidebar with virtualized list.\n    \n    Displays conversation titles with search and lazy loading for performance.\n    \"\"\"\n    \n    class ConversationSelected(Message):\n        \"\"\"Message sent when a conversation is selected.\"\"\"\n        \n        def __init__(self, conversation_id: str) -> None:\n            super().__init__()\n            self.conversation_id = conversation_id\n    \n    # Reactive state\n    conversation_count: reactive[int] = reactive(0)\n    selected_id: reactive[str | None] = reactive(None)\n    \n    INITIAL_LOAD = 50  # Conversations to load initially\n    \n    def __init__(self, db_manager: DatabaseManager, **kwargs) -> None:\n        super().__init__(**kwargs)\n        self.db = db_manager\n        self.table = DataTable()\n        self.loaded_count = 0\n    \n    def compose(self) -> ComposeResult:\n        \"\"\"Compose conversation list widgets.\"\"\"\n        yield self.table\n    \n    def on_mount(self) -> None:\n        \"\"\"Initialize conversation list on mount.\"\"\"\n        self.border_title = \"Conversations\"\n        self.add_class(\"conversation-list\")\n        \n        # Setup table columns\n        self.table.add_column(\"Title\", key=\"title\")\n        self.table.add_column(\"Date\", key=\"date\", width=12)\n        \n        # Load initial conversations\n        self.load_conversations()\n    \n    def load_conversations(self, limit: int | None = None) -> None:\n        \"\"\"Load conversations from database.\n        \n        Args:\n            limit: Number of conversations to load (default: INITIAL_LOAD)\n        \"\"\"\n        limit = limit or self.INITIAL_LOAD\n        \n        # Fetch from database\n        conversations = self.db.get_recent_conversations(\n            limit=limit,\n            offset=self.loaded_count\n        )\n        \n        for conv in conversations:\n            self.table.add_row(\n                conv[\"title\"] or \"Untitled\",\n                conv[\"created_at\"].strftime(\"%Y-%m-%d\"),\n                key=conv[\"id\"]\n            )\n            self.loaded_count += 1\n        \n        self.conversation_count = self.loaded_count\n        self._update_title()\n    \n    def _update_title(self) -> None:\n        \"\"\"Update border title with count.\"\"\"\n        self.border_title = f\"Conversations ({self.conversation_count})\"\n    \n    def on_data_table_row_selected(self, event: DataTable.RowSelected) -> None:\n        \"\"\"Handle conversation selection.\"\"\"\n        conversation_id = event.row_key.value\n        self.selected_id = conversation_id\n        self.post_message(self.ConversationSelected(conversation_id))\n    \n    async def search(self, query: str) -> None:\n        \"\"\"Search conversations using FTS5.\n        \n        Args:\n            query: Search query string\n        \"\"\"\n        if not query.strip():\n            # Empty query - reload all\n            self.table.clear()\n            self.loaded_count = 0\n            self.load_conversations()\n            return\n        \n        # FTS5 search\n        results = self.db.search_conversations(query)\n        \n        # Clear and populate with results\n        self.table.clear()\n        self.loaded_count = 0\n        \n        for conv in results:\n            self.table.add_row(\n                conv[\"title\"] or \"Untitled\",\n                conv[\"created_at\"].strftime(\"%Y-%m-%d\"),\n                key=conv[\"id\"]\n            )\n        \n        self.conversation_count = len(results)\n        self._update_title()\n    \n    def on_data_table_scrolled(self, event: DataTable.Scrolled) -> None:\n        \"\"\"Load more conversations when scrolled near bottom.\"\"\"\n        # Check if near bottom (within 10 rows)\n        if event.y > self.table.row_count - 10:\n            self.load_conversations(limit=50)  # Load next batch\n```\n\n**CSS:**\n\n```css\nConversationList {\n    width: 30%;\n    min-width: 30;\n    max-width: 60;\n    height: 100%;\n    background: $surface-darken-1;\n    border-right: solid $accent;\n    padding: 1;\n}\n\nConversationList DataTable {\n    background: $surface-darken-1;\n}\n\nConversationList DataTable > .datatable--cursor {\n    background: $primary;\n}\n```\n\n## Acceptance Criteria\n\n**Given** I mount ConversationList\n**When** it initializes\n**Then** it loads 50 conversations and displays them\n\n**Given** there are 100+ conversations\n**When** I scroll to the bottom\n**Then** next batch of 50 conversations loads\n\n**Given** I enter a search query\n**When** FTS5 search executes\n**Then** filtered conversations are displayed\n\n**Given** I select a conversation row\n**When** I click or press Enter\n**Then** ConversationSelected message is posted\n\n**Given** there are 200 conversations\n**When** view is displayed\n**Then** virtual scrolling maintains smooth performance\n\n## Testing Considerations\n\n**Test File:** `tests/tui/widgets/test_conversation_list.py`\n\n```python\nfrom consoul.tui.widgets.conversation_list import ConversationList\nfrom consoul.db.manager import DatabaseManager\n\n\nasync def test_conversation_list_loads():\n    \"\"\"Test initial conversation load.\"\"\"\n    db = DatabaseManager(\":memory:\")\n    # Create test conversations\n    for i in range(100):\n        db.create_conversation(title=f\"Chat {i}\")\n    \n    widget = ConversationList(db_manager=db)\n    await widget.on_mount()\n    \n    assert widget.loaded_count == 50  # Initial load\n    assert widget.table.row_count == 50\n\n\nasync def test_lazy_loading():\n    \"\"\"Test lazy loading on scroll.\"\"\"\n    db = DatabaseManager(\":memory:\")\n    for i in range(100):\n        db.create_conversation(title=f\"Chat {i}\")\n    \n    widget = ConversationList(db_manager=db)\n    await widget.on_mount()\n    \n    # Simulate scroll to bottom\n    widget.load_conversations(limit=50)\n    \n    assert widget.loaded_count == 100\n\n\nasync def test_search():\n    \"\"\"Test FTS5 conversation search.\"\"\"\n    db = DatabaseManager(\":memory:\")\n    db.create_conversation(title=\"Python tutorial\")\n    db.create_conversation(title=\"JavaScript guide\")\n    db.create_conversation(title=\"Python advanced\")\n    \n    widget = ConversationList(db_manager=db)\n    await widget.on_mount()\n    \n    await widget.search(\"Python\")\n    \n    assert widget.table.row_count == 2  # Only Python matches\n\n\nasync def test_conversation_selection():\n    \"\"\"Test selecting a conversation.\"\"\"\n    db = DatabaseManager(\":memory:\")\n    conv_id = db.create_conversation(title=\"Test\")\n    \n    widget = ConversationList(db_manager=db)\n    await widget.on_mount()\n    \n    # Simulate selection\n    # (event handling test)\n```\n\n## Implementation Hints\n\n1. Start with Container holding DataTable\n2. Implement initial load (50 conversations)\n3. Add lazy loading on scroll\n4. Integrate FTS5 search\n5. Add row selection handler\n6. Test with large datasets (1000+ conversations)\n7. Measure scroll performance\n\n**Performance Testing:**\n\n```python\nasync def test_large_dataset_performance():\n    \"\"\"Test performance with 1000+ conversations.\"\"\"\n    db = DatabaseManager(\":memory:\")\n    \n    # Create 2000 conversations\n    for i in range(2000):\n        db.create_conversation(title=f\"Chat {i}\")\n    \n    widget = ConversationList(db_manager=db)\n    \n    start = time.time()\n    await widget.on_mount()\n    elapsed = time.time() - start\n    \n    # Should load quickly (virtualized)\n    assert elapsed < 0.5  # 500ms\n```\n\n## Files to Create/Modify\n\n**New Files:**\n- src/consoul/tui/widgets/conversation_list.py\n- tests/tui/widgets/test_conversation_list.py\n\n**Modified Files:**\n- src/consoul/tui/widgets/__init__.py\n- src/consoul/tui/css/main.tcss\n\n## Dependencies\n\n**Prerequisites:**\n- SOUL-27 complete (SQLite conversation database)\n- SOUL-29 complete (FTS5 search)\n- SOUL-32 complete (widgets/ directory)\n\n**Blocks:**\n- SOUL-42 (Database integration wires this up)",
  "status": "todo",
  "type": "feature",
  "priority": "medium",
  "labels": [
    "tui",
    "widgets",
    "virtualization"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-003",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 8,
  "order": 0,
  "custom_fields": {}
}