{
  "created_at": "2025-11-10T20:07:48.455770",
  "updated_at": "2025-11-10T20:07:48.455778",
  "id": "SOUL-66",
  "uuid": "91b363a2-e894-4bd9-8e17-ad70a05f53e8",
  "title": "Create headless approval API with callback system for SDK integration",
  "description": "**As a** developer integrating Consoul as an SDK\n**I want** a headless approval API with callbacks\n**So that** I can implement tool approval in my own UI without requiring the Textual TUI\n\n**Context:**\nConsoul's primary purpose is SDK integration into other projects (like Gira). Tool approval cannot be TUI-only - it must expose a backend API that host applications can use to implement their own approval UX (CLI prompts, web UI, IDE dialogs, etc.).\n\nThe approval system needs clean separation:\n- **Core approval logic** (AI-agnostic, UI-agnostic) in consoul.ai.tools\n- **Approval callbacks/hooks** for host applications to implement\n- **Optional TUI implementation** that sits on top of the core API\n\nThis is the foundation that SOUL-59 (TUI modal) will build upon, not replace.\n\n**Technical Notes:**\n- Create ApprovalProvider protocol/ABC that TUI and SDK consumers implement\n- Approval request should be a dataclass/Pydantic model\n- Support async callbacks for non-blocking approval flows\n- Must work without any TUI imports\n- Store in src/consoul/ai/tools/approval.py (not in tui/)\n- Document extension points for custom approval implementations\n\n**Acceptance Criteria:**\n\n**Given** I'm using Consoul as an SDK without TUI\n**When** AI requests a tool execution\n**Then** my custom approval callback is invoked\n\n**Given** I implement ApprovalProvider in my host app\n**When** I register my approval handler\n**Then** tool execution uses my handler instead of default\n\n**Given** approval callback is async\n**When** tool approval is requested\n**Then** tool execution waits for callback response without blocking\n\n**Given** no approval provider is registered\n**When** tool execution is requested\n**Then** clear error indicates approval provider is required\n\n**Given** approval is denied via callback\n**When** denial is returned\n**Then** ToolMessage with denial reason is created\n\n**Given** TUI is available and no custom provider set\n**When** tool approval is needed\n**Then** TUI modal is used as fallback (optional dependency)\n\n**Testing Considerations:**\n- Unit test approval protocol/ABC\n- Mock approval providers for testing\n- Test async callback flows\n- Test approval denial/timeout\n- Integration test with actual tool execution\n- Test without TUI installed (ensure no import errors)\n\n**Implementation Hints:**\n- Approval protocol:\n  ```python\n  from typing import Protocol\n  \n  @dataclass\n  class ToolApprovalRequest:\n      tool_name: str\n      arguments: dict[str, Any]\n      risk_level: RiskLevel\n      tool_call_id: str\n      context: dict[str, Any]  # For host app metadata\n  \n  @dataclass\n  class ToolApprovalResponse:\n      approved: bool\n      reason: str | None = None\n      timeout: int | None = None  # Override default timeout\n  \n  class ApprovalProvider(Protocol):\n      async def request_approval(\n          self, request: ToolApprovalRequest\n      ) -> ToolApprovalResponse:\n          ...\n  ```\n- Registry integration:\n  ```python\n  class ToolRegistry:\n      def __init__(self, approval_provider: ApprovalProvider | None = None):\n          self.approval_provider = approval_provider or self._get_default()\n      \n      def _get_default(self) -> ApprovalProvider:\n          try:\n              from consoul.tui.tools import TuiApprovalProvider\n              return TuiApprovalProvider()\n          except ImportError:\n              raise RuntimeError(\n                  'No approval provider set and TUI not available. '\n                  'Provide approval_provider to ToolRegistry.'\n              )\n  ```\n- CLI approval provider example:\n  ```python\n  class CliApprovalProvider:\n      async def request_approval(\n          self, request: ToolApprovalRequest\n      ) -> ToolApprovalResponse:\n          print(f'Tool: {request.tool_name}')\n          print(f'Args: {request.arguments}')\n          response = input('Approve? (y/n): ')\n          return ToolApprovalResponse(\n              approved=response.lower() == 'y'\n          )\n  ```\n\n**Files to Create:**\n- src/consoul/ai/tools/approval.py (core approval API)\n- src/consoul/ai/tools/providers/ (approval provider implementations)\n- src/consoul/ai/tools/providers/cli.py (CLI approval example)\n\n**Files to Modify:**\n- src/consoul/ai/tools/registry.py (integrate approval provider)\n\n**Dependencies:**\n- SOUL-58 (Tool registry)\n\n**Blocks:**\n- SOUL-59 (TUI modal depends on this API)\n- SOUL-62 (Execution flow uses approval API)\n\nStory Points: 5",
  "status": "todo",
  "type": "feature",
  "priority": "critical",
  "labels": [
    "ai",
    "tools",
    "sdk",
    "api",
    "enhancement"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-004",
  "blocked_by": [],
  "blocks": [],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "order": 0,
  "custom_fields": {}
}