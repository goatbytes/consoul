{
  "created_at": "2025-11-13T08:38:57.330509",
  "updated_at": "2025-11-13T16:49:49.003709Z",
  "id": "SOUL-80",
  "uuid": "0b5dd5ba-0f53-48bd-ae50-9fb28dfd16a3",
  "title": "Implement core read_file tool with line numbering",
  "description": "**As a** Consoul user and AI agent\n**I want** to read file contents with line numbers and line-range control\n**So that** AI can access codebase files, documentation, and configuration for better context\n\n**Context:**\nThis is the core read tool implementation that enables AI agents to safely read text files. Research shows that successful read tools (Claude Code, Cursor, MCP servers) share these features:\n- Line-numbered output for reference (cat -n style)\n- Offset/limit parameters for large files\n- Encoding fallback for non-UTF-8 files\n- Path security validation\n- Clear error messages\n\nThe tool should be classified as RiskLevel.SAFE since it's read-only and requires no user approval (matching Claude Code behavior).\n\n**IMPORTANT**: This ticket focuses on BASELINE read semantics only. Truncation controls (max_line_length, max_output_chars) are handled entirely by SOUL-82. Keep this implementation focused on reading, encoding, security, and line numbering.\n\n**Research References:**\n- Claude Code Read tool: 2000 line default, line numbering, multimodal support\n- Cursor agent: github.com/The-Pocket/PocketFlow-Tutorial-Cursor/utils/read_file.py\n- MCP filesystem server: Path validation, MIME detection\n- Consoul bash tool pattern: src/consoul/ai/tools/implementations/bash.py\n\n**Technical Notes:**\n- Create: src/consoul/ai/tools/implementations/read.py\n- Use LangChain @tool decorator with Pydantic input schema\n- Module-level config pattern (like bash.py lines 28-51):\n  - _TOOL_CONFIG: ReadToolConfig | None = None\n  - set_read_config(config: ReadToolConfig) -> None\n  - get_read_config() -> ReadToolConfig\n- Line numbering: {line_num:6d}\\\\t{content} (Claude Code style)\n- Encoding fallback: UTF-8 → UTF-8-sig → Latin-1\n- Path security: Block .., /etc/shadow, /proc, /dev, /sys\n- Export from src/consoul/ai/tools/implementations/__init__.py\n- **Do NOT implement truncation here** - that's SOUL-82's responsibility\n\n**Acceptance Criteria:**\n\n**Given** I request to read a text file\n**When** the AI calls read_file(file_path=\"src/main.py\")\n**Then** file contents are returned with 1-based line numbers\n\n**Given** a large file (5000 lines)\n**When** I read with offset=100, limit=50\n**Then** only lines 100-149 are returned with correct line numbers\n\n**Given** a file with non-UTF-8 encoding\n**When** read_file is called\n**Then** encoding fallback succeeds and content is readable\n\n**Given** an attempt to read /etc/shadow or use ../../../\n**When** read_file is called with malicious path\n**Then** security validation blocks the read with clear error\n\n**Given** an empty file\n**When** read_file is called\n**Then** returns \"[File is empty]\" message\n\n**Given** a binary file (.exe, .zip)\n**When** read_file is called\n**Then** returns \"Unsupported binary file format\" error\n\n**Testing Considerations:**\n- Mock file system for security tests\n- Test with various encodings (UTF-8, UTF-8-BOM, Latin-1)\n- Test offset/limit edge cases (beyond EOF, negative values)\n- Test path validation extensively\n- Test empty files, missing files, directories\n- Test line number formatting consistency\n- **Truncation testing is in SOUL-82**\n\n**Implementation Hints:**\n```python\nfrom langchain_core.tools import tool\nfrom pydantic import BaseModel, Field\nfrom pathlib import Path\n\nclass ReadFileInput(BaseModel):\n    file_path: str = Field(description=\"Path to file\")\n    offset: int | None = Field(None, description=\"Start line (1-indexed)\")\n    limit: int | None = Field(None, description=\"Number of lines\")\n\n@tool(args_schema=ReadFileInput)\ndef read_file(file_path: str, offset: int | None = None, limit: int | None = None) -> str:\n    \"\"\"Read file contents with line numbers.\"\"\"\n    config = get_read_config()\n    # Implementation - NO truncation logic here\n    # Just read, encode, validate, and number lines\n    # SOUL-82 will add truncation wrapper\n```\n- Use Path.resolve() for absolute paths\n- Check blocked_paths before reading\n- Apply max_lines_default from config if no limit specified\n- Handle FileNotFoundError, PermissionError, UnicodeDecodeError\n- Return user-friendly error messages (not exceptions)\n- Return raw output - truncation happens in SOUL-82",
  "status": "todo",
  "type": "feature",
  "priority": "high",
  "labels": [
    "tools",
    "ai",
    "enhancement",
    "filesystem"
  ],
  "reporter": "jared@goatbytes.io",
  "epic_id": "EPIC-005",
  "blocked_by": [
    "SOUL-79"
  ],
  "blocks": [
    "SOUL-81",
    "SOUL-82",
    "SOUL-83",
    "SOUL-85"
  ],
  "comments": [],
  "attachments": [],
  "attachment_count": 0,
  "comment_count": 0,
  "story_points": 5,
  "order": 0,
  "custom_fields": {}
}