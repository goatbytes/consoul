<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consoul Chat</title>
    <!-- Highlight.js theme (GitHub Dark) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 1rem;
            background: #16213e;
            border-bottom: 1px solid #0f3460;
        }
        header h1 { font-size: 1.25rem; }
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .user {
            align-self: flex-end;
            background: #0f3460;
            white-space: pre-wrap;
        }
        .assistant {
            align-self: flex-start;
            background: #1a1a2e;
            border: 1px solid #0f3460;
        }
        /* Markdown content styling */
        .assistant p { margin: 0.5em 0; }
        .assistant p:first-child { margin-top: 0; }
        .assistant p:last-child { margin-bottom: 0; }
        .assistant ul, .assistant ol { margin: 0.5em 0; padding-left: 1.5em; }
        .assistant li { margin: 0.25em 0; }
        .assistant code {
            background: #0d0d1a;
            padding: 0.15em 0.4em;
            border-radius: 0.25rem;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.9em;
        }
        .assistant pre {
            background: #0d0d1a;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.75rem 0;
        }
        .assistant pre code {
            background: none;
            padding: 0;
            font-size: 0.85em;
            line-height: 1.5;
        }
        .assistant blockquote {
            border-left: 3px solid #e94560;
            padding-left: 1rem;
            margin: 0.5em 0;
            color: #aaa;
        }
        .assistant a { color: #e94560; }
        .assistant a:hover { color: #ff6b6b; }
        .assistant h1, .assistant h2, .assistant h3 {
            margin: 0.75em 0 0.5em;
            font-weight: 600;
        }
        .assistant h1:first-child, .assistant h2:first-child, .assistant h3:first-child {
            margin-top: 0;
        }
        .assistant table {
            border-collapse: collapse;
            margin: 0.5em 0;
            width: 100%;
        }
        .assistant th, .assistant td {
            border: 1px solid #0f3460;
            padding: 0.5em;
            text-align: left;
        }
        .assistant th { background: #16213e; }
        /* Streaming text (pre-markdown) */
        .assistant.streaming {
            white-space: pre-wrap;
        }
        #input-area {
            padding: 1rem;
            background: #16213e;
            border-top: 1px solid #0f3460;
            display: flex;
            gap: 0.5rem;
        }
        #message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #0f3460;
            border-radius: 0.5rem;
            background: #1a1a2e;
            color: #eee;
            font-size: 1rem;
        }
        #message-input:focus {
            outline: none;
            border-color: #e94560;
        }
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: #e94560;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        button:hover { background: #ff6b6b; }
        button:disabled { background: #555; cursor: not-allowed; }
        #status {
            font-size: 0.75rem;
            color: #888;
            padding: 0.25rem 1rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Consoul Chat</h1>
    </header>
    <div id="chat"></div>
    <div id="status">Disconnected</div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="Type a message..." autofocus>
        <button id="send-btn">Send</button>
    </div>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/core.min.js"></script>
    <!-- Common languages -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/markdown.min.js"></script>

    <script>
        // Configure marked with highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        const chat = document.getElementById('chat');
        const input = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const status = document.getElementById('status');

        let ws = null;
        let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
        let currentAssistantMsg = null;
        let currentRawText = '';  // Accumulate raw text during streaming

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/chat/${sessionId}`);

            ws.onopen = () => {
                status.textContent = 'Connected';
                status.style.color = '#4ade80';
                sendBtn.disabled = false;
            };

            ws.onclose = () => {
                status.textContent = 'Disconnected - Reconnecting...';
                status.style.color = '#f87171';
                sendBtn.disabled = true;
                setTimeout(connect, 2000);
            };

            ws.onerror = () => {
                status.textContent = 'Connection error';
                status.style.color = '#f87171';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'token':
                    if (!currentAssistantMsg) {
                        currentAssistantMsg = addMessage('', 'assistant', true);
                        currentRawText = '';
                    }
                    // Accumulate raw text and show as plain text during streaming
                    currentRawText += data.data.text;
                    currentAssistantMsg.textContent = currentRawText;
                    chat.scrollTop = chat.scrollHeight;
                    break;

                case 'done':
                    if (currentAssistantMsg && currentRawText) {
                        // Render final markdown when streaming completes
                        renderMarkdown(currentAssistantMsg, currentRawText);
                    }
                    currentAssistantMsg = null;
                    currentRawText = '';
                    sendBtn.disabled = false;
                    input.disabled = false;
                    input.focus();
                    break;

                case 'error':
                    addMessage('Error: ' + data.data.message, 'assistant');
                    currentAssistantMsg = null;
                    currentRawText = '';
                    sendBtn.disabled = false;
                    input.disabled = false;
                    break;

                case 'tool_approval_request':
                    // Auto-approve for this demo (in production, show UI)
                    ws.send(JSON.stringify({
                        type: 'tool_approval',
                        id: data.data.id,
                        approved: true
                    }));
                    break;
            }
        }

        function renderMarkdown(element, text) {
            element.classList.remove('streaming');
            element.innerHTML = marked.parse(text);
            // Re-highlight any code blocks (for safety)
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function addMessage(text, role, isStreaming = false) {
            const div = document.createElement('div');
            div.className = 'message ' + role;
            if (isStreaming) {
                div.classList.add('streaming');
                div.textContent = text;
            } else if (role === 'assistant') {
                div.innerHTML = marked.parse(text);
                div.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                div.textContent = text;
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return div;
        }

        function sendMessage() {
            const text = input.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

            addMessage(text, 'user');
            input.value = '';
            sendBtn.disabled = true;
            input.disabled = true;

            ws.send(JSON.stringify({
                type: 'message',
                content: text
            }));
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        connect();
    </script>
</body>
</html>
